C SPECPLOT.FOR- SUBROUTINE TO PLOT ONE OR MORE CHANNELS FOR SPECTR

	INCLUDE 'FGRAPH.FI'

	SUBROUTINE SPECPLOT(X,NROW,NCOL,N10,N20,I0,I2,IPL,PTITLE,IKP,

     + NXEQ,IYOFF,ISETF,MODE)

C PARAMETERS: X=DATA ARRAY; ITS DIMENSIONS ARE PASSED EXPLICITLY AS

C NROW AND NCOL; N10 & N20 ARE THE INITIAL START/STOP DATA POINTS

C (THESE ARE PRESERVED SO THAT SPECPLOT CAN INDEPENDENTLY CHANGE THE      

C ACTUAL PLOT REGION WHICH IS N1,N2, INITIALLY SET = N10,N20);

C I0 & I2 ARE START/STOP CHANNELS; IPL= DATA TYPE(TIME/SPECTRUM/CHANGE

C SPECTRUM); PTITLE IS PLOT TITLE; IKP=1 SUPERIMPOSES CURRENT PLOT ON

C RETRIEVED IMAGE OF PREVIOUS PLOT; NXEQ= # EXECUTIONS, WHICH IS SET

C TO 1 BY SPECPLOT WHEN THE PLOT LAYOUT IS ACCEPTED BUT CAN BE MODIFIED

C BY THE CALLING ROUTINE TO CHANGE SPECPLOT'S BEHAVIOR; IYOFF IS AN 

C OFFSET FROM THE PLOT'S NOMINAL VERTICAL STARTPOINT, WHICH PERMITS

C CONSTRUCTION OF CSA'S BY THE CALLING ROUTINE; ISETF IS THE SETUP

C FLAG(0 INVOKES SETUP PROCEDURE, 1 BYPASSES IT); AND MODE IS SET

C BY SPECPLOT TO 1 FOR SINGLE MODE OR 2 FOR MULTICHANNEL MODE.

	INCLUDE 'FGRAPH.FD'
      INCLUDE 'MAX.INC'

	RECORD/XYCOORD/XY

	RECORD/RCCOORD/S

	INTEGER*1 IMAGEBUF

	COMMON IFLAG1,IFLAG2,IFLAG3,KNT,ISZ,ICHAN(64),CLABEL(64),MNTFIL

	COMMON/FLDES/ NG,NA,NC,ND,NF,NL,NR,IS,IBUF(1)

	COMMON/FLDESO/NGO,NAO,NCO,NDO,NFO,NPO,NRO,ISO,WORK(1)

	COMMON/STDFIL/INPFIL

	COMMON/DEV/ITI

	COMMON/PTLST/NNN(145),NP1,NP2,NPTOT,PF1,PFT,DT,DF

	COMMON/IMAGE/IMAGEBUF(1)

C	DIMENSION ISTART(64,2),IBUFO(1),X(NROW,NCOL)
	DIMENSION ISTART(ICHMAX,2),IBUFO(1),X(NROW,NCOL)

	CHARACTER*1 IBLANKS(128)

	CHARACTER*15 RTITLE

	CHARACTER*24 CTITLE,CLABEL,MNTFIL,INPFIL,CTEMP,PTITLE,ITIT

	CHARACTER*6 CLAB   

	CHARACTER*5 XLAB

	CHARACTER*128 BLANKS

	CHARACTER*1 IA

	INTEGER*2 JPL,IX0,IY0,IYOFF,IYTOP,IYLAB,IXDIM,IYDIM,ICX,ICY

	INTEGER*2 IX1,IY1,TWO,THREE,ELEVEN,FIFTEEN,IXL,IX2,IY2,JPL1

	EQUIVALENCE (IBUFO,WORK),(IBLANKS,BLANKS)
	INTEGER*2 IXDIMT,IYDIMT

	DATA TWO,THREE,ELEVEN,FIFTEEN/2,3,11,15/

	DATA IBLANKS/128*' '/

	I1=I0   ! SAVE I0 SO IT CAN'T GET CHANGED

C ALWAYS SET VIDEO MODE ON ENTRY

1000    CALL GRAPHMODE_ON(IXDIMT,IYDIMT,NTR,NTC,NBPP,NCLRS,0)

	CALL SETTEXTWINDOW(1,1,3,NTC)

	ISTAT=WRAPON($GWRAPOFF) ! TRUNCATES TEXT LINES AT WINDOW EDGE

	ISTAT=SETFONT("t'tms rmn'h12w6")

	IF(ISTAT.LE.0)PAUSE 'SETFONT ERROR'

	 IF(IKP*NXEQ-1)2,5,5  ! KEY CONTROL STATEMENT FOR REPEATED CALLS

2      IF(ISETF.EQ.0)GO TO 2222

	WRITE(ITI,2221)

2221  FORMAT('$   CHANGE PLOT SETUP? >'\)

C	READ(ITI,'(A1)')IA
	READ(5,'(A1)')IA

	CALL SETTEXTPOSITION(1,3,S)

	CALL OUTTEXT(BLANKS(1:NTC))

	CALL SETTEXTPOSITION(1,3,S)

	IF(IA.NE.'Y')GO TO 5

C 'SETUP' DETERMINES X,Y START POSITIONS FOR PLOTS & STORES THEM IN

C  ISTART(NCHANS x (X,Y)); ALSO GETS MODE AND X,Y PLOT DIMENSIONS

2222  CALL SETUP(IXDIMT,IYDIMT,NTR,CLABEL,NCO,

     + MODE,ISTART,XDIM,YDIM)

	CALL SETTEXTPOSITION(1,3,S)

	CALL OUTTEXT(BLANKS(1:NTC))

	ISETF=1     ! ONLY RESET WITH NEW DATA, ETC

	NXEQ=0      ! FLAG TO PERMIT FIDDLING WITH FIRST PLOT

	ISCL=1      ! ALWAYS SCALE ON FIRST CALL

	IAXIS=1     ! ALWAYS DO AXIS ON FIRST CALL

	IXDIM=XDIM

	IYDIM=YDIM

	CLAB='      '

	IT=1

	JMP=1       ! INITIALLY USE ALL DATA VALUES

	P1=PF1

	PN=PFT

	N1=N10

	N2=N20

	NPT=N2-N1+1

	IF(IPL.NE.1)GO TO 2001

	X1=DT ! ALWAYS, IN THIS VERSION

	DX=DT

	GO TO 2002

2001  X1=0.

	DX=DF

2002  CALL LABSCL7(IPL,NPT,DX,XDIM,IXDIMT,STEP,XINT)

	GO TO 5     ! FOR FIRST PLOT

1       WRITE(ITI,200)

200     FORMAT('$   SPECPLOT:FIRST, LAST POINTS(IN XSCALE UNITS)? >'\)

C	READ(ITI,*)PLOT1,PLOTN
	READ(5,*)PLOT1,PLOTN

	CALL OUTTEXT(BLANKS(1:NTC))

	GO TO(3,4,4)IPL

3       PLOT1=PLOT1+DX

4       N1=(PLOT1-X1)/DX + 1

	N2=(PLOTN-X1)/DX + 1

	NPT=N2-N1+1

	IF(IPL.EQ.1)PLOT1=PLOT1-DX    ! QUICK FIX FOR TIME REGIONS

	N10=N1

	N20=N2

	GO TO 2002

10      WRITE(ITI,106)

106     FORMAT('$   SPECPLOT DATA XFORM:0=NONE/1=SQRT/2=LN/3=ABS >'\)

C	READ(ITI,204)IT
	READ(5,204)IT

204     FORMAT(I1)

	IT=IT+1

	CALL OUTTEXT(BLANKS(1:NTC))

5     IX0=ISTART(I1,1)

	IY0=ISTART(I1,2)

	IYLAB=IY0+INT2(5)

	IYTOP=IY0-IYDIM

	IYOFF=INT2(IYOFF)

	ICX=IX0+IXDIM-50

	ICY=IYTOP+6

	N1=N10

	N2=N20

	NPT=N2-N1+1

	GO TO(7,6)MODE

6     CTEMP=CLABEL(I1)

	CLAB=CTEMP(1:6)

7     XSCALE=XDIM/FLOAT(NPT-1) ! PIXELS/DX, EXACT

	XSCALEDATA=XSCALE*FLOAT(JMP)  ! CORRECTION FOR VARIABLE DECIMATION

	IF(IPL-2) 50,40,50

50      SCALE=YDIM/2.0

	JPL=IY0-SCALE

	GO TO 55

40      JPL=IY0

	SCALE=YDIM

55    IF(ISCL.EQ.0)GO TO 21  

	YMAX=0.

	YMIN=1.E10

	DO 56 I=N1,N2,JMP

	VAL=RECODE(X(I,I1),IT)

	IF (ABS(VAL).GT.YMAX)YMAX=ABS(VAL)

	IF(VAL.LT.YMIN)YMIN=VAL

56      CONTINUE

	YMIN=0.     ! NB: FORCES SPECTRA TO START AT 0 AMPLITUDE

	YMAX0=YMAX

	GO TO 57

C ADJUST DECIMATION

58    ISKP=(N2-N1+1)/INT(XDIM)

	IF(ISKP.EQ.0)GO TO 21   ! ALL POINTS FIT

	WRITE(ITI,103)JMP,ISKP

103   FORMAT('$   LAST PLOT USED EVERY',I3,'TH POINT;',

     + ' ENTER NEW SPACING .LE.',I3)

C	READ(ITI,*)JMP
	READ(5,*)JMP

	CALL SETTEXTPOSITION(1,3,S)

	CALL OUTTEXT(BLANKS(1:NTC))

	CALL SETTEXTPOSITION(1,3,S)

	GO TO 5

C ADJUST VERTICAL SCALE

60      WRITE(ITI,104)YMAX0

104     FORMAT('    CURRENT MAX IS  ',G10.4,    

     1   '; ENTER NEW MAX VALUE (IN REAL FORMAT) >'\)

C	READ(ITI,105) Y2
	READ(5,105) Y2

105     FORMAT(F15.0)

	CALL OUTTEXT(BLANKS(1:NTC))

	IF(Y2.EQ.0)GO TO 21

	YMAX=Y2

57     YSCALE=SCALE/(YMAX-YMIN)

21    IF(IAXIS.EQ.0)GO TO 22

	XLAB='     '

C FIRST DRAW AXES

	CALL MOVETO(IX0,JPL,XY)

	ISTAT=LINETO(IX0+IXDIM,JPL)

	CALL MOVETO(IX0,IY0,XY)

	ISTAT=LINETO(IX0,IYTOP)

	CALL MOVETO(IX0,IY0,XY)

	ISTAT=LINETO(IX0+IXDIM,IY0)

2110    XV1=X1+FLOAT(N1-1)*DX ! VALUE AT FIRST PLOT POINT

	XVN=XV1+FLOAT(NPT-1)*DX ! VALUE AT LAST PLOT POINT

	FTCK=(XVN-XV1)/STEP   ! EXACT # STEPS

	XSCAL2=XDIM/(FTCK)    ! PIXELS/STEP, EXACT

C IF NECESSARY, ADJUST POSITION OF FIRST TICK TO A STEP BOUNDARY

	IOFF=0

	FRACT=STEP-AMOD(XV1,STEP)

	IF(FRACT.EQ.STEP)GO TO 75 ! ALREADY ON A BOUNDARY

	XV1=XV1+FRACT  ! VALUE AT FIRST TICK

	IOFF=IFIX((FRACT/STEP)*XSCAL2+.5)    ! PIXEL OFFSET TO FIRST TICK

C OFFSET CORRECTION IS (STEP FRACTION)*(PIXELS/STEP)

75      IX1=IX0+IOFF

	XI=IX1

	NTCK=INT(FTCK)+1

	XDAT=XV1

	DO 90 I=1,NTCK

	CALL MOVETO(IX1,JPL-TWO,XY)

	ISTAT=LINETO(IX1,JPL+THREE)

C      CALL MOVETO(IX1,IYTOP+TWO,XY)

C      ISTAT=LINETO(IX1,IYTOP-THREE)

	IF(IPL.EQ.2)GO TO 751

	CALL MOVETO(IX1,IY0-TWO,XY)

	ISTAT=LINETO(IX1,IY0+THREE)

751   IF(AMOD(XDAT,XINT))85,80,85

80      CALL MOVETO(IX1,JPL+THREE,XY)

	ISTAT=LINETO(IX1,JPL+ELEVEN)

C      CALL MOVETO(IX1,IYTOP-THREE,XY)

C      ISTAT=LINETO(IX1,IYTOP-ELEVEN)

	IF(IPL.EQ.2)GO TO 752

	CALL MOVETO(IX1,IY0+THREE,XY)

	ISTAT=LINETO(IX1,IY0+ELEVEN)

752   GO TO(8001,8002,8002)IPL

8001  IXD1=IFIX(XDAT*1000.)

	WRITE(XLAB,8011)IXD1

8011  FORMAT(I5)

	GO TO 803

8002  IF(XDAT.EQ.0.)GO TO 85  

	IXDAT=XDAT

	WRITE(XLAB,8011)IXDAT    

803   IXL=IX1-25  !START POSITION FOR LABEL

	CALL MOVETO(IXL,IYLAB,XY)

	CALL OUTGTEXT(XLAB)

85      XI=XI+XSCAL2

	IX1=XI+.5

	XDAT=XDAT+STEP

90      CONTINUE

C DRAW NEXT PLOT

22    CONTINUE

      IF(IKP.EQ.1)CALL PUTIMAGE(0,0,IMAGEBUF,$GOR)

      IX1=IX0

	JPL1=JPL-IYOFF

	Y=(RECODE(X(N1,I1),IT)-YMIN)*YSCALE

	IF(ABS(Y).GT.SCALE) Y=SIGN(SCALE,Y)

	IY1=MAX0((JPL1-IFIX(Y)),IYTOP)

	XI=IX1

	CALL MOVETO(IX1,IY1,XY)

	DO 70 I=N1+1,N2,JMP

	XI=XI+XSCALEDATA

	IX2=XI+.5

	Y=(RECODE(X(I,I1),IT)-YMIN)*YSCALE

	IF(ABS(Y).GT.SCALE) Y=SIGN(SCALE,Y)

	IY2=MAX0((JPL1-IFIX(Y)),IYTOP)     ! LIMIT PLOT HEIGHT,

	ISTAT=LINETO(IX2,IY2)             ! WITH OFFSET POSSIBLE

	IX1=IX2

	IY1=IY2

70      CONTINUE

C LABEL PLOT FIRST WITH ABBREVIATED CHANNEL LABEL (BLANK FOR MODE=1)

	CALL MOVETO(ICX,ICY,XY)

	CALL OUTGTEXT(CLAB)

	IF(NXEQ.GT.1.AND.MODE.NE.1)GO TO 3000   ! DON'T RELABEL CHANS 2,3,...

C LABEL PLOT WITH FILENAME, RECSET NUMBER, ETC

C LOCATE RELATIVE TO NUMBER OF AVAILABLE TEXT COLUMNS

	MID=.4*NTC

	IRT=.75*NTC

	CALL SETTEXTPOSITION(2,3,S)

	CALL OUTTEXT('FILE:'//INPFIL)

	CALL SETTEXTPOSITION(2,MID,S)

	WRITE(RTITLE,700)KNT     

	CALL OUTTEXT(RTITLE)

700     FORMAT('RECORD-SET',I4)

	CALL SETTEXTPOSITION(2,IRT,S)

	IF(MODE.EQ.1)CTEMP=CLABEL(I1)

	IF(MODE.EQ.2)CTEMP='(ALL)'

	WRITE(CTITLE,701)CTEMP(1:15)  

	CALL OUTTEXT(CTITLE)

	CALL SETTEXTPOSITION(3,3,S)

701     FORMAT('CHANNEL: ',A15)

	WRITE(RTITLE,800)P1    

800     FORMAT('STARTPT:',F6.3)

	CALL OUTTEXT(RTITLE)

	CALL SETTEXTPOSITION(3,MID,S)

	WRITE(RTITLE,801)PN    

801     FORMAT('LENGTH: ',F6.3)

	CALL OUTTEXT(RTITLE)        

	CALL SETTEXTPOSITION(3,IRT,S)

	CALL OUTTEXT(PTITLE)

	CALL SETTEXTPOSITION(1,3,S)

	CALL OUTTEXT(BLANKS(1:NTC))

3000    CONTINUE

C KEY CONTROL SECTION HERE!

	IF(NXEQ)5000,5000,4000

4000  I1=I1+1

      NXEQ=NXEQ+1

C PLOT IS FINISHED, STORE IT FOR POSSIBLE LATER RECALL

      CALL GETIMAGE(0,0,IXDIMT-1,IYDIMT-1,IMAGEBUF)

      IF(MODE.EQ.2)GO TO 4002

C      READ(ITI,107)ICR
      READ(5,107)ICR

      IF(ICR.NE.1)GO TO 4001

      ASSIGN 4001 TO LOC

      GO TO 4005

4001  IF(I1.GT.I2)GO TO 95

      CALL CLEARSCREEN(0)

      GO TO 5

C ANY MORE PLOTS FOR THIS CALL?

4002	IF(I1.LE.I2)GO TO 5

C WAIT FOR <CR> FOR MODE 2

C	READ(ITI,107)ICR
	READ(5,107)ICR

	IF(ICR.NE.1)GO TO 95

	ASSIGN 95 TO LOC

C FOLLOWING CODE SAVES FINISHED PLOTS AS .BMP FILES FOR OFFLINE PRINTING

4005  CALL SETTEXTPOSITION(1,3,S)

      WRITE(ITI,8000)

8000  FORMAT('$  ENTER FILENAME FOR THIS IMAGE >'\)

C      READ(ITI,'(A)')ITIT
      READ(5,'(A)')ITIT

      CALL SETTEXTPOSITION(1,3,S)

      CALL OUTTEXT(BLANKS(1:NTC))

      ISTAT=SAVEIMAGE('C:\EEGDATA\'//ITIT//'.BMP',0,0,IXDIMT-1,IYDIMT-1)

      GO TO LOC

C AND RETURNS TO APPROPRIATE LOCATION      

95    CALL GRAPHMODE_OFF

	RETURN

C FIRST PLOT DONE; WAIT FOR <CR>, THEN SEE WHAT TO DO NEXT

C5000  READ(ITI,107)ICR 
5000  READ(5,107)ICR 

107   FORMAT(BZ,I1)

	CALL SETTEXTPOSITION(1,3,S)

	WRITE(ITI,108)

108     FORMAT('$   SPECPLOT:<CR>=CONTINUE/1=REGION/2=XFORM/3=SCALE',

     + '/4=SAMPLING >'\)

C	READ(ITI,107) IGO
	READ(5,107) IGO

	CALL SETTEXTPOSITION(1,3,S)

      IF(IGO.EQ.0)GO TO 6000

C FOR ALL OTHER CASES ASSUME PLOT WILL BE ALTERED

	CALL CLEARSCREEN(0)

	CALL SETTEXTPOSITION(1,3,S)

	GO TO (1,10,60,58) IGO

6000  NXEQ=1

	N10=N1      ! ALLOWS REGION TO BE CARRIED THRU MULTIPLE CALLS

	N20=N2      !  TO SPECPLOT FROM MODPSP, E.G.

	ISCL=0      ! SCALING FIXED AFTER LAYOUT ACCEPTED

	CALL OUTTEXT(BLANKS(1:NTC))

	CALL SETTEXTPOSITION(1,3,S)

	GO TO 4000

	END



