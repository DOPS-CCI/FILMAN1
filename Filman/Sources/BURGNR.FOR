C BURGNR.FOR- ROUTINE TO COMPUTE ORIGINAL BURG SPECTRUM FOR SPECTR. TAKEN

C FROM "NUMERICAL RECIPES" PP.433-434. THIS VERSION COMPUTES & PLOTS THE 

C SPECTRA FOR ALL MODEL ORDERS BETWEEN M1 AND M2. SUBSEQUENT VERSIONS

C SHOULD ADD FPE/AIC ETC FOR ALL ORDERS. IF VIRTUAL ARRAYS ARE AVAILABLE,

C PLOTS CAN BE GENERATED WTITHOUT CLOBBERING 'WORK', SO THAT LOWER-ORDER

C MODELS AREN'T REPEATEDLY REGENERATED. USES DIRECT METHOD TO CALCULATE

C THE SPECTRUM, WHICH PERMITS HIGHER RESOLUTION BUT IS SLOW, SLOW!!!

	SUBROUTINE BURGNR(DATA,N,IC)

	COMMON IFLAG1

	COMMON/FLDES/ID(8),IBUF(1)

	COMMON/FLDESO/IDO(8),WORK          ! Maciek WORK(1) -> WORK

	COMMON/DEV/ITI,ILP

	COMMON/PTLST/NLIST,LIST(2,72),NP1,NP2,NPTOT,P1,PT,DT,DF

	DIMENSION WK1(4100),WK2(4100),WKM(99),COF(99)

	DIMENSION DATA(N,IC),SPECTRA[ALLOCATABLE](:,:)

	CHARACTER*24 PTITLE
	
	dimension work(4101)                ! Maciek

	EQUIVALENCE (WK1(1),WORK(1)),(WK2(1),WORK(4101))

1000    CALL PTSEL

	NN=NPTOT

1       WRITE(ITI,100)

100     FORMAT('$  BURGNR: FIRST, LAST ORDER(<100) & STEPSIZE? >'\)

	READ(ITI,*)M1,M2,M3

	IF(M3.EQ.0)M3=1

	WRITE(PTITLE,800)M1,M2,M3

800     FORMAT('BURG(DIRECT):',3I3)

C PLOT PARAMETERS

	FNYQ=FLOAT(ID(8))/2.

	DT=1.0/FLOAT(ID(8))

2       WRITE(ITI,300)FNYQ

300     FORMAT('$  FREQUENCY CUTOFF(.LE.',F5.1,') >'\)

	READ(ITI,301)FMAX

301     FORMAT(F8.0)

	IF(FMAX.EQ.0.)FMAX=FNYQ

	DFMIN=FMAX/8192.   ! (DETERMINED BY LENGTH OF WORK, REALLY)

C NOTE THAT THE KEY ADVANTAGE OF THIS ROUTINE IS ITS CAPACITY FOR

C EXTREMELY HIGH RESOLUTION IF NARROW PEAKS ARE PRESENT; SEE 'RECIPES'

	WRITE(ITI,200)DFMIN

200     FORMAT('$  FREQUENCY SPACING(.GE.',F5.3,') >'\)

	READ(ITI,301)DF

	IF(DF.EQ.0.)DF=DFMIN

	NPT0=FMAX/DF+1

	NPT=NPT0

	IKP=0

	NXEQ=0

	X1=0.

	WRITE(ITI,201)

201     FORMAT('$  RECALL PREVIOUS PLOT? >'\)

	READ(ITI,401)IA

	IF(IA.EQ.'Y')IKP=1

	ISETF=0

	ALLOCATE(SPECTRA(NPT0,IC),STAT=IERR)

	N1=1

	N2=NPT0

	DO 95 L=1,IC

	DO 90 M=M1,M2,M3

	CALL TIMER(T1)

	P=0.

	DO 11 J=NP1,NP2

	P=P+DATA(J,L)**2

11      CONTINUE

	PM=P/NN

	WK1(1)=DATA(NP1,L)

	WK2(NN-1)=DATA(NP2,L)

	K=NP1+1

	DO 12 J=2,NN-1

	X=DATA(K,L)

	WK1(J)=X

	WK2(J-1)=X

12      K=K+1

	CALL MEMCOF(NN,M,PM,COF,WKM)

	CALL TIMER(T2)

	T2=(T2-T1)*1000.

C      WRITE(ITI,102)M,T2

102     FORMAT(/'   TIME FOR BURGNR, ORDER ',I2,', IS',F8.2,' MS.')

	AN=NN

	AM=M+1

	FPE=PM*(AN+AM)/(AN-AM)

	IF(PM.LT.1.0)PM=1.0

	AIC=AN*ALOG(PM)+2.0*(AM-1.0)

C FPE AND AIC ARE AKAIKE'S ORDER-SELECTION CRITERIA

C      WRITE(ITI,103)PM,FPE,AIC

103     FORMAT('    PM=',F10.2,'; FPE=',F8.2,'; AIC=',F8.2)

C      WRITE(ITI,104)(COF(I),I=1,M)

104     FORMAT('     ',10F7.3)

	CALL TIMER(T1)

	F=0.

	DO 30 I=1,NPT0

	FDT=F*DT

	SPECTRA(I,L)=EVLMEM(FDT,COF,M,PM)

30      F=F+DF

	CALL TIMER(T2)

	T2=(T2-T1)*1000.

C      WRITE(ITI,400)T2

400     FORMAT('$  TIME TO SPECTRUM IS',F8.2,' MS; <CR> TO PROCEED'\)

C      READ(ITI,401)

401     FORMAT(A1)

	CALL SPECPLOT(SPECTRA,NPT0,IC,N1,N2,L,L,2,PTITLE,IKP,

     + NXEQ,0,ISETF,MODE)

	IF(NXEQ-1)80,80,85

80      WRITE(ITI,203)

203     FORMAT('$  BURGNR:<CR>=CONTINUE/1=FREQS/2=MODEL/3=POINTS >'\)

	READ(ITI,204)IGO

204     FORMAT(I1)

	GO TO (85,2,1,1000) IGO+1

85    IKP=1

	NXEQ=NXEQ+1

90    CONTINUE    ! ORDER LOOP

	IF(MODE.EQ.1)IKP=0

95    CONTINUE    ! CHANNEL LOOP

99    DEALLOCATE(SPECTRA)      

	RETURN

	END

C-----------------------------------------

C ROUTINE TO GET THE AR COEFFICIENTS

	SUBROUTINE MEMCOF(N,M,PM,COF,WKM)

	COMMON IFLAG1

	COMMON/FLDESO/IDO(8),WK1(4100),WK2(4100)

	DIMENSION WKM(M),COF(M)

	DO 17 K=1,M

	PNEUM=0.

	DENOM=0.

	DO 13 J=1,N-K

	PNEUM=PNEUM+WK1(J)*WK2(J)

	DENOM=DENOM+WK1(J)**2+WK2(J)**2

13      CONTINUE

	COF(K)=2.*PNEUM/DENOM

	PM=PM*(1.-COF(K)**2)

	IF(K-1)131,132,131

131     DO 14 I=1,K-1

	COF(I)=WKM(I)-COF(K)*WKM(K-I)

14      CONTINUE

132     IF(K.EQ.M)RETURN

	DO 15 I=1,K

	WKM(I)=COF(I)

15      CONTINUE

	DO 16 J=1,N-K-1

	WK1(J)=WK1(J)-WKM(K)*WK2(J)

	WK2(J)=WK2(J+1)-WKM(K)*WK1(J+1)

16      CONTINUE

17      CONTINUE

	END

C -------------------------------------------

C ROUTINE TO EVALUATE THE SPECTRUM AMPLITUDE AT FREQUENCY FDT

	FUNCTION EVLMEM(FDT,COF,M,PM)

	DIMENSION COF(M)

	REAL*8 WR,WI,WPR,WPI,WTEMP,THETA

	THETA=6.28318530717959D0*FDT

	WPR=DCOS(THETA)

	WPI=DSIN(THETA)

	WR=1.D0

	WI=0.D0

	SUMR=1.

	SUMI=0.

	DO 11 I=1,M

	WTEMP=WR

	WR=WR*WPR-WI*WPI

	WI=WI*WPR+WTEMP*WPI

	SUMR=SUMR-COF(I)*SNGL(WR)

	SUMI=SUMI-COF(I)*SNGL(WI)

11      CONTINUE

	EVLMEM=PM/(SUMR**2+SUMI**2)

	RETURN

	END





