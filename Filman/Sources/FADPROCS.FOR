C FADPROCS.FOR- POSTPROCESSOR TO DISPLAY FAD PARAMETERS READ FROM FILE
	SUBROUTINE FAD_PROCESS(WPPSF)
	USE IFQWIN
	IMPLICIT DOUBLE PRECISION (A-H,O-Z)
	INCLUDE 'MULTAR.INC'
	INCLUDE 'MAX.INC'
C      PARAMETER (MAXAR=20,MCHANS=64,MNPTS=33,MKN=6,IFADNR=4)
C MAXAR  - MAXIMAL AR MODEL ORDER
C MCHANS - MAXIMAL NUMBER OF CHANNELS (SOME SUBROUTINES
C          REQUIRE WORKARRAY)
C MNPTS  - NUMBER OF CALCULATION POINTS IN FREQUENCY DOMAIN (POWER SP)
C MKN    - NUMBER OF FUNCTIONS CALCULATED IN AR_SPECT
C IFADNR - NUMBER OF FAD PARAMETERS (B,BETA,OMEGA,FI)
C      PARAMETER (INTBMX=10)
C INTBMX - MAXIMAL NUMBER OF BORDERS OF DTF INTEGRATION RANGES
	REAL RECODE,XV,XI,X,VALMX
	DIMENSION WYN(0:MAXAR/2+1,IFADNR+1,MCHANS)
	REAL WYN,XDIM,YDIM
	LOGICAL BEGIN
	CHARACTER*1 INPFIL(64)
C	CHARACTER*24 CLABEL(MCHANS)
C	DIMENSION ICLABS(6,MCHANS)
C	DIMENSION ISTART(MCHANS,2)
	CHARACTER*24 CLABEL(ICHMAX)
	DIMENSION ICLABS(6,ICHMAX)
	DIMENSION ISTART(ICHMAX,2)
	COMMON IFLAG1,IFLAG2,IFLAG3,KNT,ISZ,ICHAN(1)
	COMMON/DEV/ITI,ILP,IGRAPH
	COMMON/STDFIL/INPFIL
	COMMON/FLDES/ NG,NA,NC,ND,NF,NL,NR,IS,IBUF(1)
	COMMON/FLDESO/ NGO,NAO,NCO,NDO,NFO,NLO,NRO,ISO,IBUFO(1)
	COMMON /ARERR/ IERR
	EQUIVALENCE (ICLABS,CLABEL)
	EQUIVALENCE (X,IX)      ! AVOID CONVERTING REAL/INTEGER
	SAVE XDIM,YDIM,CLABEL,ISTART,BEGIN,IFAD,MODE,VALMX
	SAVE NPTS,KN,WYN,IC,MAXX,MAXY,ISTOP
	INTEGER*2 MAXX,MAXY
	LOGICAL ToPlot(5)
	DATA ToPlot /5*.TRUE./
	LOGICAL WPPSF ! Write post-processing SYSTAT file
      REAL FMXVLS(5),VL
      COMMON /FMXVLS/ FMXVLS
C INITIALIZATION SECTION WITH USER DIALOGUE      
	IF(IFLAG1) 1,30,80
1     CLABEL=' '
      DO 15 I=1,NCO
	K=6*(NG+ICHAN(I))-5
! 	DO 15 J=1,6
	DO 15 J=1,3  ! Shorter labels
	ICLABS(J,I)=IBUF(K)
15    K=K+1 
	IFLAG3=0
	IC=1        ! CHANNEL COUNTER
	NPTS=MNPTS  ! FROM MULTAR.INC
	KN=MKN      !  "      "   
	FMXVLS=0.
      CALL DoFADRESULTPLOTDialog(MODE,IFAD,VALMX)
!	MODE=IASKUSR(1,2,'PLOTTYPE (1-SINGLE-TRIAL/2-CUMULATIVE) >',ITI)
!C     WRITE(ITI,100)
!C100   FORMAT('$PLOTTYPE (1-SINGLE-TRIAL/2-CUMULATIVE) >'\)
!C      READ(5,*)MODE
	IF(MODE.EQ.2)THEN
!	  IFAD=IASKUSR(1,4,'PARAMETER TO PLOT (1-B/2-á/3-í/4-B^2/á) >'
!     $  ,ITI) 
!C       WRITE(ITI,101)
!C101    FORMAT('$PARAMETER TO PLOT (1-B/2-á/3-í/4-B*exp(-á)) >'\)
!C       READ(5,*)IFAD
!	 IF(IFAD.EQ.4)IFAD=5
!	 IF(IFAD.NE.3)THEN
!	  WRITE(ITI,102)
!102     FORMAT('$ENTER MAXIMUM ANTICIPATED VALUE >'\)
!C	  READ(ITI,*)VALMX
!        READ(5,*)VALMX
	  VALMX=ABS(VALMX)  ! FOR SECURITY
!	 ENDIF 
	ELSE
	 IFAD=0     ! FADGRAPHICS MODE 1
	 VALMX=0.
	ENDIF 
c	CALL GRAPHMODE_ON(MAXX,MAXY,.false.)    ! SETS SCREEN DIMENSIONS
	CALL GRAPHMODE_ON(MAXX,MAXY,nrow,ncol,nbits,ncolors,0) ! SETS SCREEN DIMENSIONS  ! Maciek
	IF(IERR.NE.0)STOP
	CALL SETUP(MAXX,MAXY,10,CLABEL,NCO,2,ISTART,XDIM,YDIM) !SEE 'PLOT'
	IERR=0
	BEGIN=.TRUE.
	ISTOP=0
25    RETURN
C EXECUTION PHASE- FIRST ASSEMBLE THE DATA MATRIX FOR THIS TRIAL
30    IF(NDO.GT.4*(MAXAR/2+1+1))THEN
	 WRITE(ITI,*)'FADPLOT ERROR: TOO SMALL WORK ARRAY'
	 CALL ShowInfoText('Error','FADPLOT ERROR: TOO SMALL WORK ARRAY')
C      FOR SITUATION WHEN MAXIMAL AR MODEL IN DATAFILE IS BIGGER
C      THAN IN THIS PROGRAM
	 STOP
	ENDIF        
	DO 35 I=1,NDO
	CALL XVAL(I,XV,XI)
	I2=MOD(I,4)
	IF(I2.EQ.0)I2=4
C     WRITE(ITI,*)XV
35    WYN((I-1)/4,I2,IC)=RECODE(XV,IT)
	IC=IC+1
	IF(IC.LE.NCO) RETURN
40    IC=1
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C                                                     C
C DATA STORED IN MATRIX FORM; NOW DO THE CALCULATIONS C
C                                                     C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
				  
      LEN=NDO/4  !  ???				  
	IF(MODE.EQ.1.OR.IFAD.EQ.5)CALL CALCBBETA(WYN,NCO)
	IF(MODE.EQ.2.AND.BEGIN)
     $ CALL FAD_GRAPHICS(0,WYN,LEN,NCO,CLABEL,IFAD,ISTART,INT(XDIM),
     $                   INT(YDIM),MAXX,MAXY,VALMX,ToPlot,ISTOP)
	BEGIN=.FALSE.
	IF(WPPSF)THEN  ! Write output SYSTAT file?
	  CALL ADVANCEDFADSAVE(WYN,LEN,MAXAR/2+1,IFADNR+1,MCHANS,NCO,NGO)
      ENDIF
	IF(ISTOP.EQ.1)RETURN
	CALL FAD_GRAPHICS(MODE,WYN,LEN,NCO,CLABEL,IFAD,ISTART,INT(XDIM),
     $                  INT(YDIM),MAXX,MAXY,VALMX,ToPlot,ISTOP)

	RETURN


C TERMINATION PHASE
80    IERR=0
C	IF(MODE.EQ.2)READ(ITI,'(A)')J
!      IF(MODE.EQ.2)READ(5,'(A)')J
!      CALL ShowInfoText('Info','Press OK when done')
      CALL SETVIEWPORT(0,0,MAXX,MAXY)
      VL=0.
      IF(IFAD.NE.0)VL=FMXVLS(IFAD)
69    CALL PauseFADdialog(IDEC,VL)
      IF(IDEC.EQ.4)THEN
!        Call ShowInfoText('Info',
!     +      'Press OK to hide this window. Press ENTER when done')
        read(IGRAPH,'(A)')KEY
        GOTO 69
      ENDIF
	CALL GRAPHMODE_OFF
	RETURN
	END
C ******************************                       
