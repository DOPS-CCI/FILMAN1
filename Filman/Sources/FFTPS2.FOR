C FFTPS2.FOR- FFT-BASED SPLIT-RECORD POWER SPECTRUM FOR SPECTR.

C WE MAY WANT TO ADD OPTIONS FOR PLOTTING CHANGE IN dB ETC

	SUBROUTINE FFTPS2(X,N,IC)

	COMMON IFLAG1,IFLAG2,IFLAG3,KNT,ISZ,ICHAN(64),ICLABS(6,64)

	COMMON/DEV/ITI,ILP

	COMMON/FLDESO/ NGO,NAO,NCO,NDO,NFO,NLO,NRO,ISO,WORK(1)

	COMMON/FLDES/ NG,NA,NC,ND,NF,NL,NR,IS,IBUF(1)

	COMMON/PTLST/NLIST,LIST(2,72),NP1,NP2,NPTOT,P1,PT,DT,DF

	DIMENSION X(N,IC), SPECTRA1 [ALLOCATABLE](:,:)

	DIMENSION SPECTRA2 [ALLOCATABLE](:,:)

	CHARACTER*24 PTITLE

1       CALL PTSEL

	IF(NPTOT.LE.4096)GO TO 2

	WRITE(ITI,500)

500   FORMAT('  SEGMENTS MUST BE .LE. 4096 POINTS EACH')  

	GO TO 1

2     NP3=NPTOT/2

	NP=2

	FNYQ=FLOAT(IS)/2.0

42      I=NP+NP

	IF(I-NP3) 43,43,44

43      NP=I

	GO TO 42

44      NXFM=NP         ! # TO TRANSFORM

	WRITE(ITI,99)

99      FORMAT('$  FFTPS2: ZERO-PAD THE TRANSFORMS? >'\)

	READ(ITI,201)IA

	IF(IA.EQ.'Y')NXFM=4096

	DF=FLOAT(IS)/FLOAT(NXFM)

10      WRITE(ITI,100)

100     FORMAT('$  FFTPSP TAPERING:0=NONE/1=HANN >'\)

	READ(ITI,101)IT

101     FORMAT(I1)

46      WRITE(ITI,102)FNYQ

102     FORMAT('$  FREQUENCY CUTOFF(.LE.',F5.1,') >'\)

	READ(ITI,104)FMAX

104     FORMAT(F6.0)

	IF(FMAX.EQ.0.)FMAX=FNYQ

	NP4=FMAX/DF + 1   ! # TO PLOT

	IPL=2

	ISEG=1

	NP1A=NP1

	N1=1

	N2=NP4

	ALLOCATE(SPECTRA1(NP4,IC),STAT=IERR)

	ALLOCATE(SPECTRA2(NP4,IC),STAT=IERR)

20    DO 60 LC=1,IC

C COPY SOURCE DATA FOR CURRENT SEGMENT AND CHANNEL

	K=1

	DO 5 L=NP1A,NP1A+NP3-1

	WORK(K)=X(L,LC)

5       K=K+1

C ZERO PAD IF REQUESTED

	IF(NXFM.EQ.NP3)GO TO 57

	DO 15 K=NP3+1,NXFM

15      WORK(K)=0.

C CALCULATE THE SPECTRUM

57      CALL FAST(WORK,NXFM)

	J=1

	DO 25 I=1,NP4

	WORK(I)=WORK(J)**2 + WORK(J+1)**2

25      J=J+2

C SMOOTH IF REQUESTED

	GO TO (58,570)IT+1

570   TMP=WORK(1)

	DO 571 I=2,NP4-2

	TMP1=WORK(I)

	WORK(I)=.5*WORK(I)+.25*(TMP+WORK(I+1))

571   TMP=TMP1

C COPY FINAL SPECTRUM FOR THIS CHANNEL INTO SPECTRA2

58    DO 40 I=1,NP4

	SPECTRA2(I,LC)=WORK(I)

40    CONTINUE

60    CONTINUE

C ALL SPECTRA FOR THIS SEGMENT CALCULATED; PLOT THE RESULTS

	WRITE(PTITLE,902)ISEG 

902     FORMAT('FFTPS2: SEGMENT',I2)

	  WRITE(ITI,299)ISEG

299     FORMAT('$  PART',I2,' READY; RECALL PREVIOUS PLOT? >'\)

	READ(ITI,201)IA

201     FORMAT(A1)

	IKP=0

	IF(IA.EQ.'Y')IKP=1

64    CALL SPECPLOT(SPECTRA2,NP4,IC,N1,N2,1,IC,IPL,PTITLE,IKP,

     + NXEQ,0,0,MODE)   ! ISETF ALWAYS 0 TO FORCE RESCALE ETC

	GO TO(30,50,65)ISEG

30      ISEG=2

	NP1A=NP1A+NP3

C COPY FIRST SEGMENT'S SPECTRA INTO SPECTRA1

	DO 35 LC=1,IC

	DO 35 I=1,NP4

	SPECTRA1(I,LC)=SPECTRA2(I,LC)

35    CONTINUE

	GO TO 20

C OBTAIN AND PLOT DIFFERENCE SPECTRA

50    DO 55 LC=1,IC  

	DO 55 I=1,NP4

	SPECTRA2(I,LC)=SPECTRA2(I,LC)-SPECTRA1(I,LC)

55    CONTINUE

	WRITE(PTITLE,903) 

903     FORMAT('DIFFERENCE SPECTRA')

	ISEG=3

	IPL=3

	IKP=0

	GO TO 64

65      WRITE(ITI,300)

300     FORMAT('$  FFTPS2:<CR>=RETURN/1=FREQS/2=TAPER/3=PAD/4=POINTS>'\)

	READ(ITI,101)IGO

	GO TO(70,70,10,70,1)IGO+1

70    DEALLOCATE(SPECTRA1)  

	DEALLOCATE(SPECTRA2)

	IF(IGO.EQ.3)GO TO 44

	IF(IGO.EQ.1)GO TO 46

	RETURN

	END



