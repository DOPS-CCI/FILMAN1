C ECGREAD.FOR- READS ASCII FILE GENERATED BY BILL MAIXNER'S SYSTEM AND      

C CONVERTS RAW ECG TO CENTERED HEARTRATE SIGNAL SAMPLED AT EQUIDISTANT 

C TIME POINTS USING THE ALGORITM OF BERGER/AKSELROD ET AL, IEEE BME,

C BME-33, 1986, 900-904. OUTPUT CURRENTLY A 1-CHANNEL FILMAN FILE 

C CONTAINING THE HEART-RATE SIGNAL. PARAMETERS ARE THE # OF CHANNELS 

C SAMPLED BY BILL, # OF THE ECG CHANNEL, THE ORIGINAL ECG SAMPLE

C RATE, DESIRED OUTPUT SAMPLE RATE(PROBABLY 2 OR 4 HZ), LENGTH IN

C SECONDS OF ECG SAMPLE FOR EACH OUTPUT RECORD, AND A VOLTAGE THRESHOLD

C ABOVE WHICH WE LOOK FOR THE R-WAVE. RECORDS ARE CONSTRUCTED CONTIN-

C UOUSLY BEGIINING AT THE FIRST DETECTED R-WAVE UNTIL THE INPUT GIVES

C OUT. POSSIBLE EXTENSIONS INCLUDE PATCH FOR MISSING BEATS, KEEPING

C MEAN HEART RATE IN THE OUTPUT RECORD, AND ANALYZING OTHER CHANNELS

C IN PARALLEL; BUT LET'S GET THIS WORKING FIRST.

	CHARACTER*1 INPFIL(64),OUTFIL(64)

	CHARACTER*64 INFIL

	DIMENSION ID(8),LAB1(6),HR(1024)

	COMMON/FLDESO[NEAR]/NG,NA,NC,ND,NF,NL,NRO,IS,IBUF(2052)

	COMMON/STDFIL[NEAR]/INPFIL,OUTFIL

	COMMON/DATA/NCHAN,NECG,THRESH,FRAME(16)

	EQUIVALENCE (INPFIL,INFIL)

	EQUIVALENCE (ID(1),NG),(HR(1),IBUF(5))

	DATA LAB1/'CH','AN',' N','UM','BE','R '/

	DATA IYES/'Y'/

	ITI=5

	NG=1

	NA=0

	NC=1

	NF=3

2       WRITE(ITI,101)

101     FORMAT('$# CHANNELS IN INPUT FILE, # OF THE ECG CHANNEL? >'\)

	READ(ITI,*)NCHAN,NECG

	WRITE(ITI,103)

103   FORMAT('$ORIGINAL SAMPLING RATE FOR RAW ECG? >'\)

	READ(ITI,*)SR0

	WRITE(ITI,104)

104     FORMAT('$OUTPUT SAMPLING RATE FOR HEARTRATE SIGNAL? >'\)

	READ(ITI,*)SR1

	IS=SR1

	WIN=SR0/SR1 !WINDOW LENGTH

	WIN2=WIN/2. !SHIFT LENGTH FOR NEXT HR SAMPLE

	SRR=SR1/2.  !CONSTANT SCALE FACTOR IN COMPUTING HR'S

6       WRITE(ITI,1041)

1041    FORMAT('$# SECONDS OF RAW ECG PER OUTPUT RECORD? >'\)

	READ(ITI,301)ISAMP

	ND=IS*ISAMP ! # OUTPUT DATA POINTS PER RECORD

7       WRITE(ITI,105)

105     FORMAT('$VOLTAGE THRESHOLD FOR STARTING R-WAVE DETECTOR? >'\)

	READ(ITI,*)THRESH

	NID=NG+NA

	ND1=NID+1

	NL=NA+NG+ND+ND

	WRITE(ITI,109)

109     FORMAT(' INSERT OUTPUT ID TEXT(3 LINES)')

	READ(ITI,111)(IBUF(I),I=1,108)

111     FORMAT(36A2)

	CALL PUTOPN

	CALL PUTSTD(ID)

	DO 4 I=1,6

4       IBUF(I)=LAB1(I)

	J=7

	L=12

	IF(NG-1)50,50,60

60      DO 40 I=2,NG

	WRITE(ITI,112)I

112     FORMAT(' (',12X,')=GROUP ID ',I2)

	READ(ITI,113)(IBUF(K),K=J,L)

113     FORMAT(6A2)

	J=J+6

40      L=L+6

50      DO 70 I=1,NC

	WRITE(ITI,114)I

114     FORMAT(' (',12X,')=CHANNEL ID',I2)

	READ(ITI,113)(IBUF(K),K=J,L)

	J=J+6

70      L=L+6

	CALL PUTSTD(IBUF)

	NRO=0

C HEADERS FINISHED; NOW READ DATA RECORDS FROM EXTERNAL FILE

71      WRITE(ITI,115)

115     FORMAT('$NAME OF EXTERNAL INPUT FILE? >'\)

	READ(ITI,120)INFIL

120     FORMAT(A)

	OPEN(UNIT=21,FILE=INFIL,STATUS='OLD',ERR=77)

	GO TO 75

77    WRITE(*,*)'CAN"T OPEN THIS FILE'

	GO TO 71

C HERE BEGINS THE ECG-->HR ALGORITHM

C FIND FIRST AND SECOND R-WAVES TO START THE PROCESS

75    CALL FINDR(FI)

	CALL FINDR(FI)    ! FI=TOTAL # RAW SAMPLES IN CURRENT RR WINDOW

	FI0=FI            ! FI0= # SAMPLES STILL TO BE USED

	IFLAG=0           ! REGULATES USE OF FINDR BELOW

9     N=0               ! COUNTER FOR # HR SAMPLES CONSTUCTED

C MAKE NEXT HR SAMPLE

10    N=N+1

C CASE 1: WINDOW LIES WITHIN CURRENT RR INTERVAL

	IF(WIN.GT.FI0) GO TO 20

	RR=WIN/FI

15    FI0=FI0-WIN2      ! MUST BE POSITIVE HERE

	GO TO 30

C CASE 2: WINDOW SPANS 2 RR INTERVALS

20    RR=FI0/FI         ! LEFT/FIRST PART OF RR

	TOGO=WIN-FI0

	IF(IFLAG.EQ.1)GO TO 21  ! ALREADY GOT NEXT R-WAVE

	CALL FINDR(FI1)   ! O'E GET IT NOW

	IF(FI1.LE.0.)GO TO 90   ! EOF OR ERROR, EXIT

	IFLG=1

21    RR=RR+TOGO/FI1    ! ADD RIGHT/SECOND PART OF RR

C MOVE THE WINDOW POINTER BY REDUCING # RAW POINTS LEFT IN CURRENT

C WINDOW; THERE ARE AGAIN TWO CASES SINCE NEXT WINDOW MAY OR MAY NOT

C BEGIN IN THE NEXT RR INTERVAL

	IF(WIN2-FI0)15,15,25

25    FI=FI1

	IFLAG=0

	FI0=FI1-(WIN2-FI0)

30    HR(N)=RR*SRR      ! FINAL COMMON CALCULATION

	IF(N.LT.ND)GO TO 10     ! NEED ANOTHER POINT

C CENTER AND WRITE THIS RECORD

	HRMEAN=0.

	DO 31 I=1,ND

31    HRMEAN=HRMEAN + HR(I)

	HRMEAN=HRMEAN/FLOAT(ND)

	DO 32 I=1,ND

32    HR(I)=HR(I)-HRMEAN

	CALL PUTSTD(IBUF(4))    ! MAY CHANGE LATER

C START NEXT RECORD FROM WHERE WE LEFT OFF

	GO TO 9

C EXIT ON DISCOVERY OF EOF/ERROR IN INPUT

90      CLOSE(UNIT=21)

	WRITE(ITI,200)

200     FORMAT('$ANY MORE INPUT FOR THIS OUTPUT FILE? >'\)

	READ(ITI,301)IANS

	IF(IANS-IYES)95,71,95

95      CALL PUTEND

	WRITE(ITI,300)

300     FORMAT('$ANY MORE ECGREADS? >'\)

	READ(ITI,301)IANS

301     FORMAT(A1)

	IF(IANS-IYES)501,2,501

501     STOP   !CALL EXIT

	END

C

C FIND THE NEXT R-WAVE AND RETURN ITS DISTANCE IN # OF RAW SAMPLES

	SUBROUTINE FINDR(FI)

	COMMON/DATA/NCHAN,NECG,THRESH,FRAME(16)

	FI=1.       ! WE ALREADY GOT FIRST POINT AFTER PREVIOUS R-WAVE

	IFLAG=0

1     OLDECG=ECG

	READ(21,*,ERR=3,END=4)(FRAME(I),I=1,NCHAN)

	FI=FI+1.

	ECG=FRAME(NECG)

	IF(ECG.LT.THRESH)GO TO 1

	IF(IFLAG)5,5,6

5     IF(ECG.GT.OLDECG)IFLAG=1

	GO TO 1

6     IF(ECG.LT.OLDECG)GO TO 2

	GO TO 1

2     FI=FI-1.

	RETURN

3     PAUSE ' ERROR READING DATA'

4     FI=0.

	RETURN

	END



