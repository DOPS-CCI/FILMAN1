      SUBROUTINE SAVECORR(R2,R1M,V,NCHANS,IORD,IWIN,ITRLN,IWNMAX)
C      DOUBLE PRECISION R2(NCHANS*IORD,NCHANS*IORD)
C      DOUBLE PRECISION R1M(NCHANS*IORD,NCHANS)
C      DOUBLE PRECISION V(NCHANS,NCHANS)
      DOUBLE PRECISION R2(*)
      DOUBLE PRECISION R1M(*)
      DOUBLE PRECISION V(*)
      COMMON /COVFIL/ ICVN,IRECCN,IRECL,IERRCN
      
      IF(IERRCN.NE.0)RETURN
      INUMR=(ITRLN-1)*IWNMAX+IWIN  
      INUMR1=(INUMR-1)*(IORD*IORD+IORD+1)+1
      ILIM=NCHANS*NCHANS
      do 1,irec=1,IORD*IORD
      WRITE(ICVN,REC=INUMR1,ERR=10,IOSTAT=iostat)
     $            (R2(I),I=(irec-1)*ILIM+1,irec*ILIM)
    1 INUMR1=INUMR1+1  
      do 2,irec=1,iord
      WRITE(ICVN,REC=INUMR1,ERR=10,IOSTAT=iostat)
     $            (R1M(I),I=(irec-1)*ILIM+1,irec*ILIM)
    2 INUMR1=INUMR1+1  
      WRITE(ICVN,REC=INUMR1,ERR=10,IOSTAT=iostat)
     $            (V(I),I=1,ILIM)
      IF(INUMR1.GT.IRECCN)IRECCN=INUMR1
      RETURN
10    IERRCN=iostat
      WRITE(*,*)'Write error ',IERRCN
      RETURN      
      END
      
      SUBROUTINE GETCORR(R2,R1M,V,NCHANS,IORD,IWIN,ITRLN,IWNMAX)
C      DOUBLE PRECISION R2(NCHANS*IORD,NCHANS*IORD)
C      DOUBLE PRECISION R1M(NCHANS*IORD,NCHANS)
C      DOUBLE PRECISION V(NCHANS,NCHANS)
      DOUBLE PRECISION R2(*)
      DOUBLE PRECISION R1M(*)
      DOUBLE PRECISION V(*)
      COMMON /COVFIL/ ICVN,IRECCN,IRECL,IERRCN
      
      IF(IERRCN.NE.0)RETURN
      INUMR=(ITRLN-1)*IWNMAX+IWIN  
      INUMR1=(INUMR-1)*(IORD*IORD+IORD+1)+1
      ILIM=NCHANS*NCHANS
      do 1,irec=1,IORD*IORD
      READ(ICVN,REC=INUMR1,ERR=10,IOSTAT=iostat)
     $            (R2(I),I=(irec-1)*ILIM+1,irec*ILIM)
    1 INUMR1=INUMR1+1  
      do 2,irec=1,iord
      READ(ICVN,REC=INUMR1,ERR=10,IOSTAT=iostat)
     $            (R1M(I),I=(irec-1)*ILIM+1,irec*ILIM)
    2 INUMR1=INUMR1+1  
      READ(ICVN,REC=INUMR1,ERR=10,IOSTAT=iostat)
     $            (V(I),I=1,ILIM)
      RETURN
10    IERRCN=iostat
      WRITE(*,*)'Read error ',IERRCN
      RETURN      
      END


	SUBROUTINE AVGCORRS(AR2,AR1M,AV,NCHANS,IORD,IWIN,IWNMAX,ITRMX)
      DOUBLE PRECISION AR2(NCHANS*IORD,NCHANS*IORD)
      DOUBLE PRECISION AR1M(NCHANS*IORD,NCHANS)
      DOUBLE PRECISION AV(NCHANS,NCHANS)
      DOUBLE PRECISION R2(:,:),R1M(:,:),V(:,:)
      ALLOCATABLE R2,R1M,V
      COMMON /COVFIL/ ICVN,IRECCN,IRECL,IERRCN
C      COMMON /COVARR/ AR2,AR1M,AV
      DOUBLE PRECISION ONE,DIVID
      DATA ONE /1D0/, IEDEN /1/
      
      NO=NCHANS*IORD
      NO2=NO*NO
      NC2=NCHANS*NCHANS
      DIVID=1D0/DBLE(ITRMX)
      ALLOCATE(R2(NO,NO),STAT=ierr)
      ALLOCATE(R1M(NO,NCHANS),STAT=ierr)
      ALLOCATE(V(NCHANS,NCHANS),STAT=ierr)
      
      CALL GETCORR(AR2,AR1M,AV,NCHANS,IORD,IWIN,1,IWNMAX)
      Do 2,IT=2,ITRMX
      CALL GETCORR(R2,R1M,V,NCHANS,IORD,IWIN,IT,IWNMAX)
      CALL DAXPY(NO2,ONE,R2,IEDEN,AR2,IEDEN)
      CALL DAXPY(NO*NCHANS,ONE,R1M,IEDEN,AR1M,IEDEN)
2     CALL DAXPY(NC2,ONE,V,IEDEN,AV,IEDEN)
      CALL DSCAL(NO2,DIVID,AR2,IEDEN)
      CALL DSCAL(NO*NCHANS,DIVID,AR1M,IEDEN)
      CALL DSCAL(NC2,DIVID,AV,IEDEN)

      DEALLOCATE(V)
      DEALLOCATE(R1M)
      DEALLOCATE(R2)
      RETURN
      
	END   
	
	SUBROUTINE AVGLISTCORRS(LIST,IPLSZ,
     $                        AR2,AR1M,AV,NCHANS,IORD,IWIN,IWNMAX,ITRMX)
      DOUBLE PRECISION AR2(NCHANS*IORD,NCHANS*IORD)
      DOUBLE PRECISION AR1M(NCHANS*IORD,NCHANS)
      DOUBLE PRECISION AV(NCHANS,NCHANS)
      DOUBLE PRECISION R2(:,:),R1M(:,:),V(:,:)
      ALLOCATABLE R2,R1M,V
      COMMON /COVFIL/ ICVN,IRECCN,IRECL,IERRCN
C      COMMON /COVARR/ AR2,AR1M,AV
      DIMENSION LIST(IPLSZ)
      DOUBLE PRECISION ONE,DIVID
      DATA ONE /1D0/, IEDEN /1/
      
      NO=NCHANS*IORD
      NO2=NO*NO
      NC2=NCHANS*NCHANS
      DIVID=1D0/DBLE(ITRMX)
      ALLOCATE(R2(NO,NO),STAT=ierr)
      ALLOCATE(R1M(NO,NCHANS),STAT=ierr)
      ALLOCATE(V(NCHANS,NCHANS),STAT=ierr)
      
      CALL GETCORR(AR2,AR1M,AV,NCHANS,IORD,IWIN,LIST(1),IWNMAX)
      Do 2,IT=2,IPLSZ
      CALL GETCORR(R2,R1M,V,NCHANS,IORD,IWIN,LIST(IT),IWNMAX)
      CALL DAXPY(NO2,ONE,R2,IEDEN,AR2,IEDEN)
      CALL DAXPY(NO*NCHANS,ONE,R1M,IEDEN,AR1M,IEDEN)
2     CALL DAXPY(NC2,ONE,V,IEDEN,AV,IEDEN)
      CALL DSCAL(NO2,DIVID,AR2,IEDEN)
      CALL DSCAL(NO*NCHANS,DIVID,AR1M,IEDEN)
      CALL DSCAL(NC2,DIVID,AV,IEDEN)

      DEALLOCATE(V)
      DEALLOCATE(R1M)
      DEALLOCATE(R2)
      RETURN
      
	END   
	

	SUBROUTINE INITSVCORR(INPFIL,IWNSZ,IWNSHF,ITRMAX,NCHANS,IORD,IWNMAX)
	CHARACTER*(*) INPFIL
      COMMON /COVFIL/ ICVN,IRECCN,IRECL,IERRCN
      CHARACTER*1024 FNAME
      
      ICVN=78
      IRECL=NCHANS*NCHANS*2
      FNAME='C:\EEGDATA\'//INPFIL(1:LEN_TRIM(INPFIL))//'.AVGCORR.TMP'
      OPEN(UNIT=ICVN,STATUS='REPLACE',FORM='UNFORMATTED',
     $     ACCESS='DIRECT',RECL=IRECL,ERR=10,IOSTAT=iostat,
     $     FILE=FNAME)
      IERRCN=0
      IRECCN=1
      RETURN
10    IERRCN=iostat
      WRITE(*,*)'File ',FNAME(1:LEN_TRIM(FNAME)),' open error ',IERRCN
      RETURN
	END
	
!	SUBROUTINE INITAVGCA
!      COMMON /COVARR/ AR2,AR1M,AV
!      END
      
	SUBROUTINE CLOSESVCORR
      COMMON /COVFIL/ ICVN,IRECCN,IRECL,IERRCN
      
C      CLOSE(UNIT=ICVN)
      CLOSE(UNIT=ICVN,STATUS='DELETE')
	END
      