C HIST.FOR- TRANSFORMS EACH RAW EEG RECORD TO AN AMPLITUDE HISTOGRAM,

C USING ALL VALUES. ALSO GENERATES FIRST 4 MOMENTS OF THE DENSITY

C NB:ASSUMES BIPHASIC DATA

	SUBROUTINE HIST

      INCLUDE 'MAX.INC'

	COMMON IFLAG1,IFLAG2,IFLAG3,KNT,ISZ,ICHAN(ICHMAX)

	COMMON /FLDES/NG,NA,NC,ND,NF,NL,NR,IS,IBUF(IOMAX)

	COMMON /FLDESO/NGO,NAO,NCO,NDO,NFO,NLO,NRO,ISO,IBUFO(IOMAX)

	COMMON/DEV/ITI

	INTEGER*4, SAVE :: NB2,NPT,NSO

	REAL*4, SAVE :: S1,S

	DIMENSION FMOM(5),WORK(IOMAX-100),ICNT(102)

	EQUIVALENCE (Z,IZ),(FMOM(1),SX1)

	EQUIVALENCE (WORK(1),IBUFO(101))
      COMMON /CPN/ CURPROCNAME
      CHARACTER*10 CURPROCNAME

	IF(IFLAG1)10,20,30

10      NFO=3
      CURPROCNAME='HIST'
      WRITE(*,*) CURPROCNAME
C MOVE CHANNEL LABELS

	J=6*NGO+109

	DO 12 I=1,NCO

	L=J+5

	K=6*(NG+ICHAN(I))-5

	DO 11 I1=J,L

	IBUFO(I1)=IBUF(K)

11      K=K+1

12      J=J+6

!	WRITE(*,103)
!
!C103     FORMAT('$NUMBER OF BINS(<=100)? >'\)
!103     FORMAT('$NUMBER OF BINS(<=100)? >')
!
!	READ(*,*)NB

	S=160.      ! ASSUMED MAX AMPLITUDE IN uVOLTS
	S1=S
      CALL DoHISTDialog(NB,S1)

!	WRITE(*,105)
!
!105     FORMAT('$MAX INPUT AMPLITUDE IN uV (<CR>=160.)? >'\)
!
!	READ(*,*)S1

	IF(S1)16,16,15

15      S=S1

16      S1=FLOAT(NB)/(2.0*S)

	NPT=NDO

	NDO=NB+7

	NB2=NB+2

	NSO=NGO+NAO+1

	ISZ=(NDO+NPT)+NGO+NAO

	ISO=1       ! FUDGE TO LET PLOT HANDLE HIST'S LIKE SPECTRA

	RETURN

20      DO 25 I=1,NB2

25      ICNT(I)=0

	DO 60 I=1,NPT

	CALL XVAL(I,XV,XI)

	WORK(I)=XV

C STORE VALUE FOR LATER PROCESSING (VS XVAL TWICE)

C INCREMENT APPROPRIATE BIN COUNTER

	J=IFIX(S1*(XV+S))+2

	IF(J)50,50,55

50      J=1

	GO TO 60

55      IF(J-NB2)60,60,56

56      J=NB2

60      ICNT(J)=ICNT(J)+1

C ALL POINTS PROCESSED; GENERATE SUMMARY STATS

	CALL STATS(WORK,NPT,FMOM)

C CONSTRUCT & WRITE OUTPUT RECORD

	K=NSO

	DO 70 I=1,NB2

	Z=FLOAT(ICNT(I))

	IBUFO(K)=IZ

70      K=K+1

	DO 75 I=1,5

	Z=FMOM(I)

	IBUFO(K)=IZ

75      K=K+1

	CALL PUTSTD(IBUFO)

30      RETURN

	END





C SUBROUTINE TO COMPUTE DESCRIPTIVE STATISTICS FOR AN INPUT DATA

C ARRAY. RETURNS FIRST 4 MOMENTS AT PRESENT. LATER MAY ADD 5TH

C TERM TO MEASURE OVERALL DEPARTURE FROM NORMALITY.



	SUBROUTINE STATS(D,N,F)

	DIMENSION D(N),F(5)

	REAL*4, SAVE :: AN,AN1,SKEW,KURT

C INITIALIZE

	IF(AN)1,1,2

1       AN=N



	AN1=AN*(AN-1.0)

	SKEW=AN/((AN-1.)*(AN-2.))

	KURT=SKEW*(AN+1.)/(AN-3.)-3.*(AN-1.)**2/((AN-2.)*(AN-3.))

C PROCESS

2       DO 5 I=1,5

5       F(I)=0.0

C FIRST PASS COMPUTES MEAN & SD

	DO 10 I=1,N

	X=D(I)

	F(1)=F(1)+X

10      F(2)=F(2)+X*X

	F(2)=SQRT((AN*F(2)-F(1)*F(1))/AN1)

	F(1)=F(1)/AN

C COMPUTE SKEW & KURTOSIS ON 2ND PASS TO IMPROVE ACCURACY

C SEE 1979 SAS MANUAL, P.303

	DO 20 I=1,N

	Z=(D(I)-F(1))/F(2)

	Z3=Z*Z*Z

	Z4=Z3*Z

	F(3)=F(3)+Z3

20      F(4)=F(4)+Z4

	F(3)=SKEW*F(3)

	F(4)=KURT*F(4)

	F(5)=0.0 ! Dummy

	RETURN

	END



