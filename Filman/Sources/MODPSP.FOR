C MODPSP.FOR- ROUTINE TO GET AR SPECTRA USING MARPLE'S MODCOVAR

C ALGORITHM FOR COEFFICIENTS, AND FFT TO COMPUTE SPECTRUM. GENERATES

C SPECTRA FOR ALL ORDERS BETWEEN M1 AND M2 WITH FPE/AIC AND COEFFICIENTS

C LISTED. IN THIS AS PREVIOUS VERSIONS LOWER-ORDER MODELS ARE REPEATEDLY 

C REGENERATED. NO BIG DEAL FOR SPECTR, THOUGH. CONVERTED TO POWERSTATION

C 10/93 WITHOUT ATTENTION TO THIS EFFICIENCY QUESTION.

	SUBROUTINE MODPSP(X,N,IC)     !INPUT, # PTS, # SELECTED CHANS

	COMMON IFLAG1,IFLAG2,IFLAG3,KNT,ISZ,ICHAN(64),ICLABS(6,64)

	COMMON/FLDES/ID(8),IBUF(1)

	COMMON/FLDESO/IDO(8),WORK(1)

	COMMON/DEV/ITI,ILP

	COMMON/PTLST/NLIST,LIST(2,72),NP1,NP2,NPTOT,P1,PT,DT,DF

	DIMENSION COF(99),X(N,IC),SPECTRA[ALLOCATABLE](:,:)

	CHARACTER*24 PTITLE

1000    CALL PTSEL

1       WRITE(ITI,100)

100     FORMAT('$  MODPSP: FIRST, LAST ORDER(<100), & STEPSIZE? >'\)

	READ(ITI,*)M1,M2,M3

	IF(M3.EQ.0)M3=1

	WRITE(PTITLE,800)M1,M2,M3

800     FORMAT('MODCOVAR: ',3I3)

C PLOT PARAMETERS

	FNYQ=FLOAT(ID(8))/2.

	DT=1.0/FLOAT(ID(8))

2       WRITE(ITI,300)FNYQ

300     FORMAT('$  FREQUENCY CUTOFF(.LE.',F5.1,') >'\)

	READ(ITI,301)FMAX

301     FORMAT(F8.0)

	IF(FMAX.EQ.0.)FMAX=FNYQ

3       WRITE(ITI,200)

200     FORMAT('$  MODPSP FFT SIZE:1=256/2=512/3=1024/4=2048/5=4096 >'\)

	READ(ITI,201)K

201     FORMAT(I1)

	IF(K.LT.1 .OR. K.GT.5)GO TO 3

	NXFM=2**(K+7)

	AN=NXFM/2

	DF=FNYQ/AN      ! PARAMETERS FOR SPECPLOT-

	NPT0=FMAX/DF+1   ! INITIAL VALUES

	N1=1

	N2=NPT0

	NXEQ=0

	IKP=0

	ISETF=0

	MODE=0

	ALLOCATE(SPECTRA(NPT0,IC),STAT=IERR)

	WRITE(ITI,199)

199     FORMAT('$  RECALL PREVIOUS PLOT? >'\)

	READ(ITI,'(A1)')IA

	IF(IA.EQ.'Y')IKP=1

C CALCULATE & PLOT SPECTRA 1 CHANNEL AT A TIME; WE COULD INVERT ORDER

C OF LOOPS SO THAT ALL CHANNELS ARE CALCULATED AND PLOTTED AT EACH

C ORDER, BUT IN SINGLE MODE THAT PREVENTS STACKING THE ORDERS. ALL

C THESE IRRITATIONS RESULT FROM USING THE SAME DEVICE FOR PLOTS AND

C TERMINAL COMMUNICATIONS.

      MODXEQ=0

	DO 95 L=1,IC

	DO 90 M=M1,M2,M3

C COPY CURRENT CHANNEL'S INPUT TO WORK, WHERE WE CAN DO BIG FFT'S

	K=1

	DO 10 I=NP1,NP2

	WORK(K)=X(I,L)

10      K=K+1

	CALL DETRND(WORK,NPTOT,2)     ! CENTERS & DETRENDS THE DATA

C GET AR COEFFICIENTS USING MARPLE'S MODCOVAR ROUTINE

	CALL MODCOV(NPTOT,M,WORK,PM,COF,ISTAT,1)

	IF(ISTAT.EQ.0)GO TO 15

	WRITE(ITI,202)M

202     FORMAT('   ! UNSTABLE AT ORDER',I3,'; SKIPPING SPECTRUM')

	GO TO 90

15    AN=NPTOT

	AM=M+1

	FPE=PM*(AN+AM)/(AN-AM)

	IF(PM.LT.1.0)PM=1.0

	AIC=AN*ALOG(PM)+2.0*(AM-1.0)

C FPE AND AIC ARE AKAIKE'S ORDER-SELECTION CRITERIA

C      WRITE(ITI,103)PM,FPE,AIC

C103     FORMAT('    PM=',F10.2,'; FPE=',F8.2,'; AIC=',F8.2)

C     WRITE(ITI,104)(COF(I),I=1,M)

C104     FORMAT('     ',10F7.3)

C CALCULATE SPECTRUM VIA FFT OF COEFFICIENTS  ** DO IT IN WORK **

	WORK(1)=1.0

	DO 20 I=1,M

20      WORK(I+1)=COF(I)

	DO 25 I=M+2,NXFM

25      WORK(I)=0.

	CALL FAST(WORK,NXFM)

	J=1

	FACT=PM*DT

	DO 30 I=1,NPT0

	SPECTRA(I,L)=FACT/(WORK(J)**2+WORK(J+1)**2)

30    J=J+2

	CALL SPECPLOT(SPECTRA,NPT0,IC,N1,N2,L,L,2,PTITLE,IKP,

     + NXEQ,0,ISETF,MODE)     ! N1,N2 MAY BE CHANGED BY SPECPLOT

	IF(MODXEQ.GT.0 .OR. L.GT.1)GO TO 85      

80    WRITE(ITI,203)

203   FORMAT('$  MODPSP: <CR>=CONTINUE/1=FREQS/2=MODEL/3=POINTS >'\)

	READ(ITI,204)IGO

204   FORMAT(I1)

      IF(IGO.NE.0)DEALLOCATE(SPECTRA) ! DIMENSIONS MAY CHANGE

	GO TO(85,2,1,1000)IGO+1

85    IKP=1     ! ALWAYS, AFTER FIRST PLOT

	MODXEQ=MODXEQ+1     ! 

90    CONTINUE    ! MODEL ORDER LOOP

C RESTART PLOT OVERLAYS IF MODE = 1 (SINGLE)

	IF(MODE.EQ.2)GO TO 95

	IKP=0

	ISETF=0

C	NXEQ=0

	MODXEQ=0

95    CONTINUE    ! CHANNEL LOOP

50    DEALLOCATE(SPECTRA)  

	RETURN

	END



