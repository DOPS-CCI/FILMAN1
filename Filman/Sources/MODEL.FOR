C MODEL.FOR- GENERAL-PURPOSE PROGRAM TO GENERATE TEST DATA FOR FILMAN

C AND SPECTR. RECORDS ARE CONSTRUCTED AS A COMPOSITE OF ONE OR MORE OF THE

C FOLLOWING: AN ARMA MODEL OF SPECTRAL BACKGROUND, ZERO OR MORE EMBEDDED

C AND ADDED GAUSSIAN NOISE.  NOTE THAT N(0,1) NOISE IS ALSO USED TO

C DRIVE THE ARMA MODEL REPRESENTING THE SPECTRAL BACKGROUND.  THE AMPLITUDES

C OF THE EMBEDDED SINUSOIDS ARE LINKED TO THE LEVELS OF GROUP VAR 2, WHICH

C IS ALWAYS PRESENT; LEVEL ONE HAS AN AMPLITUDE OF 0. (CONTROL), LEVEL 2

C HAS 1*AMP, LEVEL 3 HAS 2*AMP, ETC. LEVELS ARE ASSIGNED RANDOMLY

C DURING EXECUTION AS THE PROGRAM PRODUCES A USER-SPECIFIED # OF

C RECORD-SETS WITH THE SPECIFIED NUMBER OF CHANNELS AND DATA-POINTS

C AT THE SPECIFIED SAMPLING RATE.  THE SIGNAL-TO-NOISE RATIO OF EMBEDDED

C SIGNALS CAN BE VARIED WHILE MAINTAINING TOTAL AMPLITUDE CONSTANT, BUT

C ABSOLUTE LEVELS IN DB REMAIN TO BE WORKED OUT AS OF 12/92.

C ** STILL NEEDS ARMA PART 8/93

      USE IFQWIN   

	REAL NOISCL

	CHARACTER*1 INPFIL(64),OUTFIL(64),IA

	INTEGER*2 IHR,IMIN,ISEC,I100

	INTEGER*4 ID(116)

      TYPE (qwinfo) winfo

	DIMENSION LABS(6,32),IGLAB(18),SIGNAL(5,4),X(4096)

	COMMON/FLDESO/NGO,NAO,NCO,NDO,NFO,NPO,NRO,ISO,IBUFO(4200)

	COMMON/STDFIL/INPFIL,OUTFIL

	EQUIVALENCE (IGLAB(1),IBUFO(109)),(LABS(1,1),IGLAB(1))

	EQUIVALENCE (ID(1),NGO)

	DATA IGLAB/'CHAN',' NUM','BER ',3*'    ',

     +           'MONT','AGE ','FILE',3*'    ',

     +           'AMPL','ITUD','ES  ',3*'    '/

	ITI=12

      OPEN(UNIT=12,FILE='USER',TITLE='Test window')

      winfo%TYPE=QWIN$SET

      winfo%X=10

      winfo%Y=10

      winfo%H=50

      winfo%W=100

      I = SETWSIZEQQ(12,winfo)

1     CALL PUTOPN

3     NAO=0

	NFO=1

	NRO=0

	NGO=3

	WRITE(ITI,203)

203   FORMAT('$# OF CHANNELS? >'\)

	READ(ITI,*)NCO

	WRITE(ITI,204)

204   FORMAT('$SAMPLE RATE, #DATA PTS(2**N, .LE. 32768)? >'\)

	READ(ITI,*)ISO,NDO

	WRITE(ITI,205)

205   FORMAT('$# OF RECORD-SETS? >'\)

	READ(ITI,*)NRS

	NPO=NGO+NDO

	WRITE(ITI,206)

206   FORMAT(' NUMBER OF LEVELS FOR AMPLITUDE GROUP VAR >'\)

5     READ(ITI,*) GLVLS

7     DO 10 I=1,NCO

	WRITE(ITI,207)I

207   FORMAT('$ENTER LABEL (UP TO 24 CHARS) FOR CHANNEL',I2,'>'\)

10    READ(ITI,103)(LABS(J,I+NGO),J=1,6)

103   FORMAT(6A4)

	WRITE(ITI,208)

208   FORMAT(' ENTER 6 LINES HEADER TEXT:')

	READ(ITI,104)(IBUFO(I),I=1,108)

104   FORMAT(18A4)

	CALL PUTSTD(ID)

	CALL PUTSTD(LABS)

	WRITE(ITI,209)

209   FORMAT('$FRACTIONAL NOISE POWER, TOTAL SIGNAL AMPLITUDE? >'\)

	READ(ITI,*)NOISCL,TAMP

	SDNOISE=SQRT(NOISCL)

C INITIALIZE RNG

	CALL GETTIM(IHR,IMIN,ISEC,I100)

	ISEED=ISEC*I100 + IHR*IMIN

	CALL SEED(ISEED)

C LOOP TO IDENTIFY EMBEDDED SINUSOIDS

	TWOPI=8.0*ATAN(1.)

	DT=1.0/FLOAT(ISO)

	WRITE(ITI,198)

198   FORMAT('$# OF EMBEDDED SINUSOIDS?, START POINT? >'\)

	READ(ITI,*)NSIG,NP1

	IF(NSIG.EQ.0)GO TO 6

	DO 4 I=1,NSIG

	WRITE(ITI,200)I

200   FORMAT('$SIGNAL',I2,' FREQUENCY, FRACT. POWER, PHASE(DEG.)?', 

     +  '& DAMPING(1/SEC)>'\)

	READ(ITI,*)F,POWER,PHI,DAMP

	AMP=SQRT(2.0*POWER)     ! SQRT(POWER)-->RMS AMP, TIMES 1.414

	SIGNAL(I,1)=AMP

	SIGNAL(I,2)=TWOPI*F*DT

	SIGNAL(I,3)=(PHI/360.)*TWOPI

	SIGNAL(I,4)=-DAMP*DT

4     CONTINUE

6     DO 90 K=1,NRS

	CALL RANDOM(YFL)    !U[0,1]

	IT=GLVLS*YFL+1.0

	IF(IT .GT. GLVLS) IT=GLVLS

20    IBUFO(3)=IT

	IBUFO(2)=0

22    DO 80 J=1,NCO

	IBUFO(1)=J

	X=0.0

C  LAYER TGE MODEL COMPONENTS SUCCESSIVELY INTO ARRAY X

	IF(NOISCL.EQ.0.) GO TO 40

	DO 30 I=1,NDO

	CALL GAUSSIAN(SDNOISE,0.,VAL)

30      X(I)=VAL

40        IF(NSIG)70,70,41

41    DO 60 L=1,NSIG

	AMP=SIGNAL(L,1)*FLOAT(IT-1)  !AMPLITUDE ADJUSTED FOR GRP 2 LEVEL

	FREQ=SIGNAL(L,2)

	PHASE=SIGNAL(L,3)

	DAMP=SIGNAL(L,4)

	DO 50 I=NP1,NDO

	ARG=FLOAT(I-NP1)

	Y=AMP*EXP(DAMP*ARG)*COS(FREQ*ARG+PHASE)

50      X(I)=X(I)+Y

60    CONTINUE

C IN HERE GOES LAYER FOR ARMA BKG

C SCALE COMPOSITE SIGNAL TO FINAL AMPLITUDE & WRITE RECORD

70    DO 75 I=1,NDO

75    IBUFO (I+NGO)=IFIX(X(I)*TAMP+.5)

80    CALL PUTSTD(IBUFO)

90    CONTINUE

	CALL PUTEND

	WRITE(ITI,300)

300   FORMAT('$ANOTHER RUN? >'\)

	READ(ITI,301)IA

301   FORMAT(A1)

	IF(IA.EQ.'Y')GO TO 1

	STOP

	END

C SUBROUTINE TO GENERATE GAUSSIAN NOISE WITH SD=S AND MEAN=AM

	SUBROUTINE GAUSSIAN(S,AM,V)

	A=0.0

	DO 10 I=1,12

	CALL RANDOM(YFL)    !ASSUME RANDOM INITIALIZE ELSEWHERE

10        A=A+YFL

	V=(A-6.0)*S+AM

	RETURN

	END

