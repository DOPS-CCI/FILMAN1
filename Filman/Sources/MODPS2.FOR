C MODPS2.FOR SPECTR ROUTINE TO SEGMENT A RECORD INTO PARTS, MODEL THE 

C FIRST PART, USE THE MODEL TO FILTER THE SECOND PART, AND ANALYZE THE

C RESIDUAL. BASED ON MODCOVAR ALGORITHM. UPDATED TO POWERSTATION VERSION

C 11/8/93, OPERATING ON ALL CHANNELS AT EACH STAGE IN TURN.

	SUBROUTINE MODPS2(X,N,IC)

	COMMON IFLAG1

	COMMON/FLDES/ID(8),IBUF(1)

	COMMON/FLDESO/IDO(8),WORK      !   Maciek   WORK(1) -> WORK

	COMMON/DEV/ITI,ILP

	COMMON/PTLST/NLIST,LIST(2,72),NP1,NP2,NPTOT,PF1,PFT,DT,DF

	DIMENSION WK1(4100),WK2(4100),B(100)

	DIMENSION X(N,IC),SPECTRA[ALLOCATABLE](:,:),A[ALLOCATABLE] (:,:)

	CHARACTER*24 PTITLE

	EQUIVALENCE (WK1(1),WORK(1)),(WORK(4101),WK2(1))
	 
	dimension work(4101)           ! Maciek

1000    WRITE(ITI,1001)

1001    FORMAT('   MODPS2: FIRST IDENTIFY ENDPOINTS')

	CALL PTSEL

	WRITE(ITI,1002)

1002    FORMAT('$   SEGMENT BOUNDARY IN SECONDS >'\)

	READ(ITI,*)T2

	NP3=T2*FLOAT(ID(8))

1       WRITE(ITI,100)

100     FORMAT('   NEXT, SELECT MODEL FOR SEGMENT 1')

	NN=NP3-NP1+1

	PFT1=T2-PF1

	PFT2=PFT-PFT1

	PFT=PFT1

C PLOT PARAMETERS

	IOFF=0

	FNYQ=FLOAT(ID(8))/2.

	DT=1.0/FLOAT(ID(8))

2       WRITE(ITI,300)FNYQ

300     FORMAT('$  FREQUENCY CUTOFF(.LE.',F5.1,') >'\)

	READ(ITI,301)FMAX

301     FORMAT(F8.0)

	IF(FMAX.EQ.0.)FMAX=FNYQ

3       WRITE(ITI,200)

200     FORMAT('$  MODPS2 FFT SIZE:1=512/2=1024/3=2048/4=4096 >'\)

	READ(ITI,201)K

201     FORMAT(I1)

	IF(K.LT.1 .OR. K.GT.4)GO TO 3

	NXFM=2**(K+8)

	AN=NXFM/2

	DF=FNYQ/AN      ! PARAMETERS FOR PLOT1-

	NPT0=FMAX/DF+1   ! INITIAL VALUES

	NP1A=NP1

	NP2A=NP3

	ISEG=1

	IOFF=0

5     ALLOCATE(SPECTRA(NPT0,IC),STAT=IERR)

	NXEQ=0

	ISETF=0

	N1=1

	N2=NPT0

	ASSIGN 90 TO LOC

	WRITE(ITI,101)ISEG

101     FORMAT('$   SEGMENT',I2,': 1ST, LAST ORDER(<100), STEPSIZE? >'\)

	READ(ITI,*)M1,M2,M3

	IF(M3.EQ.0)M3=1

	IF(ISEG.GT.1)GO TO 4

	MFIRST=M2

	ALLOCATE(A(M2,IC),STAT=IERR)

4     IKP=0

C      WRITE(ITI,199)

199     FORMAT('$  RECALL PREVIOUS PLOT? >'\)

C      READ(ITI,401)IA

C      IF(IA.EQ.'Y')IKP=1

	WRITE(PTITLE,800)ISEG,M1,M2,M3

800     FORMAT('MODPS2 SEG',I2,', ',3I3)

	L=1   ! CHANNEL LOOP HANDLED 'MANUALLY' TO PERMIT RE-ENTRY TO 

C VARIOUS PLACES IN THE PROGRAM; UGLY BUT O.K.

6      DO 90 M=M1,M2,M3

C FIRST COPY SEGMENT'S RAW DATA TO WK1

	J=1

	DO 10 I=NP1A,NP2A

	WK1(J)=X(I,L)

10    J=J+1

C GET AR COEFFICIENTS USING MARPLE'S MODCOVAR ROUTINE

19    CALL MODCOV(NN,M,WK1,PM,B,ISTAT,1)

	IF(ISTAT.EQ.0)GO TO 21

	WRITE(ITI,202)M

202     FORMAT('   ! UNSTABLE AT ORDER',I3,'; SKIPPING SPECTRUM')

	GO TO LOC

21      AN=NN

	AM=M+1

	FPE=PM*(AN+AM)/(AN-AM)

	IF(PM.LT.1.0)PM=1.0

	AIC=AN*ALOG(PM)+2.0*(AM-1.0)

C FPE AND AIC ARE AKAIKE'S ORDER-SELECTION CRITERIA

	WRITE(ITI,102)L,ISEG,M

102     FORMAT('    RESULTS FOR CHANNEL',I3,' SEG',I3,', ORDER',I3,':')

	WRITE(ITI,103)PM,FPE,AIC

103     FORMAT('    PM=',F10.2,'; FPE=',F8.2,'; AIC=',F8.2)

C      WRITE(ITI,104)(B(I),I=1,M)

104     FORMAT('     ',10F7.3)

C CALCULATE SPECTRUM VIA FFT OF COEFFICIENTS

	WORK(1)=1.0

	DO 20 I=1,M

20      WORK(I+1)=B(I)

	DO 25 I=M+2,NXFM

25      WORK(I)=0.

	CALL FAST(WK1,NXFM)

	J=1

	FACT=PM*DT

	DO 30 I=1,NPT0

	SPECTRA(I,L)=FACT/(WORK(J)**2+WORK(J+1)**2)

	J=J+2

30      CONTINUE

	WRITE(ITI,400)

400     FORMAT('$  SPECTRUM READY; <CR> TO PROCEED'\)

	READ(ITI,401)

401     FORMAT(A1)

	  CALL SPECPLOT(SPECTRA,NPT0,IC,N1,N2,L,L,2,PTITLE,IKP,NXEQ,

     +   IOFF,ISETF,MODE)

	  IKP=1

	  NXEQ=NXEQ+1

	GO TO LOC

90      CONTINUE

C IF PROCESSING SEGMENT 1 SAVE AR COEFFS FOR FILTERING SEGMENT 2

	IF(ISEG.NE.1)GO TO 94

	DO 92 I=1,MFIRST

	A(I,L)=B(I)

92    CONTINUE

94    L=L+1

	IF(L.GT.IC)GO TO 95

	IF(MODE.EQ.1)IKP=0      ! RESETS OVERLAY MODE FOR NEXT CHAN

	GO TO 6     ! FOR NEXT CHANNEL

95      WRITE(ITI,203)

203     FORMAT('$  MODPS2:0=PROCEED/1=FREQS/2=MODEL/3=POINTS/4=RET>'\)

	READ(ITI,204)IGO

204     FORMAT(I1)

	GO TO (50,45,45,45,96) IGO+1

45    DEALLOCATE(SPECTRA)

	DEALLOCATE(A)

	GO TO(2,5,1000)IGO

50      IF(ISEG.EQ.2)GO TO 75

C SET UP FOR PROCESSING OF SECOND SEGMENT

	ISEG=2

	NP1A=NP1A+NN

	NP2A=NP2

	NN=NP2A-NP1A+1

	PF1=T2

	PFT=PFT2

	N1=NP1A

	N2=NP2A

	ISETF=0

	WRITE(ITI,500)

500     FORMAT('   NEXT ANALYZE 2ND SEGMENTS; <CR> TO PLOT RAW DATA >'\)

	READ(ITI,'(A1)')IA

C PLOT SEGMENT 2, FILTER IT, AND REPLOT IT

	WRITE(PTITLE,900)   

900     FORMAT('RAW SEGMENT 2 DATA')

	  CALL SPECPLOT(X,N,IC,N1,N2,1,IC,1,PTITLE,0,NXEQ,0,ISETF,MODE)

	DO 700 L=1,IC

C COPY RAW DATA INTO WORK FOR FILTERING STAGE

56    J=1

	DO 60 I=NP1A,NP2A

	WORK(J)=X(I,L)

60      J=J+1

C ADD LAST MFIRST POINTS OF SEGMENT 1 TO BEGINNING OF SEGMENT 2

	DO 14 I=NN,1,-1

14      WORK(I+MFIRST)=WORK(I)

	DO 15 I=1,MFIRST

15      WORK(MFIRST-I+1)=X(NP3+1-I,L)

C NOW APPLY THE AR FILTER, STORING RESULTS BACK INTO X

	DO 18 I=1,NN

	J=I+MFIRST

	SUM=WORK(J)       ! ORIGINAL VALUE

	DO 17 K=1,MFIRST

17      SUM=SUM+A(K,L)*WORK(J-K)

18     X(NP1A+I-1,L)=SUM       ! FILTERED VALUE

700   CONTINUE

C PLOT THE FILTERED DATA FOR ALL CHANNELS      

	WRITE(PTITLE,901)MFIRST

901     FORMAT('FILTERED, ORDER',I3)

	IKP=0

	WRITE(ITI,903)

903     FORMAT('    PLOTTING FILTERED DATA; RECALL RAW DATA PLOT? >'\)

	READ(ITI,401)IA

	IF(IA.EQ.'Y')IKP=1

	CALL SPECPLOT(X,N,IC,N1,N2,1,IC,1,PTITLE,IKP,NXEQ,IOFF,0,MODE)

C GO TO MODELING SECTION

	GO TO 5

C TERMINAL SECTION TO GENERATE CSA FROM SUCCESSIVE OVERLAPPED SUBPARTS

C OF SEGMENT 2

75      NTOT=NN

76      WRITE(ITI,501)

501     FORMAT('$   WANT TO GENERATE CSA FOR SEGMENT 2? >'\)

	READ(ITI,401)IA

	IF(IA.NE.'Y')RETURN

	ASSIGN 85 TO LOC

	WRITE(ITI,502)

502     FORMAT('$   SUBSEGMENT LENGTH, SHIFT IN #PTS, MODEL ORDER >'\)

	READ(ITI,*)NX,ISHFT,M

	NPLT=(NTOT-NX)/ISHFT+1    ! TOTAL # PLOTS

	IOFF0=150./FLOAT(NPLT)  ! OFFSET OF JPL FOR SUCCESSIVE PLOTS

	IF(IOFF.LT.4)IOFF=4

	NN=NX

	IKP=0

	WRITE(PTITLE,904)NX,ISHFT,M

904     FORMAT('CSA: L=',I4,' S=',I3,' M=',I3)

	N1=1

	N2=NPT0

	L=1

	ISETF=0

78    NX1=NP1A

	ISEG=1

	IOFF=0

80      J=1

	DO 81 I=NX1,NX1+NN-1

	WK1(J)=X(I,L)

81      J=J+1

	GOTO 19

85      IF(ISEG-NPLT)86,87,87

86      WRITE(ITI,504)

504     FORMAT('$    CONTINUE STEPPING? >'\)

	READ(ITI,401)IA

	IF(IA.EQ.'N')GO TO 76

	IKP=1

	NX1=NX1+ISHFT

	IOFF=IOFF+IOFF0

	NXEQ=NXEQ+1 ! CHECK

	ISEG=ISEG+1

	GO TO 80

87    L=L+1      

	IF(L.LE.IC)GO TO 78

	WRITE(ITI,871)

871   FORMAT('$    CSA FINISHED; <CR> TO RECALL IT >'\)

	READ(ITI,201)IA

	CALL SPECPLOT(SPECTRA,NPT0,IC,N1,N2,1,IC,2,PTITLE,IKP,

     +  NXEQ,IOFF,ISETF,MODE)

	GO TO 76

96    DEALLOCATE(SPECTRA)  

	DEALLOCATE(A)

	RETURN

	END



