C STDIO.FOR

C STANDARD I/O FOR FILMAN, SPECTR & MANOVA; PC FORTRAN VERSION

	

	

	SUBROUTINE GETOPN

	CHARACTER*64 INFIL,INBUF,OUTFIL

	COMMON/STDFIL[NEAR]/INFIL,OUTFIL

	COMMON/CNTR1[NEAR]/ COUNT,CNTFLG,DUMMY,JREC

	INTEGER*2 COUNT,DUMMY(512),CNTFLG

10    WRITE(*,900)

900   FORMAT('$INPUT FILE(<CR>=LAST IN/*=LAST OUT/Q=QUIT) >',\)

	READ(*,905)INBUF

905   FORMAT(A)

	IF(LEN_TRIM(INBUF)-1)15,16,11

11    INFIL=INBUF

15    OPEN(UNIT=21,FILE='C:\EEGDATA\'//INFIL,STATUS='OLD',ERR=20,

     1  ACCESS='DIRECT',RECL=1024,BLOCKSIZE=1024) 

	GO TO 50

16    IF(INBUF.EQ.'Q' .OR. INBUF.EQ.'q')STOP

	IF(INBUF.NE.'*')GO TO 20

	INFIL=OUTFIL

	GO TO 15

20    WRITE(*,901)

901   FORMAT(' ERROR: UNABLE TO OPEN FILE; TRY AGAIN')

	GO TO 10

50    COUNT=0

	RETURN

	END

C ***********************************************************

	SUBROUTINE GETSTD(BUF)

	COMMON/CNTR1[NEAR]/ COUNT,CNTFLG,DUMMY,JREC

	INTEGER*2 BUF(1),COUNT,CNTFLG,DUMMY(512)

	IF(COUNT-1)1,2,3

C read 1st header 

1     COUNT=COUNT+1

	JREC=1

	READ(21,REC=JREC)DUMMY

	DO 10 J1=1,116

	BUF(J1)=DUMMY(J1)

10    CONTINUE

	NG=BUF(1)

	NC=BUF(3)

	NW=6*(NG+NC)

	NL=BUF(6)

	CNTFLG=117

	return

2     COUNT=COUNT+1

C read 2nd header, NW words of labels

	CALL FILBUF(BUF,NW)

	return

C read DATA RECORD OF NL words

3     CALL FILBUF(BUF,NL)

	return

	end

C *************************************************

	SUBROUTINE FILBUF(BUF,NW)

	COMMON/CNTR1[NEAR]/ COUNT,CNTFLG,DUMMY,JREC

	INTEGER*2 COUNT,DUMMY(512),CNTFLG,BUF(1)

	DO 100 J1=1,NW

	BUF(J1)=DUMMY(CNTFLG)

	CNTFLG=CNTFLG+1

	IF (CNTFLG.LE.512)GOTO 100

	CNTFLG=1

	JREC=JREC+1

	READ(21,REC=JREC,END=200)DUMMY

100   CONTINUE

200   RETURN

	END

C **********************************************

	SUBROUTINE GETEND

	COMMON/CNTR1[NEAR]/ COUNT,CNTFLG,DUMMY,JREC

	INTEGER*2 COUNT,DUMMY(512),CNTFLG,BUF(1)

	COUNT=0

	CLOSE(UNIT=21)

	RETURN

	END

C ******************************************

C SUBROUTINE TO SUPPORT DIRECT ACCESS TO RECSET N      

	SUBROUTINE GETREC(N)

	INTEGER*2 COUNT,CNTFLG,DUMMY(512),JREC

	COMMON/CNTR1[NEAR]/COUNT,CNTFLG,DUMMY,JREC

	COMMON/FLDES[NEAR]/NG,NA,NC,ND,NF,NP,NR,IS,IBUF(1)

	FN=N  !CALCULATE FIRST WORD AS REAL TO AVOID INTEGER OVERFLOW

	FIRSTWRD=117.+6.*(NG+NC)+(FN-1.)*NP*NC  !FIRST WORD OF NTH TRIAL

	JREC0=IFIX(FIRSTWRD/512.)

	CNTFLG=FIRSTWRD-JREC0*512.    !OFFSET FOR NEXT GETSTD()

	JREC=JREC0+1                  !INDEX TO THE RECORD

	READ(21,REC=JREC)DUMMY        !READ THAT RECORD INTO BUFFER

	RETURN

	END



C *******************************************

C *******************************************

	SUBROUTINE PUTSTD(BUFO)

	COMMON/FLDESO/IDO(8)

	COMMON/CNTR2[NEAR]/COUNT,CNTFLG,DUMMY,JREC      

	CHARACTER*64 FILNAM

	INTEGER*2 COUNT,CNTFLG,DUMMY(512),BUFO(1) 

	IF(COUNT-1)1,2,3

C write 1st header

1     COUNT=COUNT+1

	JREC=1

	DO 10 J1=1,116

	DUMMY(J1)=BUFO(J1)

10    CONTINUE

	NG=BUFO(1)

	NC=BUFO(3)

	NW=6*(NG+NC)

	NL=BUFO(6)

	CNTFLG=117

	RETURN

C write 2nd header

2     COUNT=COUNT+1

	CALL STOBUF(BUFO,NW)

	RETURN

C store NL words

3     CALL STOBUF(BUFO,NL)

C update count of data records written

	IDO(7)=IDO(7)+1

	return

	end

C ********************************************

	SUBROUTINE STOBUF(BUFO,NW)

	COMMON/CNTR2[NEAR]/COUNT,CNTFLG,DUMMY,JREC 

	INTEGER*2 COUNT,DUMMY(512),CNTFLG,BUFO(1)

	DO 100 J1=1,NW

	DUMMY(CNTFLG)=BUFO(J1)

	CNTFLG=CNTFLG+1

	IF (CNTFLG.LE.512)GOTO 100   

	CNTFLG=1

	WRITE(22,rec=JREC,ERR=5,IOSTAT=IOCHECK)DUMMY

	JREC=JREC+1

100   CONTINUE

	RETURN

5     WRITE(*,501)COUNT,CNTFLG,JREC,IOCHECK

501   FORMAT(' COUNT,CNTFLG,JREC,IOCHECK=',4I6)

	STOP ' STOBUF ERROR'

	END

C **********************************************

	SUBROUTINE PUTEND

	COMMON/FLDESO/IDO(8)

	COMMON/CNTR2[NEAR]/COUNT,CNTFLG,DUMMY,JREC

	INTEGER*2 COUNT,DUMMY(512),CNTFLG  

	COUNT=0

C store last block of data if neccessary

	IF (CNTFLG.EQ.1)GO TO 1

	WRITE(22,rec=JREC)DUMMY

	JREC=JREC+1

C store total # data records in NRO field of header 1

1     READ(22,rec=1)DUMMY

	DUMMY(7)=IDO(7)

	WRITE(22,rec=1)DUMMY

	CLOSE(UNIT=22)

	RETURN

	END

C **********************************************

	SUBROUTINE PUTOPN

	CHARACTER*64 INFIL,OUTFIL

	CHARACTER*1 ARESP

	COMMON/STDFIL/INFIL,OUTFIL

	COMMON/CNTR2[NEAR]/COUNT,CNTFLG,DUMMY,JREC

	INTEGER*2 COUNT,DUMMY(512),CNTFLG  

	COUNT=0

1     CONTINUE

	WRITE(5,900)

900   FORMAT(' Output file >',\)

	READ(5,905)OUTFIL

905   FORMAT(A)

	OPEN (UNIT=22,FILE='C:\EEGDATA\'//OUTFIL,STATUS='old',ERR=3)

	close (unit=22)

	WRITE (5,902)

902   FORMAT ('$File already exists - write over it?  >',\)

	READ (5,903)ARESP

903   FORMAT (A1)

	IF ((ARESP.EQ.'n').OR.(ARESP.EQ.'N')) GOTO 1

3     CONTINUE

	OPEN (UNIT=22,FILE='C:\EEGDATA\'//OUTFIL,BLOCKSIZE=1024,    

     1  ACCESS='DIRECT',RECL=1024)

	JREC=1

	RETURN

	END

