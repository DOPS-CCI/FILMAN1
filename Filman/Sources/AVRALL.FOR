C AVRALL.FOR- AVERAGES POINTS ACROSS RECSETS, WITHIN CHANNELS.
C   +/- AVERAGING AND 9-POINT SMOOTHING FOR SEP DATA ADDED 10/12/91.
C NEW FILMAN VERSION 11/92 USES ALLOCATABLE ARRAY FOR PROCESSING.
C AUTOMATIC DETRENDING OF TIME DATA ADDED 3/95.
C GENERALIZATION TO COMPLEX DATA STILL PENDING.

	SUBROUTINE AVRALL
      INCLUDE 'MAX.INC'
	REAL, ALLOCATABLE, SAVE :: WORK(:,:),WORK1(:)
	COMMON IFLAG1,IFLAG2,IFLAG3,KNT,ISZ,ICHAN(ICHMAX)
	COMMON/FLDES/ NG,NA,NC,ND,NF,NL,NR,IS,IBUF(IOMAX)
	COMMON/FLDESO/ NGO,NAO,NCO,NDO,NFO,NLO,NRO,ISO,IBUFO(IOMAX)
	EQUIVALENCE (IP,X)
	INTEGER, SAVE :: IC,ISIGN,IABBA,ITYPE,IFILT,NTOT,ITIME
      COMMON /CPN/ CURPROCNAME
      CHARACTER*10 CURPROCNAME

	IF(IFLAG1) 10,20,30
10    NFO=3

      CURPROCNAME='AVRALL'

	J=6*NGO+109

	DO 12 I=1,NCO

	L=J+5

	K=6*(NG+ICHAN(I))-5

	DO 40 I1=J,L

	IBUFO(I1)=IBUF(K)

40    K=K+1

12    J=J+6

	ISZ=NDO     ! FOR ALL BUT COMPLEX DATA

	IC=1        ! CHANNEL INDEX

	ISIGN=+1    ! SWITCH FOR +/- AVERAGES

	IABBA=0     ! FLAG FOR ABBA AVERAGING

	IT=0        ! ASSUME NO DATA TRANSFORM    

	NTOT=0
	
      CALL DoAVRALLDialog(ITIME,IT,ITYPE,IFILT)
	
!	WRITE(*,99)
!
!99    FORMAT('$DATA TYPE: 1=TIME/2=OTHER >'\)
!
!C	READ(*,101)ITIME
!      ITIME=IGETVALU('(I1)')
!      write(*,'(I1)')ITIME

	GO TO(3,2)ITIME

2     CONTINUE
!      WRITE(*,100)
!
!100   FORMAT('$DATA XFORM:0=NONE/1=SQRT/2=LN/3=ARCSIN/4=ABS >',\)
!
!C	READ(*,101)IT
!      IT=IGETVALU('(I1)')
!      write(*,'(I1)')IT
!
!101   FORMAT(I1)

3     IT=IT+1

!	WRITE(*,102)
!
!102   FORMAT('$AVERAGING:0=NORMAL/1=PLUS-MINUS/2=ABBA >',\)
!
!C	READ(*,101)ITYPE
!      ITYPE=IGETVALU('(I1)')
!      write(*,'(I1)')ITYPE

	ITYPE=ITYPE+1

!	WRITE(*,103)
!
!103   FORMAT('$SMOOTHING:0=NONE/1=NINE-POINT >',\)
!
!C	READ(*,101)IFILT
!      IFILT=IGETVALU('(I1)')
!      write(*,'(I1)')IFILT

	ALLOCATE(WORK(NDO,NCO),STAT=IERR)

	ALLOCATE(WORK1(NDO),STAT=IERR)

	IF(IERR.EQ.0) GO TO 15

C	PAUSE 'Allocation failure; try again'
	CALL ShowInfoText('Error','Allocation failure; try again')

      GO TO 10

15	DO 5 J=1,NDO  ! Zero

      WORK1(J)=0.

	DO 5 I=1,NCO

5     WORK(J,I)=0.0

	RETURN

C EXECUTION PHASE; FIRST GET THIS CHANNEL'S DATA

20    DO 70 I=1,NDO

	CALL XVAL(I,XV,XI)

	WORK1(I)=RECODE(XV,IT)

70    CONTINUE

	IF(ITIME.EQ.1)CALL DETRND(WORK1,NDO,2)

C NOW DO THE AVERAGING PER SELECTED REGIME

	DO 80 I=1,NDO   

	X=WORK(I,IC)    ! CURRENT SUM

	Y=WORK1(I)      ! NEW VALUE

	IF(ISIGN)61,61,62

61    X=X-Y

	GO TO 65

62      X=X+Y

65      WORK(I,IC)=X

80     CONTINUE

90      IC=IC+1

	IF(IC-NCO) 21,21,22

22      IC=1

	GO TO (25,24,23)ITYPE

23      IABBA=IABBA+1

	IF(IABBA.NE.2)GO TO 25

	IABBA=0

24      ISIGN=-ISIGN  ! CHANGE SIGN FOR +/- AVERAGES

25      NTOT=NTOT+1

21      RETURN

C TERMINATION PHASE- WRITE DATA RECORDS

30    TOT=NTOT

	DO 31 K=1,NCO

	IF(IFILT.EQ.1)CALL NINEPT(WORK(1,K),NDO) 

	J=NGO+NAO+1

	DO 34 I=1,NDO

	X=WORK(I,K)/TOT

	IBUFO(J)=IP

34    J=J+1

	IBUFO(1)=K

31    CALL PUTSTD(IBUFO)

	DEALLOCATE(WORK,STAT=IERR)

	DEALLOCATE(WORK1,STAT=IERR)

C	IF(IERR.NE.0)PAUSE 'DEALLOCATION FAILURE'
	IF(IERR.NE.0)CALL ShowInfoText('Error','DEALLOCATION FAILURE')

	RETURN

	END

C NINE-POINT SMOOTHING SUBROUTINE FOR SEP DATA; SEE SAVITSKY AND GOLAY,

C ANAL. CHEM. 36:1627 FF, 1964 FOR DETAILS.





c------------------------------------------------------------

	SUBROUTINE NINEPT(X,N)

	DIMENSION X(*),COEFF(4),HIST(4)

	DATA COEFF /54.,39.,14.,-21./

C INITIALIZE HISTORY; NEED TO KEEP CIRCULAR BUFFER OF UNTRANSFORMED DATA

	DO 5 J=1,4

5       HIST(J)=X(1)

	DO 30 I=1,N

	TEMP=X(I)

	SUM=0.

	DO 20 J=1,4

	I2=I+J

C AFTER STARTUP CHECK FOR RIGHT EDGE

10      IF(I2-N)20,20,15

15      I2=N

20      SUM=SUM+COEFF(J)*(HIST(J)+X(I2))

	X(I)=(59.*X(I)+SUM)/231.

C UPDATE HISTORY

	DO 25 J=3,1,-1

25      HIST(J+1)=HIST(J)

	HIST(1)=TEMP

30      CONTINUE

	RETURN

	END

