C MODPOW.FOR- CHANNEL-BY-CHANNEL AUTOREGRESSIVE SPECTRAL ESTIMATION

C  USING MARPLE'S MODIFIED COVARIANCE ALGORITHM; MODEL ORDER DETERMINED

C  AUTOMATICALLY OR FIXED IN ADVANCE, & SPECTRA COMPUTED VIA FFT AT 

C  USER-SPECIFIED RESOLUTION. AUTOMATIC OFFSET/TREND REMOVAL ADDED 3/95

	SUBROUTINE MODPOW

	INCLUDE 'MAX.INC'

	DIMENSION WORK(65540),COF(101)

	COMMON IFLAG1,IFLAG2,IFLAG3,KNT,ISZ,ICHAN(ICHMAX)

	COMMON/FLDESO/ NGO,NAO,NCO,NDO,NFO,NLO,NRO,ISO,IBUFO(IOMAX)

	COMMON/FLDES/ NG,NA,NC,ND,NF,NL,NR,IS,IBUF(IOMAX)

	INTEGER*4, SAVE :: N,IP,NXFM,NSO,NPT,IORD

	REAL*4, SAVE :: PM,DT

	EQUIVALENCE (WORK,IBUFO(121)),(IX,X)
	
	character*128 ALINE
      COMMON /CPN/ CURPROCNAME
      CHARACTER*10 CURPROCNAME

C EQUIVALENCE ALLOWS 120 WORDS FOR NGO+NAO; WE DON'T CHECK

	IF(IFLAG1) 1,20,50

1     NFO=3
      CURPROCNAME='MODPOW'
      WRITE(*,*) CURPROCNAME
C MOVE CHANNEL LABELS

	J=6*NGO+109

	DO 2 I=1,NCO

	L=J+5

	K=6*(NG+ICHAN(I))-5

	DO 4 I1=J,L

	IBUFO(I1)=IBUF(K)

4     K=K+1

2     J=J+6

      FNYQ=FLOAT(IS)/2.
      CALL DoMODPOWDialog(IORD,IP,FMAX,FNYQ,K)

!	WRITE(*,100)
!
!100   FORMAT('$  MODPSP ORDER SELECTION: 1=FIXED/2=AIC/3=YTC>'\)
!
!	READ(*,*)IORD

	GO TO (5,6,6)IORD

5     CONTINUE
!      WRITE(*,101)
!
!101   FORMAT('$  ORDER(.LE.100)? >'\)
!
!	READ(*,*)IP

	GO TO 7

6     IP=100   ! QUICK FIX FOR AUTO ORDER SELECTION

7     FNYQ=FLOAT(IS)/2.

!	WRITE(*,300)FNYQ
!
!300   FORMAT('$  INTEGER FREQUENCY CUTOFF(.LE.',F6.0,') >'\)
!
!	READ(*,301)FMAX
!
!301   FORMAT(F8.0)

	IF(FMAX.EQ.0.)FMAX=FNYQ

	ISO=FMAX

	N=NDO   ! # SELECTED INPUT POINTS

3     CONTINUE
!      WRITE(*,200)
!
!200   FORMAT('$  MODPOW FFT SIZE:1=512/2=1024/3=2048/4=4096/5=8192 >'\)
!
!	READ(*,201)K
!
!201   FORMAT(I1)

	IF(K.LT.1 .OR. K.GT.5) GO TO 3

	NXFM=2**(K+8)

	AN=NXFM/2

	DF=FNYQ/AN      

	DT=1.0/FLOAT(IS)  ! NEEDED FOR NORMALIZATION OF SPECTRUM

	NPT=FMAX/DF+1   

	NDO=NPT

	NSO=NGO+NAO+1

	ISZ=120 + NDO  ! WORST-CASE POSSIBILITY

	RETURN

C RUNNING SECTION- COPY INPUT DATA TO WORK AREA IN REAL FORMAT

20    DO 25 I=1,N

	CALL XVAL(I,XV,XI)

25    WORK(I)=XV

C DATA IN; DETREND IT

	CALL DETRND(WORK,N,2)

C GET AR COEFFICIENTS USING MARPLE'S MODCOVAR ROUTINE

	IP1=IP

	CALL MODCOV(N,IP1,WORK,PM,COF,ISTAT,IORD)

C     WRITE(*,*)(COF(I),I=1,IP1)

C CHECK FOR NUMERICAL INSTABILITY IN AR MODELING STEP
	IF(ISTAT.EQ.0) GO TO 15

!	WRITE(*,202)KNT
!
202   FORMAT(' ! UNSTABLE AT RECSET ',I4,', CHANNEL',I4)
11    WRITE(ALINE,202)KNT,ICHAN(IBUFO(1))
      !CALL ShowInfoText('Error',ALINE)
      WRITE(*,*)ALINE
C ASSEMBLE AND WRITE NULL RECORD
      DO 12,I=NSO,NSO+NPT
      IBUFO(I)=0
12    CONTINUE
      GO TO 40
C CALCULATE NORMAL SPECTRUM VIA FFT OF COEFFICIENTS      

15    WORK(1)=1.0

	DO 26 I=1,IP1

26    WORK(I+1)=COF(I)

	DO 27 I=IP1+2,NXFM

27    WORK(I)=0.

	CALL FAST(WORK,NXFM)

	J=1

	K=NSO

	FACT=PM*DT

	DO 30 I=1,NPT

	X=FACT/(WORK(J)**2+WORK(J+1)**2)
	IF(X .LE. 0.0) GO TO 11 ! SOLUTION NUMERICALLY UNRELIABLE

	IBUFO(K)=IX

	K=K+1

	J=J+2

30    CONTINUE

40	CALL PUTSTD(IBUFO)

50    RETURN

	END



