C XHIST.FOR- CONSTRUCTS CROSS-HISTOGRAMS, FOR EACH LEVEL OF A SPECIFIED

C GROUP-VARIABLE, AND FOR EACH OF A SET OF UP TO 25 DATA VARIABLES

C SPECIFIED FROM KEYBOARD AS A BLOCK AVERAGE OF INPUT DATA POINTS. INPUT

C GROUP LEVELS CAN BE REASSIGNED ARBITRARILY TO (MAX 10) ANALYSIS LEVELS.

C MAXIMUM # OF XHIST BINS IS 50. SCALING IS FIRST DETERMINED FROM DATA

C VALUES, SEPARATELY FOR EACH XHIST VAR ACROSS LEVELS AND WITHIN CHANNELS,

C BUT USER CAN OVERRIDE. USER MUST SUPPLY N'S FOR THE GROUP-LEVELS; IF

C THESE ARE NOT ALREADY KNOWN, THEY CAN BE OBTAINED BY RUNNING GRPNS.

C PRINT OUTPUT IS AUTOMATIC, AND A STANDARD FILE CAN ALSO BE WRITTEN

C FOR SUBSEQUENT PLOTTING. THE OUTPUT FILE CONTAINS ONE RECORD PER 

C CHANNEL. THE GROUP-LEVEL N'S ARE APPENDED TO ANY OTHER GROUP/ANCILLARY

C WORDS; THEN COME THE HISTOGRAMS- GRP-LVL 1 VAR 1...GRP-LVL 1 VAR N,

C GRP-LVL 2 VAR 1...GRP-LVL K VAR N.

	SUBROUTINE XHIST

      INCLUDE 'MAX.INC'

	CHARACTER*64 INPFIL

	COMMON IFLAG1,IFLAG2,IFLAG3,KNT,ISZ,ICHAN(ICHMAX)

	COMMON/FLDES/NG,NA,NC,ND,NF,NP,NR,IS,IBUF(IOMAX)

	COMMON/FLDESO/NGO,NAO,NCO,NDO,NFO,NPO,NRO,ISO,IBUFO(IOMAX)

!	COMMON/DEV/ITI,IOX
	COMMON/DEV/ ITI,ILP,IGRAPH,IOX

	COMMON/STDFIL/INPFIL

	DIMENSION ICNT(50),NLIST(25,2),LBLS(6,20),INDEX(10)

	DIMENSION INNS(10),NGRPNS(10),IGRP(20),IGLAB(5),NUMBS(10)

	DIMENSION ICLABS(6,8),ICLAB(48)

	EQUIVALENCE (LBLS(1,1),IBUF(1)),(ICLABS(1,1),ICLAB(1))

	EQUIVALENCE (X,IX)

	DATA ISL,IYES/'/','Y'/

	DATA IGLAB/'   ','NUMB','ER F','OR G','ROUP '/

	DATA NUMBS/'1 ','2 ','3 ','4 ','5 ','6 ','7 ','8 ','9 ','10'/
	
	logical LWSO
      COMMON /CPN/ CURPROCNAME
      CHARACTER*10 CURPROCNAME
      CHARACTER*1024 OUTNAME
      CHARACTER*1024 OUTFNM
      
      SAVE ichoff,idgrp,nin,nso,iblkf,nvar,nlevl,nbin,lwso,ngo1

	IF(IFLAG1)10,30,50

10    CURPROCNAME='XHIST'
      WRITE(*,*) CURPROCNAME
      OUTNAME=OUTFNM(CURPROCNAME)
      LTRO=LEN_TRIM(OUTNAME)
      OUTNAME(LTRO-2:LTRO)='txt'
      OPEN(UNIT=IOX,FILE=OUTNAME,MODE='WRITE')
      
	IF(NG-1)1,1,2

1       WRITE(*,200)

200     FORMAT(' NO GROUPS AVAILABLE; EXITING')

	KNT=-1

	RETURN

2     CONTINUE
      CALL DoXHISTDialog(IDGRP,NIN,IRCOD,NLEVL,NBIN,NVAR,IT,LWSO,
     +                         INNS,NLIST)
  
!      WRITE(*,201)(J,(LBLS(I,J),I=1,6),J=2,NG)
!
!201     FORMAT(' GROUP VAR ',I2,' ID=',6A4)
!
!	WRITE(*,202)
!
!202     FORMAT('$ANALYSIS GROUP? # INPUT LEVELS? >'\)
!
!	READ(*,*)IDGRP,NIN
!
!100     FORMAT(1XI2,2XI2)

7     CONTINUE  
!      WRITE(*,203)(ISL,I=1,NIN)
!
!203     FORMAT(' REGROUPING EQUIVALENCES(<CR> TO SKIP):'/' /',20(2XA1))
!
!	READ(*,101)IRCOD,(IGRP(I),I=1,NIN)
!
!101     FORMAT(1XI2,T1,20(1XI2))

	IF(IRCOD)21,21,22

21      NLEVL=NIN

	DO 3 I=1,NLEVL

3       IGRP(I)=I

	GO TO 4

22      NLEVL=1

	DO 23 I=1,NLEVL

	IF(IGRP(I).EQ.0)GO TO 4

	IF(IGRP(I).GT.NLEVL)NLEVL=IGRP(I)

23      CONTINUE

4       IF(NLEVL-10)6,6,5

5     CONTINUE  
!      WRITE(*,300)
!
!300     FORMAT(' TOO MANY LEVELS REQUESTED; MAX=10')
      CALL ShowInfoText('Error','TOO MANY LEVELS REQUESTED; MAX=10')

	GO TO 7

6     CONTINUE  
!      DO 8 I=1,NLEVL
!
!	WRITE(*,204)I
!
!204     FORMAT('$TOTAL N FOR OUTPUT GROUP-LEVEL ',I2,'? >'\)
!
!8       READ(*,*)INNS(I)
!
!102     FORMAT(1XI3)
!
!	WRITE(*,205)
!
!205     FORMAT('$NUMBER OF XHIST VARS (MAX=25)? >'\)
!
!	READ(*,*)NVAR
!
!	WRITE(*,2050)NDO
!
!2050    FORMAT(' NUMBER OF DATA PTS AVAILABLE FOR XHIST =',I4)
!
!	DO 9 I=1,NVAR
!
!	WRITE(*,206)I
!
!206     FORMAT('$FIRST INPUT PT, # PTS FOR XHIST VAR ',I2,'? >'\)
!
!9       READ(*,*)(NLIST(I,J),J=1,2)
!
!	WRITE(*,207)
!
!207     FORMAT('$DATA XFORM:0=NONE/1=SQRT/2=LN/3=ARCSIN/4=ABS >'\)
!
!	READ(*,104)IT
!
!104     FORMAT(I1)

	IT=IT+1

!	WRITE(*,2071)
!
!2071    FORMAT('$NUMBER OF XHIST BINS(<=50)? >'\)
!
!	READ(*,*)NBIN

C CHECK SIZES AND INITIALIZE STRUCTURE OF STORAGE SCHEME

	NGO1=NGO

	NGO=NGO+NLEVL

	NDO=NLEVL*NVAR*NBIN

	NFO=1

	NPO=NGO+NAO+NDO

	ICHOFF=0

	IBLKF=NVAR*NLEVL*NR

	ISZ=IBLKF*NCO+NGO+NAO

12      NSO=NGO+NAO+1

	INDEX(1)=0

	NGRPNS(1)=0

	IF(NLEVL-2)122,121,121

C GET OFFSETS FROM NSO TO FIRST WORD OF EACH GROUP-LEVEL'S DATA AREA

121     DO 14 I=2,NLEVL

	NGRPNS(I)=0

14      INDEX(I)=INDEX(I-1)+NVAR*(INNS(I-1))

122     WRITE(IOX,500)IDGRP,INPFIL

500     FORMAT(' XHIST ANALYSIS OF GROUP VAR ',I2,' FROM FILE ',A//)

	WRITE(IOX,5000)(IBUFO(I),I=1,108)

5000    FORMAT(1H ,18A4)

	WRITE(IOX,700)IDGRP,(LBLS(I,IDGRP),I=1,6)

700     FORMAT(/' GROUP VAR ',I2,' ID=',6A4)

	WRITE(IOX,501)(I,I=1,NIN)

501     FORMAT(//' INPUT GROUP LEVELS:',20I3)

	WRITE(IOX,502)(IGRP(I),I=1,NIN)

502     FORMAT(' OUTPUT EQUIVALENTS:',20I3//)

!	WRITE(*,208)
!
!208     FORMAT('$WANT TO WRITE OUTPUT FILE? >'\)
!
!	READ(*,105)IANS
!
!105     FORMAT(A1)
!
!	IF(IANS-IYES)15,16,15
      IF(LWSO)GOTO 16

15      IFLAG3=0

	GO TO 25

C SET UP LABELS ETC

16      J=109+6*NGO1

	DO 18 I=1,NLEVL

	DO 17 K=1,5

	IBUFO(J)=IGLAB(K)

17      J=J+1

	IBUFO(J)=NUMBS(I)

18      J=J+1

	M=1

	DO 20 I=1,NCO

	L=J+5

	K=6*(NG+ICHAN(I))-5

	DO 19 I1=J,L

	IBUFO(I1)=IBUF(K)

	ICLAB(M)=IBUF(K)

	M=M+1

19      K=K+1

20      J=J+6

	ISO=1   !FUDGE TO LET GRPLOT SCALE THE ABSCISSA CORRECTLY

25      RETURN

30      IF(ICHOFF.GT.0)GO TO 35

C ON FIRST ENTRY FOR A RECORD-SET, CHECK GROUP-VAR VALUE & SET INDEXES

	IVAL=IBUF(IDGRP)

	IF(IVAL)31,31,32

31      WRITE(*,503)KNT,IVAL

	WRITE(IOX,503)KNT,IVAL

503     FORMAT(' RECORD-SET ',I4,' CONTAINS WILD GRP-VAR VALUE=',I2)

	GO TO 45

32      IF(IVAL-NIN)33,33,31

33      NGRP=IGRP(IVAL)

	NGRPNS(NGRP)=NGRPNS(NGRP)+1

	J0=NSO+INDEX(NGRP)+(NGRPNS(NGRP)-1)

	IVEC=INNS(NGRP)

C GET XHIST VALUES AND STORE THEM IN IBUFO AT RIGHT SPOTS

35      J1=J0+ICHOFF*IBLKF

	DO 40 I=1,NVAR

	X=0.0

	K=NLIST(I,1)

	L=NLIST(I,2)

	DO 38 J=1,L

	CALL XVAL(K,XV,XI)

	X=X+RECODE(XV,IT)

38      K=K+1

	X=X/FLOAT(L)

	IBUFO(J1)=IX

40      J1=J1+IVEC

41      ICHOFF=ICHOFF+1

	IF(ICHOFF-NCO)45,44,44

44      ICHOFF=0

45      RETURN

C ALL VALUES STASHED- NOW CONSTRUCT XHISTS IN IBUF

C FIRST CHECK THAT GROUP-LEVEL N'S INPUT AND FOUND ARE EQUAL,

C AND IF YES AND IFLAG3 SET MOVE OLD GROUP/ANC WORDS + N'S INTO IBUF

50      IERR=0

	DO 52 I=1,NLEVL

	IF(INNS(I)-NGRPNS(I))51,52,51

51      IERR=1

52      WRITE(IOX,302)I,INNS(I),NGRPNS(I)

	IF(IERR)48,48,49

49      WRITE(*,302)(J,INNS(J),NGRPNS(J),J=1,NLEVL)

302     FORMAT(' LEVEL ',I2,' INPUT N=',I3,'; FOUND N=',I3)

!	WRITE(*,303)
!
!303     FORMAT(' ANALYSIS ABORTED; RETURNING')
      CALL ShowInfoText('Error','ANALYSIS ABORTED; RETURNING')

C        IF(IFLAG3.GT.0)CALL PUTDEL       ! ADD TO STDIO?

	CLOSE(UNIT=IOX)

	KNT=-1

	RETURN

48      IF(IFLAG3)56,56,53

53      DO 54 I=1,NGO1

54      IBUF(I)=IBUFO(I)

	I=NGO1+1

	DO 55 J=1,NLEVL

	IBUF(I)=NGRPNS(J)

55      I=I+1

	IF(NAO)56,56,550

550     NSO1=NSO-1

	DO 551 I1=I,NSO1

551     IBUF(I1)=IBUFO(I1)

C HERE STARTS XHISTING CODE

56      IXBLK=NVAR*NBIN

	DO 90 K=1,NCO

	WRITE(IOX,504)ICHAN(K),(ICLABS(I,K),I=1,6)

504     FORMAT(///'  ANALYSIS OF CHANNEL ',I2,', ID=',6A4)

	J0=NSO+(K-1)*IBLKF

	DO 80 I=1,NVAR

	IVAL2=NLIST(I,1)+NLIST(I,2)-1

	WRITE(IOX,505)I,NLIST(I,1),IVAL2

505     FORMAT(/3X,'XHIST VAR ',I2,', MEAN OF INPUT VARS ',I4,' TO ',I4)

C GET MIN & MAX FOR ALL VALUES OF THIS VAR, THIS CHANNEL

	I1=0

	DO 60 J=1,NLEVL

	J2=J0+INDEX(J)+(I-1)*NGRPNS(J)

C J2 IS FIRST WORD FOR FIRST POINT OF THIS LEVEL THIS VAR & THIS CHANNEL

	J3=J2+NGRPNS(J)-1

	DO 58 JJ=J2,J3,2

	IX=IBUFO(JJ)

	IF(I1)57,57,59

57      I1=1

	AMAX=X

	AMIN=X

	GO TO 58

59      IF(X-AMIN)61,58,62

61      AMIN=X

	GO TO 58

62      IF(X-AMAX)58,58,63

63      AMAX=X

58      CONTINUE

60      CONTINUE

!	WRITE(*,209)ICHAN(K),I,AMIN,AMAX
!
!209     FORMAT(/'  CHANNEL ',I2,' VAR ',I2/'  MIN=',E12.4,',MAX=',E12.4)
!
!	WRITE(*,210)
!
!210     FORMAT('$  ENTER DIFFERENT VALUES(Y/N)? >'\)
!
!	READ(*,105)IANS
!
!	IF(IANS-IYES)65,64,65
!
!64      WRITE(*,211)
!
!211     FORMAT('$  ENTER NEW MIN, MAX >'\)
!
!	READ(*,*)AMIN,AMAX
!
!106     FORMAT(1XF15.0,2XF15.0)
      CALL DoXHIST2Dialog(AMIN,AMAX,ICHAN(K),I)

65      SCL=FLOAT(NBIN)/(AMAX-AMIN)

	SCL1=SCL*AMIN

	WRITE(IOX,800)AMIN,AMAX

800     FORMAT(/'   FOR SCALING, MIN=',E12.4,' AND MAX=',E12.4/)

C NOW CONSTRUCT XHISTS FOR SUCCESSIVE GROUP-LEVELS OF THIS VAR, IN IBUF

	WRITE(IOX,506)(L,L=1,NLEVL)

506     FORMAT(6X,'LEVEL #:',10(4XI2)/)

	L0=NSO+(I-1)*NBIN

	DO 75 J=1,NLEVL

	DO 66 L=1,NBIN

66      ICNT(L)=0

	J2=J0+INDEX(J)+(I-1)*NGRPNS(J)

	J3=J2+NGRPNS(J)-1

	DO 70 JJ=J2,J3,2

	IX=IBUFO(JJ)

	L=SCL*X-SCL1+1

	IF(L.GT.NBIN)L=NBIN

70      ICNT(L)=ICNT(L)+1

C XHIST BUILT FOR THIS LEVEL THIS VAR; STORE IT

	L1=L0

	DO 72 L=1,NBIN

	IBUF(L1)=ICNT(L)

72      L1=L1+1

75      L0=L0+IXBLK

C ALL XHISTS FOR THIS VAR BUILT AND STORED; WRITE THEM TO PRINT FILE

	L0=NSO+(I-1)*NBIN

	DO 79 J=1,NBIN

	L1=L0+J-1

79      WRITE(IOX,507)J,(IBUF(L),L=L1,NPO,IXBLK)

507     FORMAT('  XHIST BIN ',I2,10(2XI4))

80      CONTINUE

C WHEN ALL VARS FINISHED FOR THIS CHANNEL, WRITE OUTPUT RECORD

	IF(IFLAG3)90,90,85

85      IBUF(1)=K

	CALL PUTSTD(IBUF)

90      CONTINUE

	WRITE(IOX,600)

600     FORMAT(//' END OF OUTPUT')

	CLOSE(UNIT=IOX)

	RETURN

	END



