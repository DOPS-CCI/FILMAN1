C AUTOFILT.FOR- SPECTR ROUTINE TO ANALYZE STIMULUS-PERIOD DATA ITERATIVELY      

C BY CALCULATING AR MODEL, USING IT TO FILTER THE RECORD, AND ANALYZING

C THE RESIDUALS, ... DERIVED FROM MODPS2 11/92.

	SUBROUTINE AUTOFILT

	COMMON IFLAG1

	COMMON/FLDES/ID(8),IBUF(1)

c	COMMON/FLDESO/IDO(8),WORK(1)
	COMMON/FLDESO/IDO(8),WORK

	COMMON/DEV/ITI,ILP

	COMMON/PTLST/NLIST,LIST(2,72),NP1,NP2,NPTOT,PF1,PFT

	DIMENSION WK1(2050),WK2(2050),A(100),B(100)

	DIMENSION SAVE(100)  !LAST POINTS OF FIRST PART, TO START FILTER

	CHARACTER*8 PTIT

	EQUIVALENCE (WK1(1),WORK(1)),(WORK(2051),WK2(1))
	
	dimension work(2051)          ! Maciek

1000    WRITE(ITI,1001)

1001    FORMAT('   AUTOFILT: FIRST IDENTIFY ANALYSIS SEGMENT')

	CALL PTSEL

	NITER=1

1       WRITE(ITI,100)

100     FORMAT('   ORDER SELECTION: 1=MANUAL/2=AIC/3=YTC >'\)

	READ(ITI,*)IORD

C PLOT PARAMETERS

	IOFF=0

	FNYQ=FLOAT(ID(8))/2.

	DT=1.0/FLOAT(ID(8))

2       WRITE(ITI,300)FNYQ

300     FORMAT('$  FREQUENCY CUTOFF(.LE.',F5.1,') >'\)

	READ(ITI,301)FMAX

301     FORMAT(F8.0)

	IF(FMAX.EQ.0.)FMAX=FNYQ

3       WRITE(ITI,200)

200     FORMAT('$  AUTOFILT FFT SIZE:1=256/2=512/3=1024/4=2048 >'\)

	READ(ITI,201)K

201     FORMAT(BZ,I1)

	IF(K.LT.1 .OR. K.GT.4)GO TO 3

	NXFM=2**(K+7)

	AN=NXFM/2

	DF=FNYQ/AN      ! PARAMETERS FOR PLOT1-

	NPT0=FMAX/DF+1   ! INITIAL VALUES

C COPY SELECTED INPUT DATA TO WK2

	J=1

	DO 4 I=NP1,NP2

	WK2(J)=XVAL(I)

4       J=J+1

C ALSO SAVE LAST 100 VALUES OF PRESTIMULUS PART FOR STARTING FILTERS

	IF(NP1.GT.100) GO TO 5

	WRITE(ITI,'(A)')'  CURRENT VERSION NEEDS MIN 100 POINTS PRESTIM'

	GO TO 1000

5     DO 6 I=1,100

6     SAVE(I)=XVAL(NP1-I)     ! FIRST POINT IS NEWEST

10       NXEQ=0

	X1=0.       ! START PLOTS INCLUDING DC TERM

	NPT=NPT0    !     AND WHOLE SPECTRUM

	N=NPTOT     ! # TIME POINTS TO PROCESS

	ASSIGN 90 TO LOC

	IF(IORD.EQ.1)GO TO 8

	M1=100      !DUMMY VALUE TO PERMIT AUTO ORDER SELECTION

	M2=100

	M3=1

	GO TO 11

8      WRITE(ITI,101)NITER

101     FORMAT('$   STEP',I2,': 1ST, LAST ORDER(<100), STEPSIZE? >'\)

	READ(ITI,*)M1,M2,M3

	IF(M3.EQ.0)M3=1

11    IKP=0

	WRITE(ITI,199)

199   FORMAT('$  RECALL PREVIOUS PLOT? >'\)

	READ(ITI,401)IA

	IF(IA.EQ.'Y')IKP=1

	DO 90 M=M1,M2,M3

	NXEQ=NXEQ+2

C GET AR COEFFICIENTS USING MARPLE'S MODCOVAR ROUTINE

19    CALL MODCOV(N,M,WK2,PM,B,ISTAT,IORD)

	IF(ISTAT.EQ.0)GO TO 21

	WRITE(ITI,202)M

202     FORMAT('   ! UNSTABLE AT ORDER',I3,'; SKIPPING SPECTRUM')

	GO TO LOC

21    MLAST=M     ! CURRENT/FINAL MODEL ORDER

	AN=NPTOT

	AM=MLAST+1

	FPE=PM*(AN+AM)/(AN-AM)

	IF(PM.LT.1.0)PM=1.0

	AIC=AN*ALOG(PM)+2.0*(AM-1.0)

C FPE AND AIC ARE AKAIKE'S ORDER-SELECTION CRITERIA

	WRITE(ITI,102)NITER,MLAST

102     FORMAT('    RESULTS FOR ITERATION ',I3,', ORDER',I3,':')

	WRITE(ITI,103)PM,FPE,AIC

103     FORMAT('    PM=',F10.2,'; FPE=',F8.2,'; AIC=',F8.2)

	WRITE(ITI,104)(B(I),I=1,MLAST)

104     FORMAT('     ',10F7.3)

C CALCULATE SPECTRUM VIA FFT OF COEFFICIENTS

	WORK(1)=1.0

	DO 20 I=1,MLAST

20      WORK(I+1)=B(I)

	DO 25 I=M+2,NXFM

25      WORK(I)=0.

	CALL FAST(WORK,NXFM)

	J=1

	FACT=PM*DT

	DO 30 I=1,NPT0

	WORK(I)=FACT/(WORK(J)**2+WORK(J+1)**2)

	J=J+2

30      CONTINUE

	WRITE(PTIT,800)NITER,MLAST

800   FORMAT('AUTO:',I1,I2)

	WRITE(ITI,400)

400     FORMAT('$  SPECTRUM READY; <CR> TO PROCEED'\)

	READ(ITI,401)

401     FORMAT(A1)

D       WRITE(ITI,*)IP1,IP2,IP3,FP1,FP2,,FP3,IP4

	  CALL PLOT1(2,NPT,X1,DF,PTIT,IKP,NXEQ,IOFF)

	  IKP=1

	GO TO LOC

90      CONTINUE

95      WRITE(ITI,203)

203     FORMAT('$  AUTOFILT:0=PROCEED/1=FREQS/2=MODEL/3=POINTS/4=RET>'\)

	READ(ITI,204)IGO

204     FORMAT(I1)

	GO TO (50,2,8,1000,96) IGO+1

50      WRITE(ITI,205)

205   FORMAT('$  NEXT:1=FILTER AND MODEL/2=CSA >'\)

	READ(ITI,204)IGO

	GO TO(51,75)IGO

C SET UP FOR NEXT ITERATION

51    NITER=NITER+1      

	DO 55 I=1,MLAST

55      A(I)=B(I)

	WRITE(ITI,500)NITER

500     FORMAT('   BEGINNING ITERATION',I3)

C ADD LAST MLAST POINTS OF PRESTIMULUS PART TO BEGINNING OF ANALYSIS

C SEGMENT

	DO 14 I=NPTOT,1,-1

14    WK2(I+MLAST)=WK2(I)   

	DO 15 I=1,MLAST

15    WK2(MLAST-I+1)=SAVE(I)

C NOW THE FILTER

	DO 18 I=1,NPTOT

	J=I+MLAST

	SUM=WK2(J)       ! ORIGINAL VALUE

	DO 17 K=1,MLAST   ! ORDER OF CURRENT MODEL

17    SUM=SUM+A(K)*WK2(J-K)

18    WK2(I)=SUM       ! FILTERED VALUE

	WRITE(PTIT,901)NITER

901     FORMAT('FILTER',I2)

	IKP=0

	WRITE(ITI,903)

903     FORMAT('    PLOT FILTERED DATA? >'\)

	READ(ITI,401)IA

	IF(IA.NE.'Y')GO TO 10

C COPY FILTERED DATA TO WK1 FOR PLOT

	DO 70 I=1,NPTOT

70      WK1(I)=WK2(I)

	CALL PLOT1(1,NPTOT,PF1+DT,DT,PTIT,IKP,0,0)    

C GO TO MODELING SECTION

	GO TO 10

C SECTION TO GENERATE CSA'S FROM SUCCESSIVE OVERLAPPED SUBPARTS

C OF FILTERED DATA AT EACH ITERATION

76      WRITE(ITI,501)

501     FORMAT('$   WANT TO GENERATE ANOTHER CSA? >'\)

	READ(ITI,401)IA

	IF(IA.NE.'Y')GO TO 95

75    ASSIGN 85 TO LOC

	WRITE(ITI,502)

502     FORMAT('$   SUBSEGMENT LENGTH, SHIFT IN #PTS, MODEL ORDER >'\)

	READ(ITI,*)NX,ISHFT,M

	NPLT=(NPTOT-NX)/ISHFT+1    ! TOTAL # PLOTS

	IOFF0=150./FLOAT(NPLT)  ! OFFSET OF JPL FOR SUCCESSIVE PLOTS

	IOFF=0

	IF(IOFF.LT.4)IOFF=4

	NX1=1

	N=NX

	ISEG=1      ! COUNTER FOR SEGMENTS PLOTTED

	NXEQ=0      ! CHECK THIS

	IKP=0

	WRITE(PTIT,904)NX,ISHFT,M

904     FORMAT(I3,I2,'M',I2)

80      J=1

	DO 81 I=NX1,NX1+N-1

	WK1(J)=WK2(I)

81      J=J+1

	CALL MODCOV(N,M,WK1,PM,B,ISTAT,1)

	GOTO 21     ! (TO CALCULATE & PLOT SPECTRUM)

85      IF(ISEG-NPLT)86,87,87

86      WRITE(ITI,504)

504     FORMAT('$    CONTINUE STEPPING? >'\)

	READ(ITI,401)IA

	IF(IA.EQ.'N')GO TO 76

	IKP=1

	NX1=NX1+ISHFT

	IOFF=IOFF+IOFF0

	NXEQ=NXEQ+2

	ISEG=ISEG+1

	GO TO 80

87    WRITE(ITI,871)

871   FORMAT('$    CSA FINISHED; <CR> TO RECALL IT:'\)

	READ(ITI,201)IA

	CALL PLOT1(2,NPT,X1,DF,PTIT,IKP,NXEQ,IOFF)

	GO TO 76

96      RETURN

	END



