C PLOT.FOR- GENERAL PURPOSE PLOTTING ROUTINE FOR FILMAN. INITIALLY

C MODIFIED 10/91 TO ABSORB AXIS LABELING AND OTHER IMPROVEMENTS FROM

C SPECTR. CONVERTED TO MICROSOFT FORTRAN/GRAPHICS 10/92. COULD BE 

C GENERALIZED TO IDENTIFY VIDEO CONFIGURATION & CALCULATE ALL NECESSARY

C PLOT PARAMETERS, FOR PORTABILITY. MODIFIED 7/93 TO ADD MULTICHANNEL

C CAPABILITY. STILL NEEDS VERTICAL LABELS, BETTER TREATMENT OF

C IMPLICIT DECIMATION WITH LONG RECORDS AND/OR MULTICHANNEL PLOTS,

C AND POSSIBLY SCROLLING MULTICHANNEL DISPLAY OF LONG DATA RECORDS.

	SUBROUTINE PLOT

	USE IFQWIN
	USE IFCORE

	INCLUDE 'MAX.INC'



C BASIC SCREEN DIMENSIONS FOR SELECTED VIDEO MODE; MUST BE DETERMINED

C INDIVIDUALLY FOR EACH COMPUTER

      PARAMETER (MARGIN=20)      

	INTEGER*2 ROWS   ! ROWS IS PARAMETER FOR SETVIDEOMODE

	CHARACTER*8 CLAB

	CHARACTER*15 RECSET

	CHARACTER*24 INPFIL,CTITLE,POINTS

	CHARACTER*24 CLABEL(ICHMAX),CTEMP     ! FOR PS VERSION

	CHARACTER*116 BLANKS

	CHARACTER*4 BLANK4(29)

	CHARACTER*1 IA

	INTEGER*2 IX0,IY0,IYOFF

	INTEGER*4, SAVE :: NRK,N1,NP1,NXEQ,ISF,MODE,INEXT,M,NCTP

	INTEGER*4, SAVE :: ICLABS(6,ICHMAX),ISTART(ICHMAX,2)

	RECORD/RCCOORD/ S

	RECORD/WINDOWCONFIG/ WC

	RECORD/QWINFO/ WINFO

	COMMON IFLAG1,IFLAG2,IFLAG3,KNT,ISZ,ICHAN(ICHMAX)

	COMMON/FLDES/ NG,NA,NC,NP,NF,NL,NR,IS,IBUF(IOMAX)

	COMMON/FLDESO/ NGO,NAO,NCO,NDO,NFO,NLO,NRO,ISO,IBUFO(IOMAX)

	COMMON/STDFIL/INPFIL

	COMMON/DEV/ITI,ILP,IGRAPH

	COMMON/PTLST/NLIST,LIST(2,72)

	COMMON/PLOTDATA/IPL,NPT,IT,XDIM,XSCALE,YDIM,YSCALE,X1,DX,

     1 JMP,ISCL,IAXIS,YMAX,YMIN,IX0,IY0,IYOFF,CLAB

	DIMENSION WORK(IOMAX-120)

	EQUIVALENCE (ICLABS,CLABEL),(WORK,IBUFO(121)),(BLANKS,BLANK4)

	DATA BLANK4/29*'    '/

	DATA ROWS /60/    ! CHANGE THIS IF TEXT AT TOP LOOKS WEIRD
	
	INTEGER*2 IXDIM,IYDIM

!	INTEGER*1, ALLOCATABLE:: SCREEN(:)
	integer*2 isx,isy
!	integer ScreenL,ScreenS
	type(windowconfig) :: wco
!	logical Ltemp
!	COMMON /GRABIMG/ SCREENL,SCREENS
      COMMON /IGHWND/ IGRAPHHWND,ISX,ISY
	
!	character*255 ALINE
!	character*4 ans
!	equivalence (ans,ia)
	character*1 key
	EXTERNAL WINVER
	INTEGER WINVER
      COMMON /CPN/ CURPROCNAME
      CHARACTER*10 CURPROCNAME
	
	save x0,iusrscly

!************************************************************************

	IF(IFLAG1) 10,20,3000

10    IFLAG3=0
      CURPROCNAME='PLOT'
      WRITE(*,*) CURPROCNAME
!     OPEN GRAPHICS WINDOW FOR PLOTTING

      OPEN(UNIT=IGRAPH,FILE='USER',TITLE='PLOT')
      
      igraphHwnd=GetHwndQQ(IGRAPH)

	CALL SETTEXTWINDOW(1,1,3,120)

      I=INITIALIZEFONTS()

	ISTAT=SETFONT("t'tms rmn'h18w9")

	I=SETBKCOLORRGB(Z'00FFFFFF')

	I=SETCOLORRGB(0)

	I=SETTEXTCOLORRGB(0)

	WINFO%TYPE=QWIN$MAX

	I=SETWSIZEQQ(IGRAPH,WINFO)

      IF(WINVER().GE.7)THEN
        CALL MGetWindowSize(igraphHwnd,IW1,IH1)
        isx=IW1-32
        isy=IH1-64
      ELSE
        !I=GETWSIZEQQ(IGRAPH,QWIN$SIZEMAX,WINFO)
        !isx=WINFO%X
        !isy=WINFO%Y
        Ltemp=GETWINDOWCONFIG(wco)
        isx=wco%numxpixels
        isy=wco%numypixels
      ENDIF
	
	I=FOCUSQQ(5)  !SEND FOCUS BACK TO CONSOLE WINDOW

!	IXDIM=9*WINFO%W   !CALCULATE MAXIMUM WINDOW SIZE
!
!	IYDIM=18*WINFO%H
!
!      isx=IXDIM
!      isy=IYDIM
      IXDIM=isx
      IYDIM=isy
      

!	WRITE(*,*) IXDIM,IYDIM

	IX0=MARGIN+1

	IY0=IYDIM-MARGIN-1

	ISF=0

	NRK=0

	NXEQ=0

	ISZ=0

	N1=1              ! FIRST LIST POINT

	NP1=LIST(1,1)     ! CORRESPONDING DATA POINT

	NPT=NDO

	INEXT=0

	IT=1

	NCTP=NCO                            ! TOTAL CHANS TO PLOT

	M=1                                 ! CURRENT-CHANNEL POINTER

	MODE=1                              ! FULL-SCREEN/SINGLE

	IYOFF=0                              ! OFFSET FOR CSA'S

	CLAB='       '
	
	iusrscly=0

C GET CHANNEL LABELS

	DO 15 I=1,NCO

	K=6*(NG+ICHAN(I))-5

	DO 15 J=1,6

	ICLABS(J,I)=IBUF(K)

15    K=K+1

	NRS=NR/NC

      CALL DoPlotTypeDialog(ISUPRE,ISUPCH,IPMOD,IPTYP,NRS.LE.1,NCO.EQ.1)

!	IF(NRS.LE.1) GO TO 145
!
!      WRITE(*,200)
!
!200   FORMAT('SUPERIMPOSE RECORDSETS? >'\)
!
!C	READ(*,103)IA
!      CALL GETVALU(2,IVAL,ANS,'(A)')
!      WRITE(*,'(A)')ANS
!
!103   FORMAT(A1)
!
!	IF(IA.NE.'Y' .AND. IA.NE.'y') GO TO 145
      
      IF(ISUPRE.EQ.1)GOTO 145

11    ISF=1

	WRITE(RECSET,'(A)') '(SUPERIMPOSED)'

14    IF(NCO.EQ.1) GO TO 12

	MODE=2

	GO TO 17

145   IF(NCO.EQ.1) GO TO 12

!	WRITE(*,100)
!
!100   FORMAT('SUPERIMPOSE CHANNELS? >'\)
!
!C	READ(*,103) IA
!      CALL GETVALU(2,IVAL,ANS,'(A)')
!      WRITE(*,'(A)')ANS
!
!	IF(IA.NE.'Y' .AND. IA.NE.'y') GO TO 16
      
      IF(ISUPCH.EQ.1)GOTO 16

	ISF=2

	WRITE(CTITLE,'(A)') '(CHANNELS SUPERIMPOSED)'

	GO TO 12

16    CONTINUE
!      WRITE(*,101)
!
!101   FORMAT('PLOT MODE:1=SINGLE/2=MULTICHANNEL >'\)
!
!C	READ(*,*)MODE
!	MODE=IGETVALU('(I1)')
!	WRITE(*,'(I1)')MODE
      
      MODE=IPMOD

	IF(MODE.EQ.1) GO TO 12

17    WRITE(CTITLE,'(A)') '(MULTICHANNEL PLOT)'

!     SET UP GRAPHICS WINDOW AND ESTABLISH MAXIMUM SIZE

12	CONTINUE
!      WRITE(*,102)
!
!102   FORMAT('PLOT TYPE:1=TIME/2=SPECTRUM/3=CHANGE-SPECTRUM? >'\)
!
!C	READ(*,204) IPL
!	IPL=IGETVALU('(I1)')
!	WRITE(*,'(I1)')IPL
!
!204   FORMAT(I1)
!
      IPL=IPTYP
      
      

      CALL SETUP(IXDIM,IYDIM,MARGIN,CLABEL,NCO,MODE,ISTART,XDIM,YDIM)

      

      XSCALE=XDIM/FLOAT(NPT-1)   ! # PIXELS/DX, EXACT

	IF(IPL.EQ.2) GO TO 55

50    YDIM=YDIM/2.0

	IF(IPL.EQ.3)GO TO 55

	DX=1.0/FLOAT(IS)

	X0=DX*FLOAT(LIST(1,1))

	GO TO 551

55    DX=FLOAT(IS)/FLOAT(NP-1)  ! NEED TO ALLOW FOR DC TERM IN SPECTRA

	X0=DX*FLOAT(LIST(1,1)-1)  ! ACTUAL VALUE IN XSCALE UNITS AT PT 1

551	X1=X0

	JMP=1       ! ON FIRST ENTRY PLOT ALL POINTS

	RETURN

	

C EXECUTION PHASE CODE STARTS HERE; FIRST CHECK FOR NEW RECSET

20    I=FOCUSQQ(IGRAPH)

      IF(KNT-NRK)90,2002,2001  

2001  NRK=KNT

	IF(NXEQ)30,30,35

C VERY FIRST SELECTED RECSET; ESTABLISH DESIRED PLOT REGIME

30    CALL CLEARSCREEN(0)

C FIND INITIAL VERTICAL SCALE

      if(iusrscly.ne.0)goto 561

      CALL XVAL(1,XV,XI)

	YMIN=RECODE(XV,IT)

	YMAX=ABS(YMIN)

	DO 56 I=N1,N1+NPT-1

	CALL XVAL(I,XV,XI)

	VAL=RECODE(XV,IT)

	IF(ABS(VAL).GT.YMAX)YMAX=ABS(VAL)

	IF(VAL.LT.YMIN)YMIN=VAL

56    CONTINUE

	IF(IPL.NE.2) YMIN=0.     ! FORCES SPECTRAL PLOTS TO START AT 0 AMP, TOO

561	YMAX0=YMAX   ! SAVE FOR LATER SCALE FIDDLING

      YSCALE=YDIM/(YMAX-YMIN)

	IAXIS=1     ! GENERATE AXES

	M=1         ! FIRST CHANNEL

	ISCL=0      ! DON'T SCALE THE DATA

	GO TO 22

C NEW RECSET AFTER PLOT REGIME ACCEPTED

35    M=1

	IF(ISF.NE.1) CALL CLEARSCREEN(0)

	IF(ISF.EQ.1) IAXIS=0

	GO TO 22

C NEW CHANNEL, SAME RECORDSET

2002  IF(MODE.EQ.1 .AND. ISF.NE.2)CALL CLEARSCREEN(0)

22    IX0=ISTART(M,1)

	IY0=ISTART(M,2)

	K=1

	DO 221 I=N1,N1+NPT-1       ! DON'T USE JMP HERE

	CALL XVAL(I,XV,XI)

	WORK(K)=RECODE(XV,IT)

221   K=K+1

	IF(MODE.NE.2)GO TO 222

	CTEMP=CLABEL(M)

	CLAB=CTEMP(1:8)

222   CALL PLOTCHAN

C KEY CONTROL SECTION HERE!

	IF(NXEQ)71,71,41

41    IF(MODE.EQ.2 .OR. ISF.EQ.2)GO TO 42

	GO TO(71,90)ISF+1

42    M=M+1

	IF(M-NCTP)90,90,71

C LABEL PLOT WITH FILENAME, RECSET NUMBER, ETC

71    CALL SETTEXTPOSITION(2,3,S)

	CALL OUTTEXT('FILE:'//TRIM(INPFIL))

	IF(ISF.EQ.1)GO TO 721

      WRITE(RECSET,700)KNT

700   FORMAT('RECORD-SET:',I3)

721   CONTINUE !CALL SETTEXTPOSITION(2,21,S)

	CALL OUTTEXT(' '//RECSET)

!      CALL SETTEXTPOSITION(2,37,S)

	IF(MODE.EQ.2 .OR. ISF.EQ.2)GO TO 74

	WRITE(CTITLE,701)ICHAN(M),CLABEL(M)

701   FORMAT('CHANNEL ',I2,':',A12)

74    CALL OUTTEXT(' '//TRIM(CTITLE))

	WRITE(POINTS,800)NP1,NP1+NPT-1

800   FORMAT(' POINTS:',I4,'-',I4)

!	CALL SETTEXTPOSITION(2,64,S)

	CALL OUTTEXT(' '//TRIM(POINTS))

	CALL SETTEXTPOSITION(1,3,S)

	IF(NXEQ)45,45,44

44    IF(MODE.EQ.1 .AND. NCO.GT.1)M=M+1   !UPDATE CHANNEL COUNTER 

C WAIT FOR <CR>      


 45   CONTINUE
      IARES=INEXT
      
      
!      Ltemp=GETWINDOWCONFIG(wco)
!      isx=wco%numxpixels
!      isy=wco%numypixels
!      SCREENS=imagesize(1_2,1_2,isx,isy)
!      allocate(screen(SCREENS))
!      SCREENL=loc(screen)
!      CALL GETIMAGE(1_2,1_2,isx,isy,screen)
69    CALL DoPlotAdvanceDialog(IARES)
      IF(IARES.EQ.2)THEN
!        Call ShowInfoText('Info',
!     +    'Press OK to hide this window. Press ENTER when done')
        read(IGRAPH,'(A)')KEY
        IARES=0
        GOTO 69
      ENDIF
  
!      Ires=SETACTIVEQQ(IGRAPH)
!      Ires=FOCUSQQ(IGRAPH)    
!      READ(IGRAPH,'(A1)')IA
!45    READ(IGRAPH,'(A1)')IA
!      CALL GETVALU(2,IVAL,ANS,'(A)')
!      WRITE(IGRAPH,'(A)')ANS
!
107   FORMAT(1X)

!	WRITE(*,1071)

!1071  FORMAT(1H \)      ! DUMMY WRITE TO POSITION CURSOR

      IF(IARES.EQ.1)THEN
        KNT=INT(NR/NC)!-1   ! Jump to the last record
        IFLAG1=1
      ENDIF
	IF(INEXT.EQ.1) GO TO 90  ! INEXT = RETURN, AFTER PLOT LAYOUT ACCEPTED

! FIRST PLOT IS TRIAL; CHECK FOR NEW SCALE, TRANSFORM, PLOT REGION, DECIMATION

	CALL SETTEXTPOSITION(1,3,S)

      Y0MAX=YMAX0
      J0MP=JMP
      I0SKP=NPT/INT(XDIM)
      N01=NP1
      N0P=NP1+NPT-1
      IXFORM=IT-1
      CALL DoPlotAdjustDialog(ICHGF,IXFORM,Y0MAX,J0MP,I0SKP,N01,N0P)

!	WRITE(IGRAPH,108)
!
!108   FORMAT('CHANGES:0=NONE/1=REGION/2=XFORM/3=SCALE/4=SAMPLING >'\) 
!
!C	READ(IGRAPH,204) IGO
!	IGO=IGETVALU('(I1)')
!	WRITE(IGRAPH,'(I1)')IGO
!
!	CALL SETTEXTPOSITION(1,3,S)
!
!	CALL OUTTEXT(BLANKS)
!
C      selectcase(ICHGF)
C        case(0)
C            IGO=0
C        case(1)
C            IGO=1
C        case(2)
C            IGO=2
C        case(4)
C            IGO=3
C        case(8)
C            IGO=4
C      endselect
C	GO TO (29,500,600,60,400)IGO+1

! NO MORE CHANGES

29    IF(ICHGF.NE.0)GOTO 500
      NXEQ=1      ! NXEQ SET TO 1 ONLY AFTER PLOT LAYOUT ACCEPTED

	M=M+1       ! DONE HERE FOR FIRST PLOT ONLY

	ISCL=0       ! ASSUME CONSTANT SCALE FOR ALL SUPERIMPOSITION CASES

	IF(ISF.NE.0)GO TO 291

      CALL DoPlotScalingDialog(ISCMOD)
!	CALL SETTEXTPOSITION(1,3,S)
!
!	WRITE(IGRAPH,109)
!
!109   FORMAT('PLOT-BY-PLOT SCALING:0=CONSTANT/1=VARIABLE >'\)
!
!C	READ(IGRAPH,204) ISCL  !  IF VARIABLE, EACH CHANNEL WILL BE SCALED
!	ISCL=IGETVALU('(I1)')
!	WRITE(IGRAPH,*)ISCL
!
!	CALL SETTEXTPOSITION(1,3,S)
!
!	CALL OUTTEXT(BLANKS)
      ISCL=ISCMOD

291   INEXT=1 !SO WE SKIP REWORK FROM HERE ON

	GO TO 90

! CHANGE TO PLOT A SUBSET OF THE ORIGINALLY SELECTED POINTS

500   IF((ICHGF.AND.Z'01').EQ.0)GOTO 600
!      CALL SETTEXTPOSITION(1,3,S)
!
!	WRITE(IGRAPH,5001)
!
!5001  FORMAT('FIRST, LAST POINTS IN XSCALE UNITS? >'\)
!
!C	READ(IGRAPH,*)P1,PN
!      CALL GETVALU(2,IVAL,ALINE,'(A)')
!      WRITE(*,'(A)')ALINE
!      READ(ALINE,*)P1,PN
!
!	CALL SETTEXTPOSITION(1,3,S)
!
!	CALL OUTTEXT(BLANKS)
      P1=N01
      PN=N0P

	IF(IPL.GE.2) GO TO 5004

      P1=P1+DX

5004  N1=(P1-X0)/DX + 1  

	NL=(PN-X0)/DX + 1

	NPT=NL-N1+1

	X1=P1

	XSCALE=XDIM/FLOAT(NPT-1)

C	GO TO 30       ! TO RESET SCALE FOR ORDINATE

! CHANGE TO PLOT NEW DATA TRANSFORM

600   IF((ICHGF.AND.Z'02').EQ.0)GOTO 60
!      CALL SETTEXTPOSITION(1,3,S)
!
!	WRITE(IGRAPH,601)
!
!601   FORMAT('DATA XFORM:0=NONE/1=SQRT/2=LN/3=ARCSIN/4=ABS >'\)
!
!C	READ(IGRAPH,204)IT
!	IT=IGETVALU('(I1)')
!	WRITE(IGRAPH,'(I1)')IT
      IT=IXFORM

	IT=IT+1

!	CALL SETTEXTPOSITION(1,3,S)
!
!	CALL OUTTEXT(BLANKS)

C	GO TO 30

! CHANGE TO PLOT WITH NEW Y-AXIS SCALE

60    IF((ICHGF.AND.Z'04').EQ.0)GOTO 400
!      CALL SETTEXTPOSITION(1,3,S)
!
!	WRITE(IGRAPH,61) YMAX0
!
!61    FORMAT('   CURRENT MAX IS ',G10.4,';  NEW MAX VALUE = ? >'\)
!
!C	READ(IGRAPH,*) Y2
!      CALL GETVALU(2,IVAL,ALINE,'(A)')
!      WRITE(*,'(A)')ALINE
!      READ(ALINE,*)Y2
!
!	CALL SETTEXTPOSITION(1,3,S)
!
!	CALL OUTTEXT(BLANKS)
!
!	CALL CLEARSCREEN(0)
      Y2=Y0MAX

	IF(Y2.LE.0.)Y2=YMAX0

	YMAX=Y2

C	GO TO 561
  	YMAX0=YMAX
      YSCALE=YDIM/(YMAX-YMIN)
      iusrscly=1

! CHANGE TO PLOT ONLY SAMPLING FRACTION OF AVAILABLE POINTS

400   IF((ICHGF.AND.Z'08').EQ.0)GOTO 441
      ISKP=NPT/INT(XDIM)      ! MAXIMUM DECIMATION FACTOR

!	CALL SETTEXTPOSITION(1,3,S)
!
!	WRITE(IGRAPH,401)JMP,ISKP
!
!401   FORMAT('LAST PLOT USED EVERY',I2,'TH POINT;',
!
!     + '  ENTER NEW SPACING .LE.',I2,' >'\)
!
!C	READ(IGRAPH,*)JMP
!	JMP=IGETVALU('(I1)')
!	WRITE(IGRAPH,'(I1)')JMP
      JMP=J0MP

441   CALL CLEARSCREEN(0)
	GO TO 30

90    RETURN

C TERMINATION SECTION

3000  CONTINUE
!      READ(*,107)

      CLOSE(IGRAPH)

	RETURN

	END



! *******************************************************************

C PLOTCHAN.FOR- SUBROUTINE TO PLOT ONE RECORD FOR FILMAN PLOT ROUTINE

C WITH MULTICHANNEL CAPABILITY

	SUBROUTINE PLOTCHAN

      USE IFQWIN

      INCLUDE 'MAX.INC'

	RECORD/XYCOORD/XY

	COMMON/FLDESO/IDO(8),IBUFO(IOMAX)

	COMMON/PLOTDATA/IPL,NPT,IT,XDIM,XSCALE,YDIM,YSCALE,X1,DX,

     1 JMP,ISCL,IAXIS,YMAX,YMIN,IX0,IY0,IYOFF,CLAB

	DIMENSION WORK(IOMAX-120)

	CHARACTER*5 XLAB

	CHARACTER*8 CLAB

C POWERSTATION GRAPHICS ROUTINES STILL EXPECT INT*2 SCREEN COORDS,

C WHICH IS A BIG PAIN

	INTEGER*2 JPL,IX0,IY0,IYOFF,IYTOP,IYLAB,IXDIM,IYDIM,ICX,ICY

	INTEGER*2 IX1,IY1,TWO,THREE,ELEVEN,IXL,ISTAT

	EQUIVALENCE (IBUFO(121),WORK) ! PRESUMED DATA LOCATION FOR NOW

	DATA TWO,THREE,ELEVEN/2,3,11/

! *******************************************************************

	IXDIM=XDIM

	IYDIM=YDIM

	IYLAB=IY0+5

	XSCALDATA=XSCALE*FLOAT(JMP) ! CORRECTION FOR VARIABLE DECIMATION

	IF(IPL.EQ.2) GO TO 40

50    JPL=IY0-IYDIM

	GO TO 55

40    JPL=IY0

55    IYTOP=JPL-IYDIM         !???

	ICX=IX0+IXDIM-80

	ICY=IYTOP+6

! *******************************************************************

C TEST WHETHER DATA SCALING NEEDED      

	IF(ISCL.EQ.0)GO TO 21

	VAL=RECODE(WORK(1),IT) !FIND MAXIMUM/MINIMUM

	YMAX=ABS(VAL)

	YMIN=VAL

	DO 56 I=2,NPT,JMP

	VAL=RECODE(WORK(I),IT)

	IF (ABS(VAL).GT.YMAX) YMAX=ABS(VAL)

	IF(VAL.LT.YMIN)YMIN=VAL

56    CONTINUE

	IF(IPL.NE.2) YMIN=0.     ! FORCE SPECTRA TO START AT 0 AMPLITUDE

      YSCALE=YDIM/(YMAX-YMIN)

! *************************************************************AXES

C TEST WHETHER WE NEED TO DRAW AXES ETC

21	IF(IAXIS.NE.1) GO TO 22

	XLAB='        '

C FIRST DRAW AXES

	CALL MOVETO(IX0,JPL,XY)  !X-AXIS

	ISTAT = LINETO(IX0+IXDIM,JPL)

	CALL MOVETO(IX0,IY0,XY)  !Y-AXIS

	ISTAT=LINETO(IX0,IYTOP)

C LABEL X-AXIS

	CALL LABSCL(IPL,NPT,DX,XDIM,STEP,XINT)  ! CHOOSES LABEL REGIME

	IF(IPL.NE.3) GO TO 2110

      CALL MOVETO(IX0,IY0,XY)

	ISTAT=LINETO(IX0+IXDIM,IY0)

2110  XV1=X1                 ! VALUE AT FIRST PLOT POINT

	XVN=XV1+FLOAT(NPT-1)*DX  ! VALUE AT LAST PLOT POINT

	FTCK=(XVN-XV1)/STEP   ! EXACT # STEPS

	XSCAL2=XDIM/(FTCK)    ! PIXELS/STEP, EXACT

C IF NECESSARY, ADJUST POSITION OF FIRST TICK TO A STEP BOUNDARY

	IOFF=0

	FRACT=STEP-AMOD(XV1,STEP)

	IF(FRACT.EQ.STEP)GO TO 75 ! ALREADY ON A BOUNDARY

	XV1=XV1+FRACT  ! VALUE AT FIRST TICK

	IOFF=IFIX((FRACT/STEP)*XSCAL2+.5)    ! PIXEL OFFSET TO FIRST TICK

C OFFSET CORRECTION IS (STEP FRACTION)*(PIXELS/STEP)

75    IX1=IX0+IOFF

	XI=IX1

	NTCK=INT(FTCK)+1

	XDAT=XV1

	DO 90 I=1,NTCK

	CALL MOVETO(IX1,JPL-TWO,XY)

	ISTAT=LINETO(IX1,JPL+THREE)

	IF(IPL.EQ.2)GO TO 751

	CALL MOVETO(IX1,IY0-TWO,XY)

	ISTAT=LINETO(IX1,IY0+THREE)

751   IF(AMOD(XDAT,XINT))85,80,85

80    CALL MOVETO(IX1,JPL+THREE,XY)

	ISTAT=LINETO(IX1,JPL+ELEVEN)

	IF(IPL.EQ.2)GO TO 752

	CALL MOVETO(IX1,IY0+THREE,XY)

	ISTAT=LINETO(IX1,IY0+ELEVEN)

752   IF(IPL.NE.1) GO TO 8002

! patch for short time segments- convert to ms.

      IF(FLOAT(NPT)*DX .GE. .5) GO TO 8001

	IXD1=IFIX(XDAT*1000.+.5)

	WRITE(XLAB,8011)IXD1

8011  FORMAT(I5)

	GO TO 803

8001  WRITE(XLAB,8010)XDAT   

8010  FORMAT(F5.2)

	GO TO 803

8002  IXDAT=XDAT

	WRITE(XLAB,81)IXDAT    

81    FORMAT(I4)

803   IXL=IX1-24  !START POSITION FOR LABEL

	CALL MOVETO(IXL,IYLAB,XY)

	CALL OUTGTEXT(XLAB)

85    XI=XI+XSCAL2

	IX1=XI+.5

	XDAT=XDAT+STEP

90    CONTINUE

! *******************************************************************

C DRAW NEXT PLOT

22    IX1=IX0

	JPL1=JPL-IYOFF

	Y=(RECODE(WORK(1),IT)-YMIN)*YSCALE

	IF(ABS(Y).GT.YDIM) Y=SIGN(YDIM,Y)

	IY1=MAX0(INT4(JPL1-IFIX(Y)),INT4(IYTOP))

	XI=IX1

	CALL MOVETO(IX1,IY1,XY)

	DO 70 I=2,NPT,JMP

	XI=XI+XSCALDATA

	IX1=XI+.5

	Y=(RECODE(WORK(I),IT)-YMIN)*YSCALE

	IF(ABS(Y).GT.YDIM) Y=SIGN(YDIM,Y)

	IY1=MAX0(INT4(JPL1-IFIX(Y)),INT4(IYTOP))     ! LIMIT PLOT HEIGHT,

	ISTAT=LINETO(IX1,IY1)             ! WITH OFFSET POSSIBLE

70    CONTINUE

C LABEL PLOT WITH ABBREVIATED CHANNEL LABEL

	CALL MOVETO(ICX,ICY,XY)

	CALL OUTGTEXT(CLAB)

	RETURN

	END

	



