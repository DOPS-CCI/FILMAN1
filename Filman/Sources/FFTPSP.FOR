C FFTPSP.FOR- FFT-BASED POWER SPECTRUM FOR SPECTR, DERIVED FROM POWSP.FIL

	SUBROUTINE FFTPSP(X,N,IC)

	COMMON IFLAG1,IFLAG2,IFLAG3,KNT,ISZ,ICHAN(1)

	COMMON/DEV/ITI,ILP

	COMMON/FLDESO/ NGO,NAO,NCO,NDO,NFO,NLO,NRO,ISO,WORK(1)

	COMMON/FLDES/ NG,NA,NC,ND,NF,NL,NR,IS,IBUF(1)

	COMMON/PTLST/NLIST,LIST(2,72),NP1,NP2,NPTOT,P1,PT,DT,DF

	DIMENSION X(N,IC),SPECTRA[ALLOCATABLE](:,:)

	CHARACTER*24 PTITLE

1       CALL PTSEL

	NP3=NPTOT

	NP=2

	FNYQ=FLOAT(IS)/2.0

42      I=NP+NP

	IF(I-NP3) 43,44,44

43      NP=I

	GO TO 42

44      NXFM=I

	WRITE(ITI,99)

99      FORMAT('$  FFTPSP: ZERO-PAD THE TRANSFORM? >'\)

	READ(ITI,201)IA

	IF(IA.EQ.'Y')NXFM=4096

	DF=FLOAT(IS)/FLOAT(NXFM)

10      WRITE(ITI,100)

100     FORMAT('$  FFTPSP TAPERING:0=NONE/1=HANN >'\)

	READ(ITI,101)IT

101     FORMAT(I1)

46      WRITE(ITI,102)FNYQ

102     FORMAT('$  FREQUENCY CUTOFF(.LE.',F5.1,') >'\)

	READ(ITI,104)FMAX

104     FORMAT(F6.0)

	IF(FMAX.EQ.0.)FMAX=FNYQ

	NP3=FMAX/DF + 1

	ALLOCATE(SPECTRA(NP3,IC),STAT=IERR)

C	CALL TIMER(T1)

	DO 60 L=1,IC

C COPY SOURCE DATA

	K=1

	DO 5 I=NP1,NP2

	WORK(K)=X(I,L)

5       K=K+1 

8	CALL DETRND(WORK,NPTOT,2)

C ZERO PAD IF REQUESTED OR NEEDED

	IF(NXFM.EQ.NPTOT)GO TO 16

	DO 6 K=NP+1,NXFM

6       WORK(K)=0.

16    CALL FAST(WORK,NXFM)

	J=1

	DO 20 I=1,NP3

	WORK(I)=WORK(J)**2 + WORK(J+1)**2

20      J=J+2

	IF(IT.NE.1)GO TO 50

	TMP=WORK(1)

	DO 30 I=2,NP3-1

	TMP1=WORK(I)

	WORK(I)=.5*WORK(I) + .25*(TMP + WORK(I+1))

30    TMP=TMP1

C COPY FINAL SPECTRUM INTO ARRAY      

50    DO 55 I=1,NP3

55    SPECTRA(I,L)=WORK(I)

60    CONTINUE

C	CALL TIMER(T2)

C	T2=(T2-T1)*1000.

C	WRITE(ITI,200)T2

C200     FORMAT('   FFTPSP TIME IS',F7.1 , 'MS.')

C PLOT THE RESULTS      

	NXEQ=0

	ISETF=0

      MODE=0

	IKP=0

	WRITE(ITI,299)

299     FORMAT('$  RECALL PREVIOUS PLOT? >'\)

	READ(ITI,201)IA

201     FORMAT(A1)

	IF(IA.EQ.'Y')IKP=1

	WRITE(PTITLE,902)   

902     FORMAT('FFT POWER SPECTRUM ')

	N1=1

	N2=NP3

	CALL SPECPLOT(SPECTRA,NP3,IC,N1,N2,1,IC,2,PTITLE,

     + 	 IKP,NXEQ,0,ISETF,MODE)

	WRITE(ITI,300)

300     FORMAT('$  FFTPSP NEXT:0=RET/1=FREQS/2=TAPER/3=PAD/4=POINTS >'\)

	READ(ITI,101)IGO

	GO TO(70,46,10,44,1)IGO+1

70    DEALLOCATE(SPECTRA)  

	RETURN

	END



