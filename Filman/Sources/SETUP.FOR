C SETUP.FOR- SUBROUTINE TO ALLOCATE PLOT REGIONS FOR MULTICHANNEL

C PLOTS. NASTY ROUTINE BUT ONLY EXECUTES ONCE. MODIFIED FROM PLOT.FOR

C VERSION. STILL NEED TO CHECK #CHANS(VARIES)

	SUBROUTINE SETUP(IXDIM,IYDIM,MARGIN,CLABEL,NC,MODE,   ! PASSED

     + ISTART,XDIM,YDIM)                                    ! RETURNED

      INCLUDE 'MAX.INC'

	DIMENSION ISTART(ICHMAX,2),MISC(MISCSIZ),MAP(20)

	CHARACTER*24 CLABEL(NC),CTEMP24     ! FOR PS VERSION

	CHARACTER*1 CTEMP1(24)

	EQUIVALENCE (CTEMP24,CTEMP1)  ! HANDY FOR CHAR-BY-CHAR OPS
	INTEGER*2 IXDIM,IYDIM

C DEFINE TOTAL AVAILABLE SCREEN DIMENSIONS

	XTOT=FLOAT(IXDIM-MARGIN)

	YTOT=FLOAT(IYDIM-50)     ! ALLOWS FOR 3 LINES OF TEXT BY PLOT

	IF(NC.EQ.1) MODE=1 !GO TO 1000

!	MODE=1

!	GO TO 1

!1000  WRITE(*,101)

!101   FOR!MAT('   SPECPLOT MODE:1=SINGLE/2=MULTICHANNEL >'\)

!	READ(*,*)MODE

	ISTART=0

	GO TO (1,4)MODE

	!SINGLE CHANNEL

1     IX0=MARGIN+1

	IY0=IYDIM-2*MARGIN-1    ! BRUTE-FORCE FIXED

	DO 2 I=1,NC

	ISTART(I,1)=IX0

2     ISTART(I,2)=IY0

	XDIM=XTOT-MARGIN

	YDIM=YTOT-MARGIN

	RETURN

	!MULTICHANNEL

4     NMISC=0           ! NON-SCALP CHANNELS

	DO 10 I=1,NC

	CTEMP24=CLABEL(I)

	CALL READLAB(CTEMP24,ISTART(I,1),ISTART(I,2))

	IF(ISTART(I,1).NE.0)GO TO 10

	NMISC=NMISC+1

	MISC(NMISC)=I

10    CONTINUE

C DETERMINE NUMBERS OF ROWS & COLUMNS TO PLOT

C DO ROWS FIRST; THEY'LL INCLUDE ANY NON-SCALP CHANNELS

	MAP=0

	ASSIGN 201 TO NEXT

	NR=0        !COUNTER FOR ROWS OF SCALP CHANNELS

	DO 15 I=1,NC

	K=ISTART(I,1)

	IF(K.EQ.0)GO TO 15      ! NON-SCALP CHANNEL

	IF(MAP(K).EQ.1) GO TO 15      ! DUPLICATE ROW

	MAP(K)=1

	NR=NR+1     

15    CONTINUE

!ELIMINATE UNOCCUPIED ROWS

16    NEWCOORD=1

	DO 20 I=1,20

	IF(MAP(I).EQ.0)GO TO 20

	MAP(I)=NEWCOORD

	NEWCOORD=NEWCOORD+1

20    CONTINUE

	GO TO NEXT

201   ASSIGN 31 TO NEXT

C NOW ASSIGN FINAL PLOT ROW POSITIONS TO THE SELECTED SCALP CHANNELS

	DO 25 I=1,NC

	K=ISTART(I,1)

	IF(K.LE.0)GO TO 25

22    ISTART(I,1)=MAP(K)

25    CONTINUE

C NOW PROCESS THE COLUMN COORDINATES IN THE SAME WAY

	MAP=0

	NCOL=0

	DO 30 I=1,NC

	K=ISTART(I,2)

	IF(K.EQ.0)GO TO 30      ! ALREADY COUNTED BY ROW ROUTINE

	IF(MAP(K).EQ.1)GO TO 30 ! DUPLICATE

	MAP(K)=1

	NCOL=NCOL+1

30    CONTINUE

	GO TO 16

C NOW ASSIGN COLUMN POSITIONS TO THE SCALP CHANNELS

31    DO 35 I=1,NC

	K=ISTART(I,2)

	IF(K.LE.0) GO TO 35

33    ISTART(I,2)=MAP(K)

35    CONTINUE

C DETERMINE WHERE TO PUT THE MISCELLANEOUS ONES:

C WILL THEY FIT IN LAST SCALP ROW?

	I2MAX=0

	DO 40 I=1,NC

	IF(ISTART(I,1).LT.NR)GO TO 40 ! LOOK AT LAST ROW ONLY

	IF(ISTART(I,2).LT.I2MAX)GO TO 40    !FIND BIGGEST COLUMN INDEX

	I2MAX=ISTART(I,2)

40    CONTINUE

	IF((NCOL-I2MAX).LT.NMISC)GO TO 42   ! DOESN'T FIT IN LAST ROW

	NM1=I2MAX+1 ! FIRST FREE COLUMN

	GO TO 44

C NEW ROW TO START MISC

42    NR=NR+1

	NM1=1

	IF(NCOL.GT.0) GO TO 44 !HAVE AT LEAST SOME STANDARD CHANNELS

	NCOL=4  !ARBITRARILY CHOOSE 4 COLUMNS, IF NO STANDARD CHANNELS

C SET ROW, COLUMN POSITIONS FOR MISC. CHANNELS

44    DO 45 I=1,NMISC

      IF(NM1.LE.NCOL) GO TO 441

      NR=NR+1 !CREATE NEW ROW

      NM1=1

441   ISTART(MISC(I),1)=NR

	ISTART(MISC(I),2)=NM1

45    NM1=NM1+1

C FINALLY, TRANSLATE PLOT ROW,COLUMN POSITIONS TO SCREEN  COORDINATES,

C DETERMINE XDIM & YDIM , AND RETURN

	IXT=XTOT/FLOAT(NCOL)

	XDIM=IXT-MARGIN   ! LEAVING ROOM FOR Y-LABELS + SPACER

	IYT=YTOT/FLOAT(NR)

	YDIM=IYT-MARGIN   ! LEAVING ROOM FOR X-LABELS + SPACER

	DO 50 I=1,NC

	IR=ISTART(I,1)    ! PLOT ROW

	IC=ISTART(I,2)-1  ! PLOT COLUMN

	ISTART(I,2)=30+IR*IYT   ! VERTICAL STARTPOINT=ROWS DOWN FROM TOP

	ISTART(I,1)=MARGIN+IC*IXT      ! HORIZONTAL STARTPOINT

50    CONTINUE

	RETURN

	END





C SUBROUTINE TO SELECT LABELING SCHEME FOR ABSCISSA

	SUBROUTINE LABSCL(ITYPE,N,DX,XDIM,STEP,XINT)

      PARAMETER (IXTOT=1024,MARGIN=10)    ! ALL OTHERS

	GO TO (1,5,5)ITYPE

C TIME-DATA

1     SEC=FLOAT(N)*DX

	STEP=SEC/64.

	XINT=8.0*STEP

	GO TO 20

C FREQUENCY DATA 

5     STEP=.125

	XINT=1.0

C CANONICAL VALUES ARE FOR <16HZ CASE; ADJUST FOR OTHERS

	IRANGE=FLOAT(N-1)*DX

	IR=8

	FACT=.5

	DO 10 K=1,8

	FACT=2*FACT

	IR=2*IR

	IF(IR-IRANGE)10,15,15

10    CONTINUE

15    STEP=STEP*FACT

	XINT=XINT*FACT

20    IF(XDIM.GE.(IXTOT-MARGIN))GO TO 30

C CORRECT FOR PLOT'S ACTUAL LENGTH IN MULTICHANNEL CASES

	ISIZE=IXTOT/(INT(XDIM)+MARGIN)      ! INTEGER MULTIPLIER

C CHANGE IT TO NEXT HIGHER POWER OF 2      

	M=-1

21    M=M+1

	IF(2**M.LT.ISIZE)GO TO 21

	FSIZE=2.0**M

	XINT=XINT*FSIZE

	STEP=STEP*FSIZE

30    RETURN

	END
	
	
C SUBROUTINE TO SELECT LABELING SCHEME FOR ABSCISSA

	SUBROUTINE LABSCL7(ITYPE,N,DX,XDIM,IXTOT,STEP,XINT)

	PARAMETER (MARGIN=10)

	GO TO (1,5,5)ITYPE

C TIME-DATA

1     SEC=FLOAT(N)*DX

	STEP=SEC/64.

	XINT=8.0*STEP

	GO TO 20

C FREQUENCY DATA 

5     STEP=.125

	XINT=1.0

C CANONICAL VALUES ARE FOR <16HZ CASE; ADJUST FOR OTHERS

	IRANGE=FLOAT(N-1)*DX

	IR=8

	FACT=.5

	DO 10 K=1,8

	FACT=2*FACT

	IR=2*IR

	IF(IR-IRANGE)10,15,15

10    CONTINUE

15    STEP=STEP*FACT

	XINT=XINT*FACT

20    IF(XDIM.GE.(IXTOT-MARGIN))GO TO 30

C CORRECT FOR PLOT'S ACTUAL LENGTH IN MULTICHANNEL CASES

	ISIZE=IXTOT/(INT(XDIM)+MARGIN)      ! INTEGER MULTIPLIER

C CHANGE IT TO NEXT HIGHER POWER OF 2      

	M=-1

21    M=M+1

	IF(2**M.LT.ISIZE)GO TO 21

	FSIZE=2.0**M

	XINT=XINT*FSIZE

	STEP=STEP*FSIZE

30    RETURN

	END

	
	
	

C ***************

C SUBROUTINE TO EXTRACT POSITION INFO FROM FILMAN LABEL FIELDS; MAY

C NEED TIGHTENING UP TO CHECK FOR IMPOSSIBLE VALUES ETC

!HERE'S HOW IT WORKS NOW: EMBED ROW,COLUMN ANYWHERE IN LABEL (E.G. AT

!END TO AVOID PRINTING OUT ON PLOT)

	SUBROUTINE READLAB(CLABEL,IROW,ICOL)

      INCLUDE 'MAX.INC'
	PARAMETER (NCMAX=ICHMAX)

C IF NOT A SCALP CHANNEL SETS IROW, ICOL TO 0

	CHARACTER*24 CLABEL

	CHARACTER*1 ITBL(11)

	DATA ITBL/'0','1','2','3','4','5','6','7','8','9',','/

	IROW=0

	ICOL=0

	ND=0

	ID1=0

	ID2=0

	IF(CLABEL(1:1).EQ.'*') RETURN    ! (OLD CONVENTION FOR NON-SCALP)

	L=LEN_TRIM(CLABEL)

	DO 20 I=1,L

	DO 15 J=1,11

	IF(CLABEL(I:I).NE.ITBL(J)) GO TO 15

5     GO TO(6,6,6,6,6,6,6,6,6,6,12) J

!     FOUND A DIGIT, TO WHICH NUMBER DOES IT BELONG?

6     IF(ND.EQ.2) GO TO 8

      ND=1

      ID1=10*ID1+J-1

	GO TO 20

8     ID2=10*ID2+J-1

	GO TO 20

!     COME HERE FOR COMMAS

12    IF(ND.NE.1) GO TO 20 !STILL HAVEN'T FOUND FIRST NUMBER=>STRAY COMMA

      IF(ID2.NE.0) GO TO 25 !ALREADY FOUND 2 NUMBERS=>MUST BE DONE

      ND=2 !OTHERWISE START LOOKING FOR SECOND NUMBER

      GO TO 20

15    CONTINUE

! AT THIS POINT, LAST CHARACTER WAS NOT A DIGIT OR COMMA

	IF(ID2.NE.0) GO TO 25 !HAVE TWO NUMBERS; DONE

      !HAVE NO NUMBERS; KEEP GOING

      ID1=0 !ASSURE INITIAL CONDITIONS

      ND=0

20    CONTINUE

	IF(ID2.EQ.0) RETURN

C ROUGH CHECK FOR WILD NUMBERS

25    IF(ID1*ID2.GT.NCMAX) RETURN

	IROW=ID1

	ICOL=ID2

	RETURN

	END





