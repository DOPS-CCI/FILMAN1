C GRPNS.FOR- OBTAINS N'S FOR LEVELS OF SPECIFIED GROUP VARIABLES AND WRITES

C THEM TO USER'S TTY AND LP. (THIS INFO NEEDED FOR XHIST, FOR EXAMPLE)

	SUBROUTINE GRPNS

      INCLUDE 'MAX.INC'

! Group variable levels between 0 and MAXLVL

! Maximum number of group variables monitored is MAXGRP

      PARAMETER (MAXLVL=10,MAXGRP=20)

	CHARACTER*1 INPFIL(64)

	COMMON IFLAG1,IFLAG2,IFLAG3,KNT,ISZ

	COMMON/FLDES/NG,NA,NC,ND,NF,NP,NR,IS,IBUF(IOMAX)

	COMMON/FLDESO/IDO(8),IBUFO(IOMAX)

	COMMON /DEV/ITI,IOX

	COMMON/STDFIL/INPFIL

	INTEGER*4, SAVE :: K,NGRP,LABS(6,MAXGRP),NGRPNS(MAXGRP,0:MAXLVL)

	INTEGER*4, DIMENSION(MAXGRP), SAVE :: IGRP,NLVL

	DATA ILP,IRP/'(',')'/
      COMMON /CPN/ CURPROCNAME
      CHARACTER*10 CURPROCNAME
      CHARACTER*1024 OUTNAME
      CHARACTER*1024 OUTFNM

	IF(IFLAG1)10,20,30

10      IFLAG3=0
      CURPROCNAME='GRPNS'

	ISZ=0

      OUTNAME=OUTFNM(CURPROCNAME)
	OPEN(UNIT=IOX,FILE=OUTNAME,ACTION='WRITE',STATUS='REPLACE')

	K=0

	DO 1 J=1,NG

	DO 1 I=1,6

	K=K+1

1       LABS(I,J)=IBUF(K)

      MNG=MIN(NG-1,MAXGRP)

!	WRITE(*,200)(J,(LABS(I,J),I=1,6),J=2,NG)
!
!200     FORMAT('GROUP VARIABLE ',I2,' ID=',6A4)
!
!	WRITE(*,201)(ILP,IRP,I=2,MNG+1)
!
!201     FORMAT('WHICH GROUPS?'/20(A1,2X,A1))
!
!	READ(*,100)(IGRP(I),I=1,MNG)
!
!100     FORMAT(1XI2,19(2XI2))
      CALL DoGRPNSDialog(IGRP)


C GET COMPRESSED LIST OF VALID GROUPS

	NGRP=0

	DO 5 I=1,NG-1

	IF(IGRP(I)-1)5,5,2

2       IF(IGRP(I)-NG)3,3,5

3       IF(NGRP.EQ.0)GO TO 6

	DO 4 J=1,NGRP

	IF(IGRP(I)-IGRP(J))4,5,4

4       CONTINUE

6       NGRP=NGRP+1

	IGRP(NGRP)=IGRP(I)

5       CONTINUE

	DO 8 I=1,NGRP

	NLVL(I)=0

	DO 8 J=1,10

8       NGRPNS(I,J)=0

	K=0

	WRITE(IOX,400)(INPFIL(I),I=1,64)

400     FORMAT(' GROUP-VAR LEVEL TOTALS FROM FILE ',64A1//)

	WRITE(IOX,401)(IBUFO(I),I=1,108)

401     FORMAT(1H ,18A4)

	RETURN

20      IF(K-KNT)21,25,25

21      K=KNT

	DO 24 I=1,NGRP 

	L=IBUF(IGRP(I))

	IF(L-NLVL(I))23,23,22 !NLVL maintains highest value of group variable I

22      IF(L-MAXLVL)26,26,27 !Values of GV > MAXLVL get printed,

27    CONTINUE  
      WRITE(*,300)L,IGRP(I),KNT

	WRITE(IOX,300)L,IGRP(I),KNT

300     FORMAT(' VALUE OF ',I3,' IN GROUP-VAR ',I2,' RECSET ',I4)

	GO TO 24 ! but not recorded in NLVL (NGRPNS dimension limit)

26      NLVL(I)=L

23      NGRPNS(I,L)=NGRPNS(I,L)+1

24      CONTINUE

25      RETURN

30      WRITE(*,202)

	WRITE(IOX,202)

202     FORMAT(//' RESULTS:')

	DO 40 I=1,NGRP

	WRITE(*,203)IGRP(I),(LABS(J,IGRP(I)),J=1,6)

	WRITE(IOX,203)IGRP(I),(LABS(J,IGRP(I)),J=1,6)

203     FORMAT(/' GROUP VARIABLE ',I2,' - ',6A4)

!!	WRITE(*,204)(J,J=0,NLVL(I))
!!
!!	WRITE(IOX,204)(J,J=0,NLVL(I))
!
!	WRITE(*,204)(J,J=1,NLVL(I))
!	WRITE(IOX,204)(J,J=1,NLVL(I))
!
204     FORMAT(' LEVEL',10(2X,I2,2X))
!
!!	WRITE(*,205)(NGRPNS(I,J),J=0,NLVL(I))
!!
!!40      WRITE(IOX,205)(NGRPNS(I,J),J=0,NLVL(I))
!
!	WRITE(*,205)(NGRPNS(I,J),J=1,NLVL(I))
!40      WRITE(IOX,205)(NGRPNS(I,J),J=1,NLVL(I))

	DO 4001 J0=1,NLVL(I)/10
	J1=(J0-1)*10+1
	J2=J0*10
	WRITE(*,204)(J,J=J1,J2)
	WRITE(IOX,204)(J,J=J1,J2)
	WRITE(*,205)(NGRPNS(I,J),J=J1,J2)
4001  WRITE(IOX,205)(NGRPNS(I,J),J=J1,J2)
      IF(MOD(NLVL(I),10).EQ.0)GOTO 40
	J1=10*(NLVL(I)/10)+1
	J2=10*(NLVL(I)/10)+MOD(NLVL(I),10)
	WRITE(*,204)(J,J=J1,J2)
	WRITE(IOX,204)(J,J=J1,J2)
	WRITE(*,205)(NGRPNS(I,J),J=J1,J2)
      WRITE(IOX,205)(NGRPNS(I,J),J=J1,J2)
40    CONTINUE

205     FORMAT('   N  ',10(I4,2X))

	WRITE(IOX,500)

500     FORMAT(//' END OF JOB')

	CLOSE(UNIT=IOX)

	RETURN

	END



