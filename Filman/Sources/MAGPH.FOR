C MAGPH.FIL- PROGRAM TO READ INPUT FILE OF COMPLEX FOURIER COEFFICIENTS

C AND WRITE OUTPUT FILE OF MAGNITUDES AND/OR PHASES. USED FOR EXAMPLE

C TO GENERATE AUTOSPECTRA FROM XFORM, OR PHASE INFO FROM COMPLEX

C VALUES OUTPUT BY XSPEC.

      SUBROUTINE MAGPH

      INCLUDE 'MAX.INC'

	DIMENSION XC(2)

	CHARACTER*1 ANS

	COMMON IFLAG1,IFLAG2,IFLAG3,KNT,ISZ,ICHAN(ICHMAX)

	COMMON/FLDES/NG,NA,NC,ND,NF,NP,NR,IS,IBUF(IOMAX)

	COMMON/FLDESO/NGO,NAO,NCO,NDO,NFO,NPO,NRO,ISO,IBUFO(IOMAX)

	COMPLEX CXY,TXY

	INTEGER*4, SAVE :: NSO,K1,K2,NDO2,NPB,IMAG,IPH,ITAP

	REAL*4, SAVE :: AN

	EQUIVALENCE (X,IX),(Y,IY),(Z,IZ)

	EQUIVALENCE (CXY,XC),(XC(1),X),(XC(2),Y)
      COMMON /CPN/ CURPROCNAME
      CHARACTER*10 CURPROCNAME

	IF(IFLAG1)10,20,30

10	NFO=3
      CURPROCNAME='MAGPH'

C MOVE CHANNEL LABELS

	J=6*NGO+109

	DO 12 I=1,NCO

	L=J+5

	K=6*(NG+ICHAN(I))-5

	DO 15 I1=J,L

	IBUFO(I1)=IBUF(K)

15	K=K+1

12	J=J+6

C GET START INDEX AND # OUTPUT POINTS

13	CONTINUE
      CALL DoMAGPHDialog(IMAG,IPH,J1,NDO2,NPB,ITAP,NDO)

!      WRITE(*,200)
!
!200	FORMAT('OUTPUT MAGNITUDES? >'\)
!
!      READ(*,*) ANS
!
!      IMAG=0
!
!      IF (ANS.EQ.'Y' .OR. ANS.EQ.'y') IMAG=1
!
!      WRITE(*,203)
!
!203   FORMAT('OUTPUT PHASES? >'\)
!
!	READ(*,*) ANS
!
!	IPH=0
!
!      IF (ANS.EQ.'Y' .OR. ANS.EQ.'y') IPH=1

	IF(IMAG+IPH)13,13,16

16	CONTINUE
!      WRITE(*,201)NDO
!
!201	FORMAT('FIRST COMPLEX PT, #BLOCKS(<=',I4,
!
!     1  '), #PTS/BLOCK >'\)
!
!	READ(*,*)J1,NDO2,NPB

	IF(NDO2*NPB .GT. NDO) GO TO 16

	IF(IMAG)18,18,17

17	CONTINUE
!      WRITE(*,202)
!
!202	FORMAT('WAS TIME WINDOW TAPERED? >'\)
!
!	READ(*,*)ANS
!
!	ITAP=0
!
!	IF(ANS.EQ.'Y' .OR. ANS.EQ.'y') ITAP=1

18	NDO=(IMAG+IPH)*NDO2

	NSO=NGO+NAO+1

	AN=NPB

	K1=NSO+NDO2

	ISZ=NDO

	RETURN

20	K=NSO

	K2=K1

	L=1

	DO 60 I=1,NDO2

C COMPUTE NEEDED QUANTITIES FOR THIS BLOCK

	TXY=0.0

	DO 50 J=1,NPB

	CALL XVAL(L,X,Y)

45	TXY=TXY+CXY

50	L=L+1

C STORE BLOCK VALUES

      CXY=TXY

	IF(IMAG)55,55,51

51	Z=SQRT(X*X+Y*Y)/AN

	IF(ITAP)53,53,52

52	Z=Z*1.185185185

53	IBUFO(K)=IZ

	K=K+1

55	IF(IPH)60,60,56

56	Z=ATAN2(Y,X)

C POSITIVE ANGLE IMPLIES X LEADS Y IF INPUT CAME FROM XSPEC

	IBUFO(K2)=IZ

	K2=K2+1

60	CONTINUE

	CALL PUTSTD(IBUFO)

30	RETURN

	END

