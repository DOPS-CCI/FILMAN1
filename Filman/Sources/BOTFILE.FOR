      SUBROUTINE SAVEBDTF(WYN,NPTS,NCHANS,KN,WHICH,IW,IB,IWNMAX,IBTNUM)
	INCLUDE 'MULTAR.INC'
      REAL WYN(NPTS,NCHANS,NCHANS,KN)
      COMMON /BOOTFIL/ ICVN,IRECCN,IRECL,IERRCN
      LOGICAL WHICH(MKN+1)
      
      IF(IERRCN.NE.0)RETURN
!      ILIM=NPTS*NCHANS*NCHANS
!      INUMR=(ITRLN-1)*IWNMAX+IWIN  
!      INUMR1=(INUMR-1)*(KN)+1
      ikhl=NCHANS*NCHANS
      ibtl=ikhl*KN
      iwnl=ibtl*IBTNUM
      INUMR1=(IW-1)*iwnl+(IB-1)*ibtl+1
      do 1,irec=1,KN
      Do 1,irow=1,NCHANS
      Do 1,icol=1,NCHANS
      WRITE(ICVN,REC=INUMR1,ERR=10,IOSTAT=iostat)
     $            (WYN(I,irow,icol,irec),I=1,NPTS)
    1 INUMR1=INUMR1+1  
      RETURN
10    IERRCN=iostat
      WRITE(*,*)'Write error ',IERRCN
      RETURN      
      END
      
      SUBROUTINE GETDTF0(WYN,NPTS,NCHANS,KN,IWNMAX,IBTNUM,WHICH,
     $                   IR,IC,IK,IW,IB)
	INCLUDE 'MULTAR.INC'
C      REAL WYN(NPTS,NCHANS,NCHANS,KN)
      REAL WYN(*)
      COMMON /BOOTFIL/ ICVN,IRECCN,IRECL,IERRCN
C RECL=NPTS      
      LOGICAL WHICH(MKN+1)
      
      IF(IERRCN.NE.0)RETURN
      ikhl=NCHANS*NCHANS
      ibtl=ikhl*KN
      iwnl=ibtl*IBTNUM
      INUMR1=(IW-1)*iwnl+(IB-1)*ibtl+(IK-1)*ikhl+(IR-1)*NCHANS+IC
      READ(ICVN,REC=INUMR1,ERR=10,IOSTAT=iostat)(WYN(I),I=1,NPTS)
      RETURN
10    IERRCN=iostat
      WRITE(*,*)'Read error ',IERRCN
      RETURN      
      END

      
	SUBROUTINE INITSVBOT(INPFIL,NPTS,IWNSZ,IWNSHF,ITRMAX,NCHANS,IWNMAX)
	CHARACTER*(*) INPFIL
	CHARACTER*1024 FNAME
      COMMON /BOOTFIL/ ICVN,IRECCN,IRECL,IERRCN
      
      ICVN=77
!      IRECL=NPTS*NCHANS*NCHANS
      IRECL=NPTS
      FNAME='C:\EEGDATA\'//INPFIL(1:LEN_TRIM(INPFIL))//'.BOOTSTR.TMP'
      OPEN(UNIT=ICVN,STATUS='REPLACE',FORM='UNFORMATTED',
     $     ACCESS='DIRECT',RECL=IRECL,ERR=10,IOSTAT=iostat,
     $     FILE=FNAME)
      IERRCN=0
      RETURN
10    IERRCN=iostat
      WRITE(*,*)'File ',FNAME(1:LEN_TRIM(FNAME)),' open error ',IERRCN
      RETURN
	END
	
	SUBROUTINE CLOSESVBOT
      COMMON /BOOTFIL/ ICVN,IRECCN,IRECL,IERRCN
      
C      CLOSE(UNIT=ICVN)
      CLOSE(UNIT=ICVN,STATUS='DELETE')
	END
       
      
      SUBROUTINE RNDLIST(LIST,IPLSZ,ITRMX)
      DIMENSION LIST(IPLSZ)
!      REAL CRAN[ALLOCATABLE](:)
      
!      ALLOCATE(CRAN(IPLSZ),STAT=IERR)
      ST=FLOAT(ITRMX)
!      CALL RANDOM_NUMBER(CRAN)
      DO 1,I=1,IPLSZ
!1     LIST(I)= FLOOR(CRAN(I)*ST)+1
C      CALL RANDOM_NUMBER(CRAN)          ! USE FORTRAN INTERNAL RNG
C      CALL RNUN(1,CRAN)                 ! USE IMSL RNG
      CRAN=RNUNF()                       ! USE IMSL RNG
!1     LIST(I)= FLOOR(CRAN(I)*ST)+1
1     LIST(I)= FLOOR(CRAN*ST)+1
!      DEALLOCATE(CRAN)
      END

      SUBROUTINE FINDPRCTILE(PRVL,LPRVL,
     $                       NPTS,NCHANS,KN,WHICH,
     $                       IWIN,ITRLN,IWNMAX,IBTNUM,INPFIL)
	INCLUDE 'MULTAR.INC'
      DIMENSION PRVL(LPRVL)
      REAL AWYN(NPTS,NCHANS,NCHANS,KN)
      REAL WYN(:),OBS(:),Q(:),XLO(:),XHI(:)
      ALLOCATABLE WYN,OBS,Q,XLO,XHI
	CHARACTER*(*) INPFIL
      LOGICAL WHICH(MKN+1)
      COMMON /BOOTFIL/ ICVN,IRECCN,IRECL,IERRCN
      DOUBLE PRECISION ONE,DIVID
      DATA ONE /1D0/, IEDEN /1/
      
      NX=NPTS*NCHANS*NCHANS
      NXKN=NX*KN
      ALLOCATE(WYN(NPTS),STAT=ierr)
      ALLOCATE(OBS(IBTNUM),STAT=ierr)
      ALLOCATE(Q(LPRVL),STAT=ierr)
      ALLOCATE(XLO(LPRVL),STAT=ierr)
      ALLOCATE(XHI(LPRVL),STAT=ierr)

C      CALL INITPRCF(INPFIL,NPTS,NCHANS,IWNMAX,LPRVL)
C      Do 1,IW=1,IWNMAX
      Do 1,IK=1,KN
      DO 1,IR=1,NCHANS
      Do 1,IC=1,NCHANS
      Do 2,IP=1,NPTS
      Do 3,IB=1,IBTNUM
      CALL GETDTF0(WYN,NPTS,NCHANS,KN,IWNMAX,IBTNUM,WHICH,
     $             IR,IC,IK,IWIN,IB)
3     OBS(IB)=WYN(IP)
      CALL EQTIL(IBTNUM,OBS,LPRVL,PRVL,Q,XLO,XHI,NMISS)
2     CALL sqSAVPRC(Q,LPRVL)
1     CONTINUE

      CONTINUE

C      CALL CLOSEPRCF
      DEALLOCATE(XHI)
      DEALLOCATE(XLO)
      DEALLOCATE(Q)
      DEALLOCATE(OBS)
      DEALLOCATE(WYN)
      RETURN
      
      END


	SUBROUTINE INITPRCF(INPFIL,NPTS,NCHANS,IWNMAX,LPRVL)
	CHARACTER*(*) INPFIL
      COMMON /PRCFFIL/ ICVN,IRECCN,IRECL,IERRCN
      CHARACTER*1024 FNAME
      
      ICVN=76
      IRECL=LPRVL
      FNAME='C:\EEGDATA\'//INPFIL(1:LEN_TRIM(INPFIL))//'.PRCNTLS.TMP'
      OPEN(UNIT=ICVN,STATUS='REPLACE',FORM='UNFORMATTED',
     $     ACCESS='DIRECT',RECL=IRECL,ERR=10,IOSTAT=iostat,
     $     FILE=FNAME)
      IERRCN=0
      IRECCN=1
      RETURN
10    IERRCN=iostat
      WRITE(*,*)'File ',FNAME(1:LEN_TRIM(FNAME)),' open error ',IERRCN
      RETURN
	END
	
	SUBROUTINE CLOSEPRCF
      COMMON /PRCFFIL/ ICVN,IRECCN,IRECL,IERRCN
      
C      CLOSE(UNIT=ICVN)
      CLOSE(UNIT=ICVN,STATUS='DELETE')
	END


      SUBROUTINE sqSAVPRC(Q,LPRVL)
      COMMON /PRCFFIL/ ICVN,IRECCN,IRECL,IERRCN
      DIMENSION Q(LPRVL)

      IF(IERRCN.NE.0)RETURN
      WRITE(ICVN,REC=IRECCN,ERR=10)Q
      IRECCN=IRECCN+1
      RETURN
10    IERRCN=1
      RETURN
      END      
      
      SUBROUTINE REWPRCF
      COMMON /PRCFFIL/ ICVN,IRECCN,IRECL,IERRCN
      IRECCN=1
      REWIND(UNIT=ICVN,IOSTAT=IOSTAT)
      RETURN
      END
      
	SUBROUTINE GETPRCTILE(SWYN,NPTS,NCHANS,IWNMAX,Q,LPRVL,ILEV,IKN,KN,IWIN)
      DIMENSION SWYN(NPTS,NCHANS,NCHANS,IWNMAX,2)
      DIMENSION Q(LPRVL)
      COMMON /PRCFFIL/ ICVN,IRECCN,IRECL,IERRCN
      
      ILENK=NPTS*NCHANS*NCHANS
      ILENW=ILENK*KN
      IFRC=(IWIN-1)*ILENW+(IKN-1)*ILENK+1
      DO 1,ICHN=1,NCHANS
      DO 1,JCHN=1,NCHANS
      DO 1,INPT=1,NPTS
      READ(UNIT=ICVN,REC=IFRC,ERR=10,IOSTAT=iostat)Q
      IFRC=IFRC+1
1     SWYN(INPT,ICHN,JCHN,IWIN,1)=Q(ILEV)
      RETURN
10    IERR=1
      RETURN
      END      
      
      SUBROUTINE INITBO(VAL)
	COMMON /BOTWRIT/ IUNIT,IREC
      COMMON /BUFSIZ/ IO
      CHARACTER*1024 FNAME
	CHARACTER*64 INFIL,OUTFIL
	COMMON/STDFIL/INFIL,OUTFIL

      IUNIT=208
      WRITE(FNAME,100)VAL
      IF(FNAME(2:2).EQ.' ')FNAME(2:2)='0'
      FNAME='C:\EEGDATA\'//OUTFIL(1:LEN_TRIM(OUTFIL))//
     $ FNAME(1:LEN_TRIM(FNAME))//'.BOOTST.DAT'
      OPEN(UNIT=IUNIT,STATUS='REPLACE',FORM='UNFORMATTED',
     $     ACCESS='DIRECT',RECL=1,ERR=10,IOSTAT=iostat,
     $     FILE=FNAME)
      IREC=1
      RETURN
10    IERRCN=iostat
      WRITE(*,*)'File ',FNAME(1:LEN_TRIM(FNAME)),' open error ',IERRCN
      RETURN
100   FORMAT(1H.,F06.3)    
	END

      SUBROUTINE BOWRITL(IBUF,ILEN)
	INTEGER*4 IBUF(*)
	COMMON /BOTWRIT/ IUNIT,IREC
	DO 1,I=1,ILEN
	WRITE(IUNIT,REC=IREC)IBUF(I)
1     IREC=IREC+1      
	END
      
      SUBROUTINE BOWRIT(IBUF)
	INTEGER*4 IBUF(*)
	COMMON /BOTWRIT/ IUNIT,IREC
      COMMON /BUFSIZ/ IO
	DO 1,I=1,IO-1
	WRITE(IUNIT,REC=IREC)IBUF(I)
1     IREC=IREC+1      
	END

      SUBROUTINE CLSEBO
	COMMON /BOTWRIT/ IUNIT,IREC
      CLOSE(UNIT=IUNIT)
      RETURN
      END      
      
      