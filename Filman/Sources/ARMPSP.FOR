C ARMPSP.FOR- FIRST ROUTINE TO GET ARMA SPECTRA USING MARPLE'S ARMA

C ALGORITHM FOR COEFFICIENTS, AND FFT TO COMPUTE SPECTRUM. 

	SUBROUTINE ARMPSP(X,N,IC)

	COMMON IFLAG1

	COMMON/FLDES/ID(8),IBUF(1)

c	COMMON/FLDESO/IDO(8),WORK(1)
	COMMON/FLDESO/IDO(8),WORK      !  Maciek

	COMMON/DEV/ITI,ILP

	COMMON/PTLST/NLIST,LIST(2,72),NP1,NP2,NPTOT,P1,PT,DT,DF

	DIMENSION WK1(2050),WK2(2050),A(99),B(99)

	DIMENSION X(N,IC),SPECTRA[ALLOCATABLE](:,:)

	CHARACTER*24 PTITLE

	EQUIVALENCE (WK1(1),WORK(1)),(WK2(1),WORK(2051))
	
	dimension work(2051)     ! Maciek

1000    CALL PTSEL

1       WRITE(ITI,100)

100     FORMAT('$  ARMPSP: #AR COFS, #MA COFS, #CORREL LAGS? >'\)

	IKP=1

	READ(ITI,*)IP,IQ,M

C PLOT PARAMETERS

	FNYQ=FLOAT(ID(8))/2.

	DT=1.0/FLOAT(ID(8))

2       WRITE(ITI,300)FNYQ

300     FORMAT('$  FREQUENCY CUTOFF(.LE.',F5.1,') >'\)

	READ(ITI,301)FMAX

301     FORMAT(F8.0)

	IF(FMAX.EQ.0.)FMAX=FNYQ

3       WRITE(ITI,200)

200     FORMAT('$  ARMPSP FFT SIZE:1=256/2=512/3=1024/4=2048 >'\)

	READ(ITI,201)K

201     FORMAT(I1)

	IF(K.LT.1 .OR. K.GT.4)GO TO 3

	NXFM=2**(K+7)

	AN=NXFM/2

	DF=FNYQ/AN      ! PARAMETERS FOR PLOT1-

	NPT0=FMAX/DF+1   ! INITIAL VALUES

	NPT=NPT0

	N1=1

	N2=NPT

	X1=0.

	IKP=0

	NXEQ=0

	WRITE(ITI,199)

199     FORMAT('$  RECALL PREVIOUS PLOT? >'\)

	READ(ITI,401)IA

	IF(IA.EQ.'Y')IKP=1

	ALLOCATE(SPECTRA(NPT,IC),STAT=IERR)

	ISETF=0

C CALCULATE ALL CHANNEL SPECTRA THEN PLOT

	DO 50 L=1,IC

C FIRST COPY INPUT DATA TO WORK

	J=1

	DO 10 I=NP1,NP2

	WORK(J)=X(I,L)

10      J=J+1

	CALL DETRND(WORK,NPTOT,2)

	CALL TIMER(T1)

	CALL ARMA(NPTOT,IP,IQ,M,WK1,WK2,PM,A,B,ISTAT)

	IF(ISTAT.EQ.0)GO TO 15

	WRITE(ITI,202)L,ISTAT

202     FORMAT('   ! NUM. PROBS CHAN',I3,'; ISTAT=',I2,'; NO SPECTRUM')

	GO TO 50

15      CALL TIMER(T2)

	T2=(T2-T1)*1000.

	WRITE(ITI,102)L,T2

102     FORMAT(/'   CHANNEL',I3/'   TIME FOR COEFFS IS',F8.1, ' MS.')

	AN=N

	AM=M+1

	FPE=PM*(AN+AM)/(AN-AM)

	IF(PM.LT.1.0)PM=1.0

	AIC=AN*ALOG(PM)+2.0*(AM-1.0)

C FPE AND AIC ARE AKAIKE'S ORDER-SELECTION CRITERIA

	WRITE(ITI,103)PM,FPE,AIC

103     FORMAT('    PM=',F10.2,'; FPE=',F8.2,'; AIC=',F8.2)

	WRITE(ITI,1041)

1041    FORMAT('    AR COEFFICIENTS:')

	WRITE(ITI,104)(A(I),I=1,IP)

104     FORMAT('     ',10F7.3)

	WRITE(ITI,1042)

1042    FORMAT('    MA COEFFICIENTS:')

	WRITE(ITI,104)(B(I),I=1,IQ)

	CALL TIMER(T1)

C CALCULATE SPECTRUM VIA FFT'S OF COEFFICIENTS

C FIRST, AR PART (DENOMINATOR)

	WORK(1)=1.0

	DO 20 I=1,IP

20      WORK(I+1)=A(I)

	DO 25 I=IP+2,NXFM

25      WORK(I)=0.

	CALL FAST(WORK,NXFM)

C NEXT, MA PART (NUMERATOR)

	WK2(1)=1.0

	DO 26 I=1,IQ

26      WK2(I+1)=B(I)

	DO 27 I=IQ+2,NXFM

27      WK2(I)=0.

	CALL FAST(WK2,NXFM)

C NOW EVALUATE SPECTRUM POINT BY POINT AS NEEDED

	J=1

	FACT=PM*DT

	DO 30 I=1,NPT0

	SPECTRA(I,L)=FACT*(WK2(J)**2+WK2(J+1)**2)/(WK1(J)**2+WK1(J+1)**2)

	J=J+2

30      CONTINUE

	CALL TIMER(T2)

	T2=(T2-T1)*1000.

	WRITE(ITI,400)T2

400     FORMAT('$  TIME TO SPECTRUM IS',F8.2,'MS; <CR> TO PROCEED'\)

	READ(ITI,401)

401     FORMAT(A1)

50    CONTINUE

	WRITE(PTITLE,800)IP,IQ,M

800     FORMAT('ARMA: P=',I2,',Q=',I2,',LAGS=',I3)

	 CALL SPECPLOT(SPECTRA,NPT,IC,N1,N2,1,IC,2,PTITLE,IKP,NXEQ,0,0,0)

90      CONTINUE

95      WRITE(ITI,203)

203     FORMAT('$  ARMPSP NEXT:0=RET/1=NEW FREQS/2=MODEL/3=POINTS >'\)

	READ(ITI,204)IGO

204     FORMAT(I1)

	GO TO (99,2,1,1000) IGO+1

99    DEALLOCATE(SPECTRA)  

	RETURN

	END



