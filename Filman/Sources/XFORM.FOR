C XFORM.FOR CHANNEL-BY-CHANNEL FFT OF INPUT TIME SERIES AND 

C  TRUNCATION OF OUTPUT SERIES OF COMPLEX COEFFICIENTS.

      SUBROUTINE XFORM

      INCLUDE 'MAX.INC'

      CHARACTER*1 ANS

	DIMENSION WORK(32770)   ! MAX LENGTH FOR IEEE FFTSUBS, + 2

	COMMON IFLAG1,IFLAG2,IFLAG3,KNT,ISZ,ICHAN(ICHMAX)

	COMMON/FLDESO/ NGO,NAO,NCO,NDO,NFO,NLO,NRO,ISO,IBUFO(IOMAX)

	COMMON/FLDES/ NG,NA,NC,ND,NF,NL,NR,IS,IBUF(IOMAX)

	INTEGER*4, SAVE :: J0,NP,NP2,NID

	EQUIVALENCE (WORK,IBUFO(121))

      EQUIVALENCE (X,IX)
      COMMON /CPN/ CURPROCNAME
      CHARACTER*10 CURPROCNAME

	IF(IFLAG1) 10,20,50

10	NFO=4  !COMPLEX
      CURPROCNAME='XFORM'

C MOVE CHANNEL LABELS

	J=6*NGO+109

	DO 12 I=1,NCO

	L=J+5

	K=6*(NG+ICHAN(I))-5

	DO 5 I1=J,L

	IBUFO(I1)=IBUF(K)

5	K=K+1

12	J=J+6

C TRUNCATE LENGTH OF INPUT SERIES TO NEXT SMALLER POWER OF 2 IF NECESSARY

	NP=2

42	I=NP+NP

	IF(I-NDO) 43,43,44

43	NP=I

	GO TO 42

44	NP2=NP/2

	ISZ=NP+2

	NID=NGO+NAO

	J0=121-NID

      CALL DoXFORMDialog(NP2)

!	WRITE(*,102)
!
!102	FORMAT('TRUNCATE OUTPUT SERIES? >'\)
!
!	READ(*,101)ANS
!
!101   FORMAT(A1)
!
!	IF(ANS.NE.'y' .AND. ANS.NE.'Y') GO TO 16
!
!	WRITE(*,103)
!
!C FORCE OUTPUT TO START WITH DC POINT (JAN, '79)
!
!103	FORMAT('NUMBER OF COMPLEX OUTPUT POINTS? >'\)
!
!	READ(*,104)NP2
!
!104	FORMAT(1XI4)

16	NDO=NP2+1

C POINTERS TO FIRST WORD OF ID DATA IN THE 2 OUTPUT RECORDS

	RETURN

! MOVE DATA POINTS INTO BUFFER FOR TRANSFORMATION

20	DO 27 I=1,NP

27    CALL XVAL(I,WORK(I),XI)

	CALL FAST(WORK,NP)

	J2=J0

	DO 35 K=1,NID

	IBUFO(J2)=IBUFO(K)

35	J2=J2+1

	CALL PUTSTD(IBUFO(J0))

50	RETURN

	END

                                                                                          