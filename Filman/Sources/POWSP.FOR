C POWSP.FOR- CHANNEL-BY-CHANNEL FFT WITH TRUNCATION AND SMOOTHING;
C NEW VERSION USING 'FAST', 10/91; MINOR BUGS CORRECTED 6/92
C AUTOMATIC REMOVAL OF MEAN AND TREND ADDED 3/95

	SUBROUTINE POWSP

      INCLUDE 'MAX.INC'
	DIMENSION WORK(32770)   ! MAX LENGTH FOR IEEE FFTSUBS, + 2
	COMMON IFLAG1,IFLAG2,IFLAG3,KNT,ISZ,ICHAN(ICHMAX)
	COMMON/DEV/ITI
	COMMON/FLDESO/ NGO,NAO,NCO,NDO,NFO,NLO,NRO,ISO,IBUFO(IOMAX)
	COMMON/FLDES/ NG,NA,NC,ND,NF,NL,NR,IS,IBUF(IOMAX)
	EQUIVALENCE (WORK,IBUFO(121))
	INTEGER*4, SAVE :: NXFM, IT, NID, J1
	REAL*8, SAVE :: SC, SC2
	
      COMMON /CPN/ CURPROCNAME
      CHARACTER*10 CURPROCNAME

	IF(IFLAG1) 10,20,50

10    NFO=3
      CURPROCNAME='POWSP'
	J=6*NGO+109
	DO 12 I=1,NCO !COPY CHANNEL LABELS TO OUTPUT BUFFER
	L=J+5
	K=6*(NG+ICHAN(I))-5
	DO 5 I1=J,L
	IBUFO(I1)=IBUF(K)
5     K=K+1
12    J=J+6

C PAD INPUT SERIES TO NEXT POWER OF 2 IF NECESSARY

	NXFM=NDO ! NDO contains number of input points selected
	NP=2
42    NP=2*NP
	IF(NP-NXFM) 42,44,44
44    NXFM=NP
	ISZ=120 + NXFM + 2
	NID=NGO+NAO
	J1=121-NID  ! FIRST WORD OF OUTPUT RECORD
	FNYQ=FLOAT(IS)/2.0
	
      CALL DoPOWSPDialog(IT,FMAX,FNYQ) !IT = 1 for Hann tapering

	IT=IT+1
	DF=FLOAT(IS)/FLOAT(NXFM)
	IF(FMAX.EQ.0.0 .OR. FMAX.GT.FNYQ) FMAX=FNYQ
	NDO=FMAX/DF + 1
	ISO=FMAX  ! NEEDED FOR NEW PLOT ROUTINE
	SC = 2.0/FLOAT(NXFM)
	SC2 = SC/2.0
	RETURN

C RUNNING SECTION- FIRST COPY INPUT TO WORK AREA

20    DO 25 L=1,NXFM
25	CALL XVAL(L,WORK(L),XI)

C ALWAYS REMOVE MEAN AND TREND

	CALL DETRND(WORK,NXFM,2)
	CALL FAST(WORK,NXFM)
	J=3
	DO 30 I=2,NDO-1
	WORK(I)=(WORK(J)*SC)**2 + (WORK(J+1)*SC)**2
30    J=J+2
      !now fix DC and Nyquist f
      WORK(1)=(WORK(1)*SC2)**2 !DC is real only
      WORK(NDO)=(WORK(2*NDO-1)*SC2)**2 !Nyquist, real only
	GOTO (40,31),IT
31    TMP=WORK(1)
	DO 35 I=2,NDO-1
	TMP1=WORK(I)
	WORK(I)=.5*WORK(I) + .25*(TMP + WORK(I+1))
35    TMP=TMP1

C COPY DOWN THE GV VALUES AND ANC & WRITE RECORD

40    J=J1
	DO 45 I=1,NID
	IBUFO(J)=IBUFO(I)
45    J=J+1
	CALL PUTSTD(IBUFO(J1))
50    RETURN
	END

																			                                                                                                                                                                                                                                                                