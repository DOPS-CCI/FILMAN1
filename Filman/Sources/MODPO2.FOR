! MODPO2.FOR- CHANNEL-BY-CHANNEL AUTOREGRESSIVE MODELING OF DATA

!  USING MARPLE'S MODIFIED COVARIANCE ALGORITHM; SELECTED DATA RECORD

! IS SEGMENTED ARBITRARILY INTO 2 PARTS; A MODEL OF THE FIRST PART IS 

! CONSTRUCTED AND USED TO FILTER THE SECOND PART, AND THE FILTERED DATA

! (RESIDUALS) ARE EITHER OUTPUT OR SUBJECTED TO ADDITIONAL MODELING.

! THE AR MODEL ORDERS FOR EACH SEGMENT CAN BE DETERMINED

!  AUTOMATICALLY OR FIXED IN ADVANCE, & SPECTRA ARE COMPUTED VIA FFT AT 

!  USER-SPECIFIED RESOLUTION. AUTOMATIC DETRENDING ADDED 3/95.

	SUBROUTINE MODPO2

	DIMENSION IX(2),WORK(32770),COF(101)

	COMMON IFLAG1,IFLAG2,IFLAG3,KNT,ISZ,ICHAN(1)

	COMMON/DEV/ITI

	COMMON/PTLST/NLIST,LIST(2,72)

!	COMMON/FLDESO/ NGO,NAO,NCO,NDO,NFO,NLO,NRO,ISO,IBUFO(1)

	COMMON/FLDESO/ NGO,NAO,NCO,NDO,NFO,NLO,NRO,ISO,IBUFO(121)

	COMMON/FLDES/ NG,NA,NC,ND,NF,NL,NR,IS,IBUF(1)

	EQUIVALENCE (X,IX(1)),(IX(1),IX1),(IX(2),IX2),(WORK,IBUFO(121))
	
	character*255 aline
	save n1,n2,ip1,ip2,iout,nxfm,dt,npt,io1,nid
      COMMON /CPN/ CURPROCNAME
      CHARACTER*10 CURPROCNAME

! EQUIVALENCE ALLOWS 120 WORDS FOR NGO+NAO; WE DON'T CHECK

	IF(IFLAG1) 1,20,95

1     NFO=3
      CURPROCNAME='MODPO2'
      WRITE(*,*) CURPROCNAME
! MOVE CHANNEL LABELS

	J=6*NGO+109

	DO 2 I=1,NCO

	L=J+5

	K=6*(NG+ICHAN(I))-5

	DO 4 I1=J,L

	IBUFO(I1)=IBUF(K)

4     K=K+1

2     J=J+6

	NID=NGO+NAO

	ISZ=120+NDO

	IO1=121-NID  ! FIRST WORD OF OUTPUT RECORD IN IBUFO

	DT=1.0/FLOAT(IS)

! INPUT RECORD SEGMENT POINTERS AND LENGTHS

	NP1=LIST(1,1)

	T1=(NP1-1)*DT

	NP3=NP1+NDO-1

	T3=NP3*DT
	
      FNYQ=FLOAT(IS)/2.
      CALL DoMODPO2Dialog(T1,T3,T2,IORD1,IP1,IOUT,IORD2,IP2,FMAX,FNYQ,K)

!	WRITE(ITI,99)T1,T3
!
!99    FORMAT('$START =',F6.2,' SEC., STOP =',F6.2,'; BOUNDARY? >'\)
!
!	READ(ITI,*)T2

	NP2=T2*FLOAT(IS)

	N1=NP2-NP1+1   ! #'S OF POINTS IN THE SEGMENTS

	N2=NP3-NP2

!	WRITE(ITI,100)
!
!100   FORMAT('$ORDER SELECTION FOR SEGMENT 1: 1=FIXED/2=AIC/3=YTC>'\)
!
!	READ(ITI,*)IORD1

	GO TO (5,6,6)IORD1

5     CONTINUE
!      WRITE(ITI,101)
!
!101   FORMAT('$  ORDER(.LE.100)? >'\)
!
!	READ(ITI,*)IP1

	GO TO 7

6     IP1=100   ! QUICK FIX FOR AUTO ORDER SELECTION

7     CONTINUE
!      WRITE(ITI,102)
!
!102   FORMAT('$OUTPUT:1=FILTERED DATA/2=SPECTRA >'\)
!
!	READ(ITI,*)IOUT

	GO TO(10,12)IOUT

! FILTERED DATA OUTPUT

10    NDO=N2

	ISO=IS

	RETURN

! SPECTRA OUTPUT

12    CONTINUE
!      WRITE(ITI,103)
!
!103   FORMAT('$ORDER SELECTION FOR SEGMENT 2:1=FIXED/2=AIC/3=YTC >'\)
!
!	READ(ITI,*)IORD2

	GO TO (8,9,9)IORD2

8     CONTINUE
!      WRITE(ITI,101)
!
!	READ(ITI,*)IP2

	GO TO 13

9     IP2=100

13    FNYQ=FLOAT(IS)/2.

!	WRITE(ITI,300)FNYQ
!
!300   FORMAT('$  INTEGER FREQUENCY CUTOFF(.LE.',F6.0,') >'\)
!
!	READ(ITI,301)FMAX
!
!301   FORMAT(F8.0)

	IF(FMAX.EQ.0.)FMAX=FNYQ

	ISO=FMAX

3     CONTINUE
!      WRITE(ITI,200)
!
!200   FORMAT('$  MODPSP FFT SIZE:1=512/2=1024/3=2048/4=4096/5=8192 >'\)
!
!	READ(ITI,*)K

	IF(K.LT.1 .OR. K.GT.5)GO TO 3

	NXFM=2**(K+8)

	AN=NXFM/2

	DF=FNYQ/AN      

	NPT=FMAX/DF+1   

	NDO=NPT

	RETURN

! RUNNING SECTION- FIRST COPY INPUT DATA FOR SEGMENT 1 TO WORK AREA

20    DO 25 I=1,N1

	CALL XVAL(I,XV,XI)

25    WORK(I)=XV

	CALL DETRND(WORK,N1,2)

! GET AR COEFFICIENTS USING MARPLE'S MODCOVAR ROUTINE

	IP=IP1

	CALL MODCOV(N1,IP,WORK,PM,COF,ISTAT,IORD1)

	IF(ISTAT.EQ.0)GO TO 29

!	WRITE(ITI,202)KNT
!
!202   FORMAT(' ! UNSTABLE AT RECSET ',I4)
202   FORMAT(' ! UNSTABLE AT RECSET ',I4,', CHANNEL',I4)
1101  write(ALINE,202)KNT,ICHAN(IBUFO(1))
      !Call ShowInfoText('Error',ALINE)
      WRITE(*,*)ALINE
      
      DO 1201,I=JO1,JO1+NID-1
      IBUFO(I)=0
1201  CONTINUE
      GOTO 4001

!	KNT=-1
!
!	CALL PUTEND
!
!	RETURN

! COPY LAST IP DATA VALUES INTO WORK, USING THE RAW DATA TO AVOID

! POSSIBLE DISCONTINUITY AT SEGMENT BOUNDARY

29    J=N1-IP+1

	DO 30 I=1,IP

	CALL XVAL(J,XV,XI)

	WORK(I)=XV

30    J=J+1                       

! ADD SEGMENT 2 RAW DATA

	J=IP+1

	DO 40 I=N1+1,N1+N2

	CALL XVAL(I,XV,XI)

	WORK(J)=XV

40    J=J+1

! DETREND THE AUGMENTED RECORD

	CALL DETRND(WORK,N2+IP,2)

! APPLY FILTER

	DO 50 I=1,N2

	J=I+IP

	SUM=WORK(J)  ! ORIGINAL VALUE

	DO 45 K=1,IP

45    SUM=SUM+COF(K)*WORK(J-K)

50    WORK(I)=SUM  ! FILTERED VALUE

	GO TO (80,51)IOUT

! FOR SPECTRA, CALL MODCOVAR AGAIN

51    IP=IP2

	CALL MODCOV(N2,IP,WORK,PM,COF,ISTAT,IORD2)

! CALCULATE SPECTRUM VIA FFT OF COEFFICIENTS

	WORK(1)=1.0

	DO 60 I=1,IP

60    WORK(I+1)=COF(I)

	DO 65 I=IP+2,NXFM

65    WORK(I)=0.

	CALL FAST(WORK,NXFM)

	J=1

	FACT=PM*DT

	DO 70 I=1,NPT

	WORK(I)=FACT/(WORK(J)**2+WORK(J+1)**2)
	IF(WORK(I).LE.0.0)GOTO 1101 ! SOLUTION NUMERICALLY UNRELIABLE

70    J=J+2

! COPY ID INFO AHEAD OF WORK & WRITE OUTPUT RECORD

80    J=IO1

	DO 90 I=1,NID

	IBUFO(J)=IBUFO(I)

90    J=J+1

4001	CALL PUTSTD(IBUFO(IO1))

95    RETURN

	END





